---
created: 2025-08-30
updated: 2025-09-03T18:20
tags:
  - NextJS_Link
  - FE
share: "true"
issue: 134
title: NextJS Slow navigation between pages
description: NextJS Slow navigation between pages
---

## æµç¨‹

æ¯æ¬¡è·³è½¬éƒ½ä¼šå‘ä¸€ä¸ª ?rsc=hash
1. è¿›è¡ŒæœåŠ¡ç«¯ç»„ä»¶çš„æ‰§è¡Œ
2. æµå¼çš„ä¼ è¾“ RSC data
3. é‡åˆ°å®¢æˆ·ç«¯ç»„ä»¶ä¼šè§¦å‘ JS èµ„æºçš„ä¸‹è½½
4. æœ€ç»ˆé¡µé¢æ¸²æŸ“

## é—®é¢˜

1. é¢„åŠ è½½å¤±æ•ˆï¼Ÿä¸Šè¿°æ­¥éª¤åªæœ‰ JS èµ„æºèƒ½è¢«ç¼“å­˜
2. rsc ï¼ˆclient route cacheï¼‰é»˜è®¤ä¸ä¼šç¼“å­˜ï¼Œéœ€è¦é…ç½® staleTimeï¼ˆé vercel æ˜¯å¦ç”Ÿæ•ˆï¼Ÿï¼‰
    - å³ä½¿ç”Ÿæ•ˆï¼Œç¼“å­˜æ—¶é—´é—®é¢˜ï¼Ÿæ¯”å¦‚ç™»é™†çŠ¶æ€å˜åŒ–åç¼“å­˜äº†ä¹‹å‰çš„çŠ¶æ€ï¼Ÿ

## æ ¸å¿ƒ

å¼‚æ­¥åŠ è½½ï¼ˆæœåŠ¡ç«¯æ‰§è¡Œï¼‰çœŸå®å­˜åœ¨ï¼Œç­‰å¾…æ—¶é—´ä¸å¯é¿å…ï¼ˆå¼±ç½‘ã€VPN èŠ‚ç‚¹ç­‰ï¼‰
- vercel edge render å¯ä»¥ç¼“è§£

web æ—¶ä»£ï¼Œç­‰å¾…æ˜¯å¯ä»¥æ¥å—çš„ï¼Œé‡ç‚¹æ˜¯è¦ç«‹å³æä¾›è§†è§‰åé¦ˆ

## æ–¹æ¡ˆ

- Suspendï¼šåŒ…è£¹ä¸€ä¸ª loading æå‰è¿”å›
    - é—®é¢˜ï¼š
        - æ¯ä¸ªé¡µé¢éƒ½è¦åŠ 
        - è¿˜æ˜¯è¦ç»è¿‡ rsc çš„è¿‡ç¨‹ï¼Œå¦‚æœ rsc æœ¬èº«å¾ˆæ…¢ï¼ˆå¼±ç½‘ï¼‰ï¼Œloading å¯èƒ½éƒ½æ— æ³•è¿”å›
- loading.js
    - é—®é¢˜ï¼šåŒä¸Šï¼Œloading.js æœ¬è´¨å°±æ˜¯è‡ªåŠ¨åŒ…äº† Suspend
- ç›´æ¥é€šè¿‡ <a /> æ¥è·³è½¬ï¼Œä½¿ç”¨æµè§ˆå™¨çš„åŠ è½½æ•ˆæœ
    - ï¼Ÿ
- å®¢æˆ·ç«¯å³æ—¶æ¸²æŸ“
    - onNavigate+useLinkStatus+useOptimistic
    - éœ€è¦å°è£…ä¸€ä¸‹ Link ç»„ä»¶

## é¢„åŠ è½½æµ‹è¯•

```tsx
// home
<Link href="/api">API</Link>

// api
export default async function Page() {
	await sleep(3000)
	return <div>API Page</div>
}
```

ç»“æœç¬¦åˆé¢„æœŸï¼š
- å¼€å‘ç¯å¢ƒéœ€è¦ç­‰ 3s
- ç”Ÿäº§ç¯å¢ƒé¢„åŠ è½½ & ç¼“å­˜ï¼Œå¯ä»¥ç§’è¿›

è°ƒæ•´ä»£ç åŠ å…¥ `cookies()`

```tsx
// api
export default async function Page() {
	await sleep(3000)
	const cookie = await cookies()
	return <div>API Page</div>
}
```

ç¬¦åˆç›®å‰çº¿ä¸Šçš„æƒ…å†µï¼š
- ç”Ÿäº§ç¯å¢ƒä¹Ÿéœ€è¦ç­‰ 3s æ‰èƒ½è¿›å…¥é¡µé¢
	- å¦‚æœå­˜åœ¨ loading.ts æˆ–è€… Suspendï¼Œå¯ä»¥ç§’çœ‹åˆ° loading ä¸­çš„å†…å®¹

å…·ä½“åŸå› è§ï¼š[Getting Started: Partial Prerendering \| Next.js](https://nextjs.org/docs/app/getting-started/partial-prerendering#dynamic-rendering)

ç®€å•è¯´ï¼šä¸€æ—¦ä½¿ç”¨äº†åŠ¨æ€çš„ APIï¼Œæ•´ä¸ªæ¸²æŸ“å°±ä¼šå˜æˆåŠ¨æ€æ¸²æŸ“ï¼Œè¿™ç§æƒ…å†µä¸‹åªä¼šé¢„åŠ è½½ `loading.js`ï¼Œå¦‚æœæ²¡æœ‰ `loading.js` å°±ä¼šç­‰å¾…æ•´ä¸ªé¡µé¢å®Œå…¨å“åº”ä¹‹åæ‰ä¼šè¿›å…¥é¡µé¢

![c9cb0f7c73629511f8c7578ee8ec6c4f2b3bb00503232380422b85c496f4a8cf2baaeaaf7ded9f3e78dfd684a2a458fc7411b6f602806ffa235545bbe90b00e0](https://raw.githubusercontent.com/lei4519/blog/main/notes/attachments/c9cb0f7c73629511f8c7578ee8ec6c4f2b3bb00503232380422b85c496f4a8cf2baaeaaf7ded9f3e78dfd684a2a458fc7411b6f602806ffa235545bbe90b00e0.png)

> [Guides: Prefetching \| Next.js](https://nextjs.org/docs/app/guides/prefetching#prefetching-static-vs-dynamic-routes)

---

å¯ä»¥é€šè¿‡æ˜¾ç¤ºé…ç½® `prefetch=true` æ¥å¼ºåˆ¶é¢„å–åŠ¨æ€æ¸²æŸ“é¡µé¢  
è¿™ä¸ªä¼šä½¿åŠ¨æ€é¡µé¢ä½¿ç”¨é™æ€é¡µé¢çš„ç¼“å­˜é…ç½®ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰  
<https://nextjs.org/docs/app/api-reference/config/next-config-js/staleTimes>

![9a7cbcbc901f5b35129b4b2f8b6bc625b84c1a882990c91a860e4056b91f2671c92e18044e524814bdc41385c478d59edebdb2a8427b71984844f2ba9e8bf9bb](https://raw.githubusercontent.com/lei4519/blog/main/notes/attachments/9a7cbcbc901f5b35129b4b2f8b6bc625b84c1a882990c91a860e4056b91f2671c92e18044e524814bdc41385c478d59edebdb2a8427b71984844f2ba9e8bf9bb.png)

## åŸå› 

ä¸€æ—¦åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­ä½¿ç”¨äº† [åŠ¨æ€ API](https://nextjs.org/docs/app/getting-started/partial-prerendering#dynamic-rendering)ï¼Œé¡µé¢å°±ä¼šå˜ä¸ºåŠ¨æ€æ¸²æŸ“

- æ­¤æ—¶é¢„åŠ è½½åªä¼šåŠ è½½ `loading.js` ([Guides: Prefetching](https://nextjs.org/docs/app/guides/prefetching#prefetching-static-vs-dynamic-routes))
    
- å¦‚æœæ²¡æœ‰ `loading.js` æˆ– `Suspend`ï¼Œé¡µé¢ä¼šè¢«é˜»å¡ç›´åˆ°æœåŠ¡ç«¯å®Œå…¨å“åº”æ‰ä¼šè·³è½¬

ä¸”ï¼Œé»˜è®¤åŠ¨æ€æ¸²æŸ“æ²¡æœ‰ä»»ä½•ç¼“å­˜ï¼Œå½“å†æ¬¡å•å‡»é“¾æ¥æ—¶ï¼Œä¾ç„¶ä¼šé‡å¤ä¸Šè¿°è¿‡ç¨‹

## [Caching In NextJS](https://nextjs.org/docs/app/guides/caching#full-route-cache)

![f1e3f2e6eda73b746142326724e0442878d48655a863df4750d86a05f8113aac7309618ab4165fdbeccd3f9d5b709ef424ca958cc2ea24cb5f1c08af53add730](https://raw.githubusercontent.com/lei4519/blog/main/notes/attachments/f1e3f2e6eda73b746142326724e0442878d48655a863df4750d86a05f8113aac7309618ab4165fdbeccd3f9d5b709ef424ca958cc2ea24cb5f1c08af53add730.png)

ä¸¤ç§ç¼“å­˜ï¼šå®¢æˆ·ç«¯ç¼“å­˜ & æœåŠ¡ç«¯ç¼“å­˜

- å®¢æˆ·ç«¯ï¼šæµè§ˆå™¨å†…å­˜ï¼ˆå•ç”¨æˆ·ï¼‰
    
- æœåŠ¡ç«¯ï¼šæœåŠ¡å™¨ï¼ˆå¤šç”¨æˆ·ï¼‰

ä¸¤ç§é¡µé¢ï¼šé™æ€é¡µé¢ & åŠ¨æ€é¡µé¢

- é™æ€ï¼šè·¯å¾„ä¸­æ²¡æœ‰åŠ¨æ€å‚æ•° `3d-models/[id]` & æ²¡æœ‰ä½¿ç”¨ [åŠ¨æ€ API](https://nextjs.org/docs/app/getting-started/partial-prerendering#dynamic-rendering)
    
- åŠ¨æ€ï¼š!é™æ€

é»˜è®¤ç¼“å­˜æƒ…å†µï¼š

|-|å®¢æˆ·ç«¯ç¼“å­˜|æœåŠ¡ç«¯ç¼“å­˜|é¢„åŠ è½½|
|---|---|---|---|
|é™æ€é¡µé¢|âœ…ï¼ˆ5minï¼‰|âœ…|âœ…|
|åŠ¨æ€é¡µé¢|âŒ|âŒ|âŒï¼ˆonly `loading.js`ï¼‰|

åŠ¨æ€é¡µé¢æœ€å¤šåªèƒ½åœ¨å®¢æˆ·ç«¯ä¸­è¿›è¡Œç¼“å­˜ï¼Œæ— æ³•åœ¨æœåŠ¡ç«¯ä¸­è¿›è¡Œç¼“å­˜

- è¿™æ˜¯åˆç†çš„ï¼Œä¸ç„¶ä¸€ä¸ªç”¨æˆ·ç™»å½•åï¼Œåé¢æ‰€æœ‰ç”¨æˆ·è®¿é—®çš„éƒ½æ˜¯è¿™ä¸ªç”¨æˆ·çš„é¡µé¢äº†

## è°ƒæ•´åŠ¨æ€é¡µé¢ç¼“å­˜çš„æ–¹æ³•

### ç¼“å­˜é…ç½®

> [next-config/staleTimes](https://nextjs.org/docs/app/api-reference/config/next-config-js/staleTimes)

é…ç½® **å®¢æˆ·ç«¯ç¼“å­˜ä¸­** åŠ¨æ€æ¸²æŸ“çš„ç¼“å­˜æ—¶é—´ `staleTime.dynamic`

- å¯ä»¥æ”¹å–„çŸ­æ—¶é—´å†…åå¤è®¿é—®é¡µé¢çš„é€Ÿåº¦
    
- ä½†å¹¶ä¸èƒ½æ”¹å–„é¦–æ¬¡ç‚¹å‡»æ—¶çš„åŠ è½½é€Ÿåº¦ï¼ˆæ²¡æœ‰é¢„åŠ è½½ï¼‰
    
- éœ€è¦è€ƒè™‘ç¼“å­˜é—®é¢˜ï¼Œæ¯”å¦‚ç”¨æˆ·é€€å‡ºï¼Ÿæ”¹åï¼Ÿ

### é¢„åŠ è½½

åœ¨ `Link` ä¸­æ˜¾ç¤ºé…ç½® `prefetch=true` æ¥å¼ºåˆ¶é¢„å–åŠ¨æ€æ¸²æŸ“é¡µé¢ï¼ˆv15.4.0 é»˜è®¤å€¼å˜æˆäº† autoï¼‰

è¿™åŒæ—¶ä¼šä½¿åŠ¨æ€é¡µé¢ä½¿ç”¨é™æ€é¡µé¢çš„ç¼“å­˜é…ç½®ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰

- å¯ä»¥åŒæ—¶è§£å†³é¦–æ¬¡ç‚¹å‡»å’Œå†æ¬¡ç‚¹å‡»çš„åŠ è½½é€Ÿåº¦
    
- åŒä¸Šï¼Œç¼“å­˜é—®é¢˜

### Loading

ç»™åŠ¨æ€é¡µé¢åŠ å…¥ `loading.js` æˆ– `Suspend`

- `loading.js` å¯ä»¥åœ¨ app ç›®å½•ä¸­åŠ ä¸€ä¸ªï¼Œæ‰€æœ‰åŠ¨æ€è·¯ç”±éƒ½å¯ä»¥å…±äº«
    
- ä½†éœ€è¦è®¾è®¡ä¸€ä¸‹æ ·å¼ï¼Œæˆ–è€…ä¸€ä¸ªå…¨å±€å±…ä¸­çš„ loadingï¼Ÿ

### å®¢æˆ·ç«¯çŠ¶æ€æ›´æ–°

å®¢æˆ·ç«¯æ¸²æŸ“åŠ è½½çŠ¶æ€

- å°è£…ä¸€ä¸‹ Link ç»„ä»¶ï¼šonNavigate+useLinkStatus+useOptimistic
    
- åœ¨é¡µé¢é¡¶éƒ¨å±•ç¤ºä¸€ä¸ªè¿›åº¦æ¡

## å®¢æˆ·ç«¯ç¼“å­˜çš„æ¸…ç†æ–¹æ³•

- æµè§ˆå™¨é¡µé¢åˆ·æ–°
    
    - `location.reload()` / `location.href = "/"`
        
- NextJS å®¢æˆ·ç«¯ API
    
    - [router.refresh](https://nextjs.org/docs/app/api-reference/functions/use-router)
        
- Server Action API
    
    - [`cookies.set`](https://nextjs.org/docs/app/api-reference/functions/cookies#setting-a-cookie) or [`cookies.delete`](https://nextjs.org/docs/app/api-reference/functions/cookies#deleting-cookies)
        
    - [`revalidatePath`](https://nextjs.org/docs/app/api-reference/functions/revalidatePath)

## è§£å†³æ–¹æ¡ˆ

1. å¯ä»¥æ— è„‘åŠ ä¸Šå®¢æˆ·ç«¯çŠ¶æ€æ›´æ–°åšå…œåº•
    
2. å¼ºåˆ¶å¼€å¯é¢„åŠ è½½ï¼Œä½†éœ€è¦æ³¨æ„ç¼“å­˜é—®é¢˜
    
3. é’ˆå¯¹ä¸åŒçš„é¡µé¢ï¼Œè‡ªè¡Œè®¾è®¡ loading.js
    
4. å¦‚æœæœ‰é€šç”¨çš„å…¨å±€ loading é¡µé¢ï¼Œä¹Ÿå¯ä»¥å…œåº•åŠ ä¸Š

---

åœ¨å¼±ç½‘ç¯å¢ƒä¸­ï¼ˆåœ°é“ä¹‹ç±»çš„ï¼‰ï¼Œç‚¹å‡»è·³è½¬é“¾æ¥åä¼šæœ‰æ˜æ˜¾çš„ç­‰å¾…æ—¶é—´ï¼Œåœ¨è¿™æœŸé—´é¡µé¢**æ²¡æœ‰ä»»ä½•å˜åŒ–**ï¼Œä¼šè®©äººå¾ˆç–‘æƒ‘

## ä¸€é˜¶æ®µï¼šæ·»åŠ è§†è§‰åé¦ˆ âœ…

å¯ä»¥ç»™é¡µé¢è·³è½¬åŠ ä¸Šä¸€ä¸ªè¿›åº¦æ¡å±•ç¤ºï¼Œç»™äºˆç”¨æˆ·å³ä½¿çš„è§†è§‰åé¦ˆï¼Œå¦‚ä¸‹æ‰€ç¤º

- ä½“éªŒä¼˜åŒ–ï¼šå¯¹äºå¿«é€Ÿå“åº”çš„é¡µé¢ï¼ˆ0.3s ä»¥å†…ï¼‰ä¸å±•ç¤ºè¿›åº¦æ¡

## äºŒé˜¶æ®µï¼šå¼€å¯åŠ¨æ€é¡µé¢çš„é¢„åŠ è½½ â³

æå‰ç¼“å­˜é¡µé¢èµ„æºï¼Œå¼±ç½‘ï¼ˆç”šè‡³æ–­ç½‘ï¼‰ä»ç„¶å¯ä»¥ç§’è·³

- é¢ä¸´ç¼“å­˜çŠ¶æ€çš„é—®é¢˜ï¼ˆåç«¯æ•°æ®å˜æ›´ã€ç™»å½•æ€å˜æ›´ç­‰ï¼‰ï¼Œéœ€è¦è¯¦ç»†éªŒè¯åå†å¼€å¯

---

ä»¥ä¸‹ä¸ºæŠ€æœ¯åŸå› åˆ†æ ğŸ‘‡ğŸ»

## åŸå› åˆ†æ

ä¸€æ—¦åœ¨æœåŠ¡ç«¯ç»„ä»¶ä¸­ä½¿ç”¨äº† [åŠ¨æ€ API](https://nextjs.org/docs/app/getting-started/partial-prerendering#dynamic-rendering)ï¼Œé¡µé¢å°±ä¼šå˜ä¸ºåŠ¨æ€æ¸²æŸ“

- æ­¤æ—¶é¢„åŠ è½½åªä¼šåŠ è½½ `loading.js` ([Guides: Prefetching](https://nextjs.org/docs/app/guides/prefetching#prefetching-static-vs-dynamic-routes))
    
- å¦‚æœæ²¡æœ‰ `loading.js` æˆ– `Suspend`ï¼Œé¡µé¢ä¼šè¢«é˜»å¡ç›´åˆ°æœåŠ¡ç«¯å®Œå…¨å“åº”æ‰ä¼šè·³è½¬

ä¸”ï¼Œé»˜è®¤åŠ¨æ€æ¸²æŸ“æ²¡æœ‰ä»»ä½•ç¼“å­˜ï¼Œå½“å†æ¬¡å•å‡»é“¾æ¥æ—¶ï¼Œä¾ç„¶ä¼šé‡å¤ä¸Šè¿°è¿‡ç¨‹

## [Caching In NextJS](https://nextjs.org/docs/app/guides/caching#full-route-cache)

![f1e3f2e6eda73b746142326724e0442878d48655a863df4750d86a05f8113aac7309618ab4165fdbeccd3f9d5b709ef424ca958cc2ea24cb5f1c08af53add730](https://raw.githubusercontent.com/lei4519/blog/main/notes/attachments/f1e3f2e6eda73b746142326724e0442878d48655a863df4750d86a05f8113aac7309618ab4165fdbeccd3f9d5b709ef424ca958cc2ea24cb5f1c08af53add730.png)

ä¸¤ç§ç¼“å­˜ï¼šå®¢æˆ·ç«¯ç¼“å­˜ & æœåŠ¡ç«¯ç¼“å­˜

- å®¢æˆ·ç«¯ï¼šæµè§ˆå™¨å†…å­˜ï¼ˆå•ç”¨æˆ·ï¼‰
    
- æœåŠ¡ç«¯ï¼šæœåŠ¡å™¨ï¼ˆå¤šç”¨æˆ·ï¼‰

ä¸¤ç§é¡µé¢ï¼šé™æ€é¡µé¢ & åŠ¨æ€é¡µé¢

- é™æ€ï¼šè·¯å¾„ä¸­æ²¡æœ‰åŠ¨æ€å‚æ•° `3d-models/[id]` & æ²¡æœ‰ä½¿ç”¨ [åŠ¨æ€ API](https://nextjs.org/docs/app/getting-started/partial-prerendering#dynamic-rendering)
    
- åŠ¨æ€ï¼š!é™æ€

é»˜è®¤ç¼“å­˜æƒ…å†µï¼š

|-|å®¢æˆ·ç«¯ç¼“å­˜|æœåŠ¡ç«¯ç¼“å­˜|é¢„åŠ è½½|
|---|---|---|---|
|é™æ€é¡µé¢|âœ…ï¼ˆ5minï¼‰|âœ…|âœ…|
|åŠ¨æ€é¡µé¢|âŒ|âŒ|âŒï¼ˆonly `loading.js`ï¼‰|

åŠ¨æ€é¡µé¢æœ€å¤šåªèƒ½åœ¨å®¢æˆ·ç«¯ä¸­è¿›è¡Œç¼“å­˜ï¼Œæ— æ³•åœ¨æœåŠ¡ç«¯ä¸­è¿›è¡Œç¼“å­˜

- è¿™æ˜¯åˆç†çš„ï¼Œä¸ç„¶ä¸€ä¸ªç”¨æˆ·ç™»å½•åï¼Œåé¢æ‰€æœ‰ç”¨æˆ·è®¿é—®çš„éƒ½æ˜¯è¿™ä¸ªç”¨æˆ·çš„é¡µé¢äº†

## è°ƒæ•´åŠ¨æ€é¡µé¢ç¼“å­˜çš„æ–¹æ³•

### ç¼“å­˜é…ç½®

> [next-config/staleTimes](https://nextjs.org/docs/app/api-reference/config/next-config-js/staleTimes)

é…ç½® **å®¢æˆ·ç«¯ç¼“å­˜ä¸­** åŠ¨æ€æ¸²æŸ“çš„ç¼“å­˜æ—¶é—´ `staleTime.dynamic`

- å¯ä»¥æ”¹å–„çŸ­æ—¶é—´å†…åå¤è®¿é—®é¡µé¢çš„é€Ÿåº¦
    
- ä½†å¹¶ä¸èƒ½æ”¹å–„é¦–æ¬¡ç‚¹å‡»æ—¶çš„åŠ è½½é€Ÿåº¦ï¼ˆæ²¡æœ‰é¢„åŠ è½½ï¼‰
    
- éœ€è¦è€ƒè™‘ç¼“å­˜é—®é¢˜ï¼Œæ¯”å¦‚ç”¨æˆ·é€€å‡ºï¼Ÿæ”¹åï¼Ÿ

### é¢„åŠ è½½

åœ¨ `Link` ä¸­æ˜¾ç¤ºé…ç½® `prefetch=true` æ¥å¼ºåˆ¶é¢„å–åŠ¨æ€æ¸²æŸ“é¡µé¢ï¼ˆv15.4.0 é»˜è®¤å€¼å˜æˆäº† autoï¼‰

è¿™åŒæ—¶ä¼šä½¿åŠ¨æ€é¡µé¢ä½¿ç”¨é™æ€é¡µé¢çš„ç¼“å­˜é…ç½®ï¼ˆé»˜è®¤ 5 åˆ†é’Ÿï¼‰

- å¯ä»¥åŒæ—¶è§£å†³é¦–æ¬¡ç‚¹å‡»å’Œå†æ¬¡ç‚¹å‡»çš„åŠ è½½é€Ÿåº¦
    
- åŒä¸Šï¼Œç¼“å­˜é—®é¢˜

### Loading

ç»™åŠ¨æ€é¡µé¢åŠ å…¥ `loading.js` æˆ– `Suspend`

- `loading.js` å¯ä»¥åœ¨ app ç›®å½•ä¸­åŠ ä¸€ä¸ªï¼Œæ‰€æœ‰åŠ¨æ€è·¯ç”±éƒ½å¯ä»¥å…±äº«
    
- ä½†éœ€è¦è®¾è®¡ä¸€ä¸‹æ ·å¼ï¼Œæˆ–è€…ä¸€ä¸ªå…¨å±€å±…ä¸­çš„ loadingï¼Ÿ

### å®¢æˆ·ç«¯çŠ¶æ€æ›´æ–°

å®¢æˆ·ç«¯æ¸²æŸ“åŠ è½½çŠ¶æ€
- å°è£…ä¸€ä¸‹ Link ç»„ä»¶ï¼šonNavigate+useLinkStatus+useOptimistic
- åœ¨é¡µé¢é¡¶éƒ¨å±•ç¤ºä¸€ä¸ªè¿›åº¦æ¡
- [react-transition-progress](https://github.com/vercel/react-transition-progress)
- [Next JS navigation feels slow? Make it snappy again](https://linh.nguyen.be/articles/snappy-navigation-nextjs-app-router/)
- [Global progress in nextjsâ€‹â€‹](https://buildui.com/posts/global-progress-in-nextjs)

## å®¢æˆ·ç«¯ç¼“å­˜çš„æ¸…ç†æ–¹æ³•

- æµè§ˆå™¨é¡µé¢åˆ·æ–°
    
    - `location.reload()` / `location.href = "/"`
        
- NextJS å®¢æˆ·ç«¯ API
    
    - [router.refresh](https://nextjs.org/docs/app/api-reference/functions/use-router)
        
- Server Action API
    
    - [`cookies.set`](https://nextjs.org/docs/app/api-reference/functions/cookies#setting-a-cookie) or [`cookies.delete`](https://nextjs.org/docs/app/api-reference/functions/cookies#deleting-cookies)
        
    - [`revalidatePath`](https://nextjs.org/docs/app/api-reference/functions/revalidatePath)

## åŠ¨æ€æ¸²æŸ“å¯èƒ½çš„ç¼“å­˜é—®é¢˜

### ç™»å½•çŠ¶æ€

ç›®å‰é€€å‡ºç™»å½•æ—¶ï¼Œä¼šæ‰§è¡Œ `location.href = "/"` åˆ·æ–°é¡µé¢ï¼Œè¿™ä¼šä½¿æµè§ˆå™¨ç¼“å­˜å¤±æ•ˆï¼Œæ‰€ä»¥ä¸ä¼šæœ‰é—®é¢˜

- ä»¥é˜²ä¸‡ä¸€ï¼ˆåç»­é‡æ„ä»£ç ï¼‰ï¼Œæœ€å¥½è¿˜æ˜¯åœ¨è¿™äº›åœ°æ–¹åŠ å…¥ `router.refresh()`

### åç«¯æ•°æ®

ä¸»è¦è€ƒè™‘æ•°æ®å˜æ›´åï¼ˆmutateï¼‰ï¼Œç¼“å­˜çš„æ—§æ•°æ®å±•ç¤ºé—®é¢˜ï¼ˆqueryï¼‰

#### CSR

æ¯æ¬¡éƒ½ä¼šåœ¨å®¢æˆ·ç«¯è¯·æ±‚æ•°æ®ï¼ŒåŠ¨æ€æ¸²æŸ“ç¼“å­˜ä¸ä¼šå¼•å…¥ä»»ä½•æ–°çš„é—®é¢˜ï¼ˆå› ä¸ºæ ¹æœ¬æ²¡æœ‰ç¼“å­˜ä»€ä¹ˆæœ‰æ„ä¹‰çš„ä¸œè¥¿ï¼‰

- æŠ›å¼€ NextJSï¼Œå•çº¯ä½¿ç”¨ RQ/SWC ä¹Ÿä¼šé¢ä¸´ç¼“å­˜é—®é¢˜ï¼Œå¸¸è§„åšæ³•æ˜¯åœ¨ **mutate ä¹‹åéƒ½ä¼šé‡æ–° refetch/revalidate** æ¥ä½¿ç¼“å­˜å¤±æ•ˆ

#### RQ/SWC SSR

```
export default async function PostPage() {
  const queryClient = new QueryClient()

  await queryClient.prefetchQuery({
    queryKey: ['posts'],
    queryFn: getPosts,
  })

  return (
    <HydrationBoundary state={dehydrate(queryClient)}>
      <Posts />
    </HydrationBoundary>
  )
}
```

æœåŠ¡å™¨ç»„ä»¶ä¸­çš„ `prefetch state` ä¼šæ”¾åˆ° RSC Payload ä¸­ï¼Œè¢«å®¢æˆ·ç«¯ç¼“å­˜

ä½† `prefetch state` åªæ˜¯ä½œä¸ºåˆå§‹åŒ–çš„å¡«å……æ•°æ®æ¥ä½¿ç”¨ï¼Œæœ€ç»ˆé¡µé¢æ¸²æŸ“è¿˜æ˜¯ä¼šä»¥ RQ/SWC ç¼“å­˜ä¸ºå‡†

æ‰€ä»¥åªè¦åšå¥½ CSR ä¸­çš„äº‹æƒ…ï¼ˆmutate ä¹‹åé‡æ–° refetch/revalidateï¼‰æ¥åˆ·æ–° RQ/SWCï¼ŒåŠ¨æ€æ¸²æŸ“ç¼“å­˜ä¹Ÿä¸ä¼šå¸¦æ¥æ–°çš„é—®é¢˜

> React Query æœ¬èº«ä¹Ÿæ¨èè¿™ç§ç”¨æ³•ï¼Œå°†åŠ¨æ€æ¸²æŸ“ç¼“å­˜è¶³å¤Ÿé•¿çš„æ—¶é—´é¿å…æœåŠ¡ç«¯æ¸²æŸ“ï¼Œä½¿ç”¨å®¢æˆ·ç«¯åŠ è½½æ¥å®Œæˆæ•°æ®æ›´æ–°
>
> [https://tanstack.com/query/latest/docs/framework/react/guides/ssr#tips-tricks-and-caveats](https://tanstack.com/query/latest/docs/framework/react/guides/ssr#tips-tricks-and-caveats)

#### RSC + Server Action

> ç›®å‰é¡¹ç›®ä¸­åº”è¯¥æ²¡æœ‰è¿™ç§ç”¨æ³•ï¼ˆåé¢åº”è¯¥ä¹Ÿä¸ä¼šè¿™ä¹ˆå»ç”¨
>
> è¿™ç§èŒƒå¼åƒæ˜¯ PHP/JSPï¼Œæ•°æ®åŠ è½½å’Œæ›´æ–°å…¨åœ¨æœåŠ¡ç«¯

```
// use server
export async function RSC() {
  const data = await getData()
  return <RCC data={data} />
}

// use client
function RCC() {
  return <button onClick={async () => mutateData()} />
}

// use server
// server action
export const mutateData = async () => {
  await sql.update()
  revalidatePath("/page")
}
```

åç«¯æ•°æ®ç¼“å­˜åœ¨ RSC Payload ä¸­ï¼Œéœ€è¦åœ¨æ•°æ®å˜æ›´å

1. é¦–é€‰åœ¨ Server Action ä¸­æ‰§è¡Œ [`revalidatePath`](https://nextjs.org/docs/app/api-reference/functions/revalidatePath)
    
2. åœ¨æµè§ˆå™¨ä¸­æ‰§è¡Œ `router.refresh()`ï¼Œä½†æ˜¯è¿™ä¼šä½¿æ‰€æœ‰å®¢æˆ·ç«¯ç¼“å­˜éƒ½å¤±æ•ˆ

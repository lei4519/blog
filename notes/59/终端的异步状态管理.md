---
tags:
  - React
  - FE
  - Explanation
aliases:
  - async state manage
share: "true"
issue: "59"
created: 2024-03-25T20:33
updated: 2024-05-12T12:36
---

æ ‡é¢˜ç»å†äº†ä¸‰æ¬¡å˜åŒ–

1. å‰ç«¯çš„æœåŠ¡ç«¯çŠ¶æ€ç®¡ç†
   - ä¸ä»…æ˜¯æœåŠ¡ç«¯çŠ¶æ€ï¼Ÿ
2. å‰ç«¯çš„**å¼‚æ­¥**çŠ¶æ€ç®¡ç†
   - ä¸ä»…æ˜¯å‰ç«¯ï¼Ÿ
3. **ç»ˆç«¯**çš„å¼‚æ­¥çŠ¶æ€ç®¡ç†
   - æˆ–è€…å¯ä»¥ç§°ä¸º `*UI`ï¼Ÿ

## TL;DR

å¼€å‘ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’çš„ç•Œé¢æˆ–å·¥å…·æ—¶ï¼Œé¢å¯¹å¼‚æ­¥çŠ¶æ€éœ€è¦ç­‰ã€æ…¢ã€æ•°æ®è¿‡æ—¶è¿™äº›ä¸å¯é¿å…çš„äº‹å®ä¸‹ï¼Œæ€ä¹ˆå°½å¯èƒ½çš„æé«˜ UX

å…·ä½“åˆ°å‰ç«¯

1. ä¸ºä»€ä¹ˆè¦ä½¿ç”¨å¼‚æ­¥çŠ¶æ€ç®¡ç†åº“ `TanStack Query/SWR/RTK Query`ï¼Œå®ƒä»¬ä¸åŒæ­¥çŠ¶æ€ç®¡ç† `redux/jotai/zustand` æœ‰ä»€ä¹ˆåŒºåˆ«
2. ä½¿ç”¨ `redux-thunk` å®ç°ä¸€ä¸ªå¼‚æ­¥çŠ¶æ€ç®¡ç†ï¼ˆReact Query APIï¼‰

> TanStack Queryï¼ˆFKA React Queryï¼‰

## å‰ç«¯ï¼Ÿç»ˆç«¯ï¼Ÿ

 [å¤§å‰ç«¯ï¼Ÿç»ˆç«¯ï¼ŸOmni-FrontEndï¼Ÿ](../66/%E5%A4%A7%E5%89%8D%E7%AB%AF%EF%BC%9F%E7%BB%88%E7%AB%AF%EF%BC%9FOmni-FrontEnd%EF%BC%9F.md)

## åŒæ­¥ã€å¼‚æ­¥

### åŒæ­¥ä»£ç 

ä»£ç ç«‹å³æ‰§è¡Œå¹¶å®Œæˆï¼Œä¸éœ€è¦ç­‰å¾…å…¶ä»–ä»»ä½•æ“ä½œ

```c
a = 0
printf(a)
a = 1
printf(a)
```

### å¼‚æ­¥ä»£ç 

éœ€è¦ **ç­‰å¾…** æŸäº›æ“ä½œçš„å®Œæˆï¼šé”ã€æ–‡ä»¶ã€ç½‘ç»œ IO ç­‰ç­‰

```c
read(fd, buffer, BUFFER_SIZE)
```

èšç„¦åˆ°å‰ç«¯æœ€å¸¸è§ã€å¸¸ç”¨çš„å°±æ˜¯ `fetch` -- ç½‘ç»œè¯·æ±‚ï¼Œæ‰€ä»¥å°±å‰ç«¯æ¥è¯´ **å¼‚æ­¥çŠ¶æ€ â‰ˆ æœåŠ¡ç«¯çŠ¶æ€**

> å½“ç„¶è¿˜æœ‰è¯¸å¦‚ `IndexedDB`ã€`Web Worker` ä»¥åŠå„ç§æˆæƒè¯·æ±‚ï¼ˆè“ç‰™ã€æ‘„åƒå¤´ã€åœ°ç†ä½ç½®ï¼‰ç­‰ç­‰ï¼Œæœ¬è´¨æ˜¯ä¸€æ ·çš„

åŒç†ï¼Œ**åŒæ­¥çŠ¶æ€ â‰ˆ å®¢æˆ·ç«¯çŠ¶æ€**

### å·®å¼‚

![åŒæ­¥ã€å¼‚æ­¥çŠ¶æ€çš„å·®å¼‚ç‚¹](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-09_23.45.27.png)

ä»å››ä¸ªæ–¹é¢å»çœ‹ï¼š

- å­˜å‚¨ä½ç½®
- è®¿é—®é€Ÿåº¦
- è®¿é—®/ä¿®æ”¹æƒ
- æœ‰æ•ˆæ€§

#### åŒæ­¥

![åŒæ­¥çŠ¶æ€çš„ç‰¹ç‚¹](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-09_23.46.22.png)

- å­˜å‚¨ä½ç½®ï¼šåœ¨å†…å­˜ä¸­ï¼ŒéæŒä¹…åŒ–
- è®¿é—®é€Ÿåº¦ï¼šå³æ—¶è®¿é—®ã€ä¿®æ”¹
- è®¿é—®/ä¿®æ”¹æƒï¼šç§æœ‰çš„ï¼Œå½“å‰çº¿ç¨‹å¯ä»¥è®¿é—®ã€ä¿®æ”¹
- æœ‰æ•ˆæ€§ï¼šä¿®æ”¹åå¯ä»¥ç¨³å®šåŒæ­¥æ›´æ–°è‡³æœ€æ–°çŠ¶æ€

#### å¼‚æ­¥

![å¼‚æ­¥çŠ¶æ€çš„ç‰¹ç‚¹](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-09_23.46.51.png)

- å­˜å‚¨ä½ç½®ï¼šåœ¨å¤–éƒ¨ï¼ˆè¿œç«¯ï¼Œeg: DBï¼‰ï¼Œå¤šæ•°æ˜¯æŒä¹…åŒ–
- è®¿é—®é€Ÿåº¦ï¼šæ…¢ã€æœ‰æ—¶å»¶ï¼Œå¼‚æ­¥è®¿é—®ã€ä¿®æ”¹
- è®¿é—®/ä¿®æ”¹æƒï¼šå…±äº«æ‰€æœ‰æƒï¼Œå¯èƒ½è¢«å…¶ä»–äººä¿®æ”¹
- æœ‰æ•ˆæ€§ï¼šæŒæœ‰çš„åªæ˜¯å¿«ç…§ï¼ŒçŠ¶æ€å¯èƒ½è¿‡æ—¶

#### ç»ˆç«¯çš„å¼‚æ­¥çŠ¶æ€

æ‰€æœ‰ç¨‹åºå‘˜éƒ½ä¼šå…³å¿ƒå¼‚æ­¥çš„å†™æ³•ï¼ˆ`async/await`ï¼‰å’Œç»„ç»‡ï¼ˆ`rxjs`ï¼‰ï¼Œä½†ä¹Ÿè®¸åªæœ‰ `end device` ä¼šï¼ˆå¿…é¡»ï¼‰å»å…³å¿ƒå¼‚æ­¥è€—æ—¶ã€çŠ¶æ€æ›´æ–°è¿™äº›äº‹æƒ…

![async-ux.excalidraw](../Excalidraw/async-ux.svg)

å› ä¸ºæˆ‘ä»¬å·²ç»æ˜¯é“¾è·¯çš„ç»ˆç‚¹äº†ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒï¼Œé‚£å°±åªèƒ½ç”¨æˆ·å»å…³å¿ƒï¼Œç”¨æˆ·ä¼šå»å…³å¿ƒå—ï¼Ÿï¼ˆâ‰ˆ ç”¨æˆ·æµå¤±ï¼‰

**å¼‚æ­¥ == ç­‰å¾… == æ…¢ == ä½“éªŒä¸å¥½**

æ ¸å¿ƒé—®é¢˜ï¼š**ç”¨æˆ·ä½“éªŒ**

ä¸»é¢˜ï¼š**åœ¨å¼‚æ­¥éœ€è¦ç­‰ã€æ…¢ã€æ•°æ®è¿‡æ—¶è¿™äº›ä¸å¯é¿å…çš„äº‹å®ä¸‹ï¼Œæ€ä¹ˆå°½å¯èƒ½çš„æé«˜ UX**

### å¼‚æ­¥çŠ¶æ€çš„æŒ‘æˆ˜

![å¼‚æ­¥çŠ¶æ€çš„æŒ‘æˆ˜](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-09_23.47.36.png)

è¦æƒ³æé«˜å¼‚æ­¥çš„ä½“éªŒï¼ˆUXã€DXï¼‰ï¼Œæˆ‘ä»¬å¤§æ¦‚è¦é¢å¯¹å¦‚ä¸‹æŒ‘æˆ˜ï¼š

- ç¼“å­˜ï¼ˆå¯èƒ½æ˜¯ç¼–ç¨‹ä¸­æœ€éš¾åšçš„äº‹æƒ…ï¼‰
- å†…å­˜ç®¡ç†å’Œåƒåœ¾æ”¶é›†
- å°½å¿«åæ˜ æ•°æ®æ›´æ–°
- è¯·æ±‚çŠ¶æ€ç®¡ç†
- ä¸¢å¼ƒ/å–æ¶ˆè¯·æ±‚
- å¤šç»„ä»¶è¯·æ±‚åˆå¹¶
- æ€§èƒ½ä¼˜åŒ–
- ç”¨æˆ·ä½“éªŒ
- ä¹è§‚æ›´æ–°
- æ¸²æŸ“ä¼˜åŒ–
- ...

## æœ¬åœ°ã€å…¨å±€

å¼€å§‹ä¹‹å‰æœ‰ä¸€ç‚¹è¦æ˜ç¡®

> [!TIP]  
> å¼‚æ­¥çŠ¶æ€åº”è¯¥æ˜¯æœ¬åœ°çš„è¿˜æ˜¯å…¨å±€çš„ï¼Ÿ

æ˜¯åº”è¯¥è¿™æ ·ï¼Ÿ

```js
const [state, setState] = useState()

useEffect(() => {
  fetch(API.list).then((data) => setState(data))
}, [])
```

è¿˜æ˜¯è¿™æ ·ï¼Ÿ

```js
const state = useSelector(listSelector)

useEffect(() => {
  dispatch(getList)
}, [])
```

### å‰ç«¯è§†è§’

å¬åˆ°è¿‡çš„å›ç­”ï¼š

> å¦‚æœè¿™ä¸ªçŠ¶æ€åªæœ‰ç»„ä»¶è‡ªå·±ç”¨çš„å°±æ”¾æœ¬åœ°ï¼Œå¦‚æœå¤§å®¶éƒ½ç”¨çš„å°±æ”¾å…¨å±€

è¿™ä¸ªå›ç­”æ˜¯ç»ä¸èµ·æ¨æ•²çš„ï¼Œäº§å“æ˜¯åœ¨ä¸æ–­è¿­ä»£çš„ï¼Œæˆ‘ä»¬çš„åˆ¤æ–­ä»…é™äºå½“ä¸‹è¿™ä¸ªæ—¶åˆ»è€Œå·²

V1: è‡ªå·± -- æ”¾åœ¨æœ¬åœ°

![å±€éƒ¨çŠ¶æ€](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-09_23.55.40.png)

V2: å…„å¼ŸèŠ‚ç‚¹ -- æå‡åˆ°çˆ¶çº§

![çŠ¶æ€å‘ä¸Šæå–](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-09_23.55.57.png)

V3ï¼šè·¨èŠ‚ç‚¹ -- æå‡åˆ°å…¨å±€ï¼ˆrootï¼‰

V4ï¼šéœ€æ±‚å…¨ç äº†ï¼Œå˜å› V1 ç‰ˆæœ¬äº† -- å†é™ä¸‹æ¥ï¼Ÿ

å•ä»å¼€å‘ç»´æŠ¤è§’åº¦æ¥çœ‹ï¼Œåº”è¯¥æ˜¯å…¨å±€çš„

![å…¨å±€çŠ¶æ€](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-09_23.56.15.png)

### éå‰ç«¯è§†è§’

è·³å‡ºå‰ç«¯è§†è§’äº‹æƒ…å°±æ›´ç®€å•äº†ï¼Œå› ä¸ºä¸Šé¢å·²ç»è¯´è¿‡å¼‚æ­¥çŠ¶æ€æ˜¯å…±äº«æ‰€æœ‰æƒçš„ï¼Œæˆ‘ä»¬æ‹¥æœ‰çš„åªæ˜¯æŸä¸ªæ—¶åˆ»çš„å¿«ç…§è€Œå·²

ä»ä¸€è‡´æ€§è§’åº¦çœ‹ï¼Œå¿«ç…§å¯ä»¥æ˜¯è¿‡æ—¶çš„ï¼Œä½†ä¸èƒ½æ˜¯å¤šç‰ˆæœ¬çš„

![state-sync](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-11_16.30.13.png)

> å¯ä»¥æ¥å—è¿™ä¸¤ä¸ªæ•°å­—æ˜¯ç›¸åŒä½†æ˜¯è¿‡æ—¶äº†ï¼Œä½†ä¸èƒ½æ¥å—ä¸¤ä¸ªæ•°å­—ä¸ä¸€æ ·

ä¹Ÿå°±æ˜¯è¯´åŒä¸€ä»½å¼‚æ­¥çŠ¶æ€ä¸ç®¡å¤šå°‘åœ°æ–¹åœ¨ç”¨ï¼Œéƒ½éœ€è¦ä¸€ç§æ–¹å¼ä½¿å…¶ä¿æŒä¸€è‡´ï¼Œç­”æ¡ˆå¾ˆæ˜æ˜¾ä¹Ÿæ˜¯**å…¨å±€çŠ¶æ€ç®¡ç†**

## å¼‚æ­¥çŠ¶æ€ç®¡ç†

> æ•°æ®è·å–å¾ˆç®€å•ï¼Œå¼‚æ­¥çŠ¶æ€ç®¡ç†ä¸æ˜¯

æ‰€ä»¥æ¥ä¸‹æ¥ä½¿ç”¨ `redux-thunk` æ¥å°è£…å®ç°å¼‚æ­¥çŠ¶æ€ç®¡ç†ï¼Œçœ‹ä¸‹ä¸ºä»€ä¹ˆè¯´å¼‚æ­¥çŠ¶æ€ä¼šæœ‰å¦‚ä¸Šçš„æŒ‘æˆ˜ï¼Œä»¥åŠå¦‚ä½•è§£å†³

### ç»“æ„å®šä¹‰

ä¸‹é¢åº”è¯¥æ˜¯ä½¿ç”¨ `redux-thunk` è¯·æ±‚å¼‚æ­¥æ•°æ®çš„æœ€ç®€ä»£ç ï¼Œæœ‰ä¸¤ç‚¹å€¼å¾—æ³¨æ„ï¼š

1. æŠŠæ‰€æœ‰çš„å¼‚æ­¥è¯·æ±‚æ•°æ®éƒ½æ”¾åœ¨ä¸€ä¸ªå‘½åç©ºé—´ä¸‹: `ASM`ï¼Œä¸å…¶ä»–åŒæ­¥çŠ¶æ€åŒºåˆ†å¼€
2. å‚æ•°ä¼ å…¥æ¯ä¸€ä¸ªå¼‚æ­¥æ•°æ®çš„å…·ä½“è¦å­˜çš„é”® `queryKey` å’Œå…·ä½“è¦æ‰§è¡Œçš„è¯·æ±‚å‡½æ•° `queryFn`
   - è¿™ç‚¹åŒºåˆ«äºç°æœ‰çš„ä½¿ç”¨æ–¹å¼ï¼Œç›®å‰å¤§å®¶åº”è¯¥æ˜¯æ¯ä¸ª `modal` å•ç‹¬å†™ä¸€éè¯·æ±‚é€»è¾‘ï¼Œkey éš `modal` çš„å®šä¹‰åœ¨å¯¹åº”çš„æ–‡ä»¶ä¸­

```ts
export const fetchAsyncState = (props) => (dispatch) => {
  const { queryKey, queryFn } = props

  return queryFn(props).then((data) =>
    dispatch({ ASM: { [queryKey]: { data } } })
  )
}
```

> [!TIP]  
> æœ¬æ–‡æ‰€æœ‰ä»£ç ç›®çš„å‡ä¸ºè¯´æ˜ä½œç”¨
>
> å®Œæ•´çš„ `dispatch` åº”è¯¥æ˜¯ `dispath({ type, payload })`ï¼Œä¸ºäº†ç®€åŒ–ä»£ç å°±éƒ½çœç•¥äº†

ä½¿ç”¨ä»£ç å¦‚ä¸‹

```ts
const dispatch = useDispatch()

const queryKey = "taskList"

useEffect(() => {
  dispatch(
    fetchAsyncState({
      queryKey,
      queryFn: () => fetch("/api/list").then((res) => res.json()),
    })
  )
}, [])

const { data } = useSelector((state) => state.ASM[queryKey])
```

ä¸Šé¢çš„ä»£ç è¿˜æ˜¯å¤ªå•°å—¦äº†ï¼Œå®é™…ä½¿ç”¨ä¸­åªæœ‰ `queryKey & queryFn` ä¼šå˜åŒ–ï¼Œå…¶ä»–éƒ½æ˜¯æ¨¡ç‰ˆä»£ç ï¼Œæ‰€ä»¥å†å°è£…ä¸€ä¸ª `useQuery`

```ts
export const useQuery = (props) => {
  const dispatch = useDispatch()

  useEffect(() => {
    dispatch(fetchAsyncState(props))
  }, [])

  return useSelector((state) => state.ASM[props.queryKey])
}
```

è¿™ä¸‹ç”¨èµ·æ¥èˆ’æœå¤šäº†

```ts
const { data } = useQuery({
  queryKey: "taskList",
  queryFn: () => fetch("/api/list").then((res) => res.json()),
})
```

å‡å¦‚ N ä¸ªç»„ä»¶éƒ½åœ¨ç”¨è¿™ä¸ªæ•°æ®ï¼Œæˆ‘ä»¬ä¸æƒ³ `queryKey` å’Œ `queryFn` åˆ†æ•£åœ¨å„ç»„ä»¶ä¸­ï¼Œä¸ºäº†ç»Ÿä¸€ç®¡ç†è¿˜éœ€è¦å†å°ä¸€å±‚ï¼ˆæ•°æ®å±‚ï¼‰ï¼Œæ¯”å¦‚æ”¾åœ¨ `service/*.ts`

```ts
export const useTaskList = () =>
  useQuery({
    queryKey: "taskList",
    queryFn: () => fetch("/api/list").then((res) => res.json()),
  })
```

æœ€ç»ˆç»„ä»¶é‡Œï¼ˆè§†å›¾å±‚ï¼‰ç›´æ¥è°ƒç”¨

```ts
const { data } = useTaskList()
```

è¿™ä¹Ÿæ˜¯æœ€ç»ˆçš„ä»£ç ç»“æ„ï¼Œåé¢ä¼šæŒç»­çš„ä¿®æ”¹ `useQuery` çš„å®ç°ï¼Œä½†ä¸šåŠ¡å±‚è¦åšçš„åªæœ‰æœ€åè¿™ä¸¤æ­¥

### è¯·æ±‚çŠ¶æ€ç®¡ç†

å¼‚æ­¥çŠ¶æ€éœ€è¦ç­‰ã€æ…¢æ˜¯ä¸å¯é¿å…çš„ï¼Œä½†äººæœºäº¤äº’éœ€è¦åŠæ—¶å“åº”ï¼Œæˆ‘ä»¬éœ€è¦ä»äº¤äº’ä¸Šå‘Šè¯‰ç”¨æˆ·ï¼šä½ çš„æ“ä½œæˆ‘å—ç†äº†ï¼Œåªæ˜¯ç°åœ¨éœ€è¦ç­‰å¾…

ä¹Ÿå°±æ˜¯**æ‰€æœ‰è§†å›¾ä¸­å‘ç”Ÿå¼‚æ­¥çŠ¶æ€çš„åœ°æ–¹ï¼Œè¦åœ¨è§†è§‰ä¸Šåé¦ˆç”¨æˆ·**

> [!NOTE]  
> æœ‰äº›æ—¶å€™è®¾è®¡æ˜¯ä¸ä¼šå‡º loading æ•ˆæœçš„ï¼Œä½†ä½œä¸ºå‰ç«¯ä¸€å®šè¦æå‡º/ç›´æ¥è‡ªå·±åŠ ä¸Šå»
>
> è¿™é‡Œå°±è¦å¤¸ä¸€å¤¸ antd äº†ï¼Œå®ƒå¯èƒ½æ˜¯å†…ç½® loading å±æ€§ç»„ä»¶æœ€å¤šçš„åº“äº†ï¼š`input/select/button/dropdown/table/modal/tree/card...`

ä½œä¸ºçŠ¶æ€ç®¡ç†è¦åšçš„äº‹æƒ…å°±æ˜¯æŠŠå¼‚æ­¥è¿‡ç¨‹çŠ¶æ€æš´éœ²å‡ºæ¥ï¼Œæ–¹ä¾¿è§†å›¾å±‚æ¸²æŸ“ï¼š`loading/error/success`

å›åˆ°ä»£ç å®ç°ï¼Œè¿™ä¸€æ­¥æ˜¯å¾ˆç®€å•çš„ï¼Œè€Œä¸”ç›¸ä¿¡å¤§å®¶è‡ªå·±ä¸€å®šä¹Ÿéƒ½å†™è¿‡ï¼šè¯·æ±‚è¿‡ç¨‹ä¸­ä½¿ç”¨ `status` è®°å½•çŠ¶æ€

```ts
export const fetchAsyncState = (props) => (dispatch) => {
  const { queryKey, queryFn } = props

  dispatch({ ASM: { [queryKey]: { status: "loading" } } })

  return queryFn(props)
    .then((data) =>
      dispatch({ ASM: { [queryKey]: { status: "success", data } } })
    )
    .catch((error) =>
      dispatch({ ASM: { [queryKey]: { status: "error", error } } })
    )
}
```

åœ¨ `useQuery` ä¸­æ´¾ç”Ÿå‡ºå…·ä½“çš„å˜é‡æ–¹ä¾¿å¤–éƒ¨ä½¿ç”¨ï¼š

```ts
export const useQuery = (props) => {
  // ...
  const state = useSelector((state) => state.ASM[props.queryKey])
  return {
    ...state,
    isLoading: state.status === "loading",
    isError: state.status === "error",
    isSuccess: state.status === "success",
  }
}
```

> [!TIP]  
> ä¸ºä»€ä¹ˆä¸ç›´æ¥åœ¨ `fetchAsyncState` å†™ `isLoading/isError/isSuccess` å‘¢ï¼Ÿ

ä¼šæœ‰å¾ˆå¤šé‡å¤çš„ä»£ç 

```ts
dispatch({
  ASM: { [queryKey]: { isLoading: true, isError: false, isSuccess: false } },
})

return queryFn(props)
  .then((data) =>
    dispatch({
      ASM: {
        [queryKey]: { isLoading: false, isError: false, isSuccess: true, data },
      },
    })
  )
  .catch((error) =>
    dispatch({
      ASM: {
        [queryKey]: {
          isLoading: false,
          isError: true,
          isSuccess: false,
          error,
        },
      },
    })
  )
```

### ç¼“å­˜ç®¡ç†

è¿™å¯èƒ½æ˜¯å¼‚æ­¥çŠ¶æ€ç®¡ç†ä¸åŒæ­¥çŠ¶æ€ç®¡ç†æœ€å¤§çš„å·®å¼‚ç‚¹äº†

> [!IMPORTANT]  
> è¦èŠç¼“å­˜ï¼Œå¿…é¡»å…ˆè¦æ˜ç¡® `queryKey` çš„å«ä¹‰ï¼Œè¿™å¾ˆé‡è¦

#### `queryKey: "taskList"` çš„é—®é¢˜

å¦‚æœå¤§å®¶åœ¨ç”¨åŒæ­¥çŠ¶æ€ç®¡ç†å¼‚æ­¥æ•°æ®ï¼Œè¿™åº”è¯¥å°±æ˜¯æ­£åœ¨ä½¿ç”¨çš„æ–¹å¼äº†ï¼Œæˆ‘ä»¬ç”¨**ä¸€ä¸ª `key` å»æ‰¿è½½ä¸€ä¸ªæ¥å£**è¿”å›çš„æ•°æ®

> [!TIP]  
> è¿™æœ‰ä»€ä¹ˆé—®é¢˜å—ï¼Œæœ‰é‡åˆ°è¿‡ BUG å—ï¼Ÿ

##### åˆ—è¡¨åœºæ™¯

![åˆ†é¡µç»„ä»¶](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-12_13.53.37.png)

> [!TIP]
>
> `/api/list?page=1` å’Œ `/api/list?page=2` å’Œ `/api/list?name=s`
>
> ç®—æ˜¯åŒä¸€ç§çŠ¶æ€å—ï¼Ÿ

`queryKey: "taskList"` æ˜¯å®ƒä»¬çš„å”¯ä¸€æ ‡è¯†å—ï¼Ÿ

1. `page=1` çš„æ•°æ®æ¸²æŸ“åœ¨äº†ç¬¬äºŒé¡µé‡Œï¼Œç®— BUG å—ï¼Ÿ
2. åŒæ—¶æ¸²æŸ“äº†ä¸¤ä¸ªè¡¨æ ¼ `type=1|2`ï¼Œå¯¹å…¶ä¸­ä¸€ä¸ªç¿»é¡µï¼Œç»“æœä¸¤ä¸ªåŒæ—¶è¿›è¡Œäº† `loading` å’Œç»“æœæ›´æ–°ï¼Œç®— BUG å—ï¼Ÿ
3. ...

![æ•°æ®ç«äº‰çš„ä¾‹å­](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/Pasted%20image%2020240415151749.png)

> æ•°æ®ç«äº‰ï¼šç½‘ç»œè¯·æ±‚æ˜¯æ²¡æœ‰æ—¶åºæ€§ä¿è¯çš„ï¼Œå…ˆå‘çš„è¯·æ±‚ä¸ä¸€å®šæ˜¯å…ˆå“åº”çš„ï¼‰

è¿™äº›é—®é¢˜å¤§å®¶å¤šå°‘åº”è¯¥éƒ½ç¢°åˆ°è¿‡ï¼Œè§£å†³æ–¹æ¡ˆä¹Ÿæœ‰å¾ˆå¤šï¼Œæ¯”å¦‚ï¼š

1. ä¸¢å¼ƒè¯·æ±‚
2. é˜»å¡ UI
3. æ‹† `key`
4. ...

##### æœ¬è´¨æ˜¯ä»€ä¹ˆï¼Ÿ

`/api/list?page=1` å’Œ `/api/list?page=2` å’Œ `/api/list?name=s` æ ¹æœ¬å°±ä¸æ˜¯åŒä¸€ç§çŠ¶æ€ï¼Œä½†åœ¨ä»£ç å¼€å‘ä¸Šå´ç”¨ä¸€ä¸ªå­—æ®µæ‰¿æ¥äº† `N` ç§ä¸åŒçš„æ•°æ®

æŠŠ `N` ç§çŠ¶æ€æŠ½è±¡æˆäº† `1` ç§ï¼ŒæŠ½è±¡çš„ä»£ä»·å°±æ˜¯ä¼šé‡åˆ°å„ç§é—®é¢˜

æ¢å¥è¯è¯´ï¼Œå¦‚æœä¸åšæŠ½è±¡ï¼Œå°±ä¸ä¼šæœ‰è¿™äº›é—®é¢˜

##### æ•°æ®ç¼“å­˜

è¿˜æ˜¯åˆ—è¡¨åœºæ™¯ï¼Œæ“ä½œè·¯å¾„ï¼š

- åˆ†é¡µï¼š`?page=1 -> ?page=2 -> ?page=1`ï¼ˆå¾€è¿”ç¿»é¡µï¼‰
- æœç´¢ï¼š`?page=1 -> ?page=1&s="React" -> ?page=1`ï¼ˆæœç´¢åæ¸…ç©ºï¼‰

> [!TIP]  
> Qï¼šé¢‘ç¹é‡å¤çš„è·å– `page=1` çš„æ•°æ®ï¼Œæ˜¯å¦æœ‰å¿…è¦ï¼Ÿ

å¯èƒ½çš„å›ç­”ï¼š

è¦çœ‹å…·ä½“åœºæ™¯ï¼Œçœ‹å¯¹æ•°æ®å®æ—¶æ€§çš„è¦æ±‚ï¼›è¿˜è¦çœ‹è¯·æ±‚æ•°æ®çš„ä»£ä»·ï¼ˆè¯·æ±‚è€—æ—¶ï¼‰

> [!TIP]  
> ä½†ä½¿ç”¨æŠ½è±¡ `key` çš„æ–¹å¼ï¼Œå…¶å®æ˜¯æ²¡æœ‰é€‰æ‹©çš„
>
> å› ä¸ºæ¯æ¬¡è¯·æ±‚æˆåŠŸåï¼Œä¹‹å‰çš„æ•°æ®å°±å·²ç»è¢«ä¸¢å¼ƒäº†ï¼Œä¸‹æ¬¡åªèƒ½é‡æ–°è¯·æ±‚è·å–æ•°æ®

##### SWR

è€Œä¸”é’ˆå¯¹è¿™ä¸ªé—®é¢˜è¿˜æœ‰æ›´å¥½çš„å›ç­”ï¼š`SWR: stale-while-revalidate`

> [!TIP]  
> è¿™é‡Œçš„ SWR æŒ‡çš„æ˜¯ [HTTP SWR](https://datatracker.ietf.org/doc/html/rfc5861) æ¦‚å¿µ
>
> åé¢æ‰€è¯´çš„ useSWR æŒ‡ [ç”¨äºæ•°æ®è¯·æ±‚çš„ React Hooks åº“ â€“ SWR](https://swr.vercel.app/zh-CN) çš„å…·ä½“å®ç°

`SWR` æ˜¯æŒ‡åœ¨è¯·æ±‚æ•°æ®æ—¶ï¼Œå¦‚æœä¹‹å‰å·²ç»æœ‰ç¼“å­˜äº†

1. ç¼“å­˜æ²¡æœ‰è¿‡æ—¶ï¼Œç›´æ¥è¿”å›ç¼“å­˜
2. ç¼“å­˜å·²ç»è¿‡æ—¶ï¼Œä»ç„¶è¿”å›ç¼“å­˜ï¼ŒåŒæ—¶åœ¨**åå°é‡æ–°è·å–æ•°æ®å¹¶æ›´æ–°ç¼“å­˜**

åŸåˆ™æ˜¯ã€Œæœ‰ã€æ€»æ¯”ã€Œç©ºã€å¼ºï¼ˆä½“éªŒå¥½ï¼‰ï¼Œå°±ç®—æ•°æ®æ˜¯è¿‡æ—¶çš„ï¼Œä¹Ÿæ¯”æ²¡æœ‰æ•°æ®å¼ºï¼ˆæ›´ä½•å†µä¼šåœ¨å‡ ç™¾æ¯«ç§’å†…ï¼ˆå¯èƒ½çš„ï¼‰æ–°æ•°æ®å°±ä¼šåˆ°æ¥

##### `key` ç»“è®º

æ‰€ä»¥ä¸ç®¡æ˜¯ä»ä»£ç å¼€å‘è€ƒè™‘ï¼Œè¿˜æ˜¯ä»æ•°æ®ç¼“å­˜è€ƒè™‘

éƒ½åº”è¯¥å…·è±¡ `queryKey`ï¼Œä¿è¯æ¯ä¸€ä¸ª `key` å¯¹åº”ä¸€ä»½æ•°æ®

å…·ä½“æ¥è¯´å°±æ˜¯å¯¹äº `get` è¯·æ±‚ï¼Œæˆ‘ä»¬åº”è¯¥æŠŠ `url + [query] + [body]` ä½œä¸º `queryKey`ï¼Œè¿™æ ·å°±å¯ä»¥æ ‡è¯†å”¯ä¸€çš„æ•°æ®æºäº†

```ts
const queryKey = ["/api/list", { page: 1, name: "s" } /* something... */]
```

#### å®ç° SWR

è§£å†³ `key` çš„é—®é¢˜

##### `key` åºåˆ—åŒ–

ç°åœ¨çš„ `key` å˜æˆäº†ä¸€ä¸ªéåŸºæœ¬ç±»å‹ï¼Œä¸èƒ½ç›´æ¥ç”¨ä½œå¯¹è±¡çš„ `key`ï¼Œæ‰€ä»¥éœ€è¦åºåˆ—åŒ–ï¼ˆ`stringify`ï¼‰æ“ä½œ

> ä¹Ÿä¸èƒ½ç”¨ Mapï¼Œå› ä¸ºæ¯æ¬¡ rerender å¼•ç”¨éƒ½ä¼šå˜

å¤šæ•°æƒ…å†µ `key` çš„ç»„æˆéƒ½æ˜¯ä¼ ç»™åç«¯çš„ï¼Œæ‰€ä»¥å¯ä»¥ç›´æ¥ç”¨ `JSON.stringify` æ¥åºåˆ—åŒ–ï¼ˆReact Queryï¼‰

```ts
/**
 * Hashes the value into a stable hash.
 */
export function hashKey(queryKey: QueryKey | MutationKey): string {
  return JSON.stringify(queryKey, (_, val) =>
    isPlainObject(val)
      ? Object.keys(val)
          .sort()
          .reduce((result, key) => ({ ...result, [key]: val[key] }), {} as any)
      : val
  )
}
```

é”®å€¼å¯¹çš„é¡ºåºä¸åŒï¼Œåºåˆ—åŒ–åçš„å­—ç¬¦ä¸²ä¹Ÿæ˜¯ä¸åŒçš„ï¼ˆä½†å«ä¹‰ç›¸åŒï¼‰ï¼Œæ‰€ä»¥éœ€è¦æ’åº

```ts
JSON.stringify({ a: 1, b: 1 })
// '{"a":1,"b":1}'
JSON.stringify({ b: 1, a: 1 })
// '{"b":1,"a":1}'
```

ä¹Ÿå¯ä»¥ç›´æ¥ä½¿ç”¨ `stable-hash` åº“ï¼ˆuseSWRï¼‰ï¼Œå®ƒå¯ä»¥ç¨³å®šåºåˆ—åŒ–ä»»æ„ç±»å‹çš„å€¼ï¼ˆ`Function/RegExp/BigInt/Symbol..`ï¼‰ï¼ŒåŒ…æ‹¬å¾ªç¯å¼•ç”¨ï¼ˆ`JSON.stringify` ä¼šç›´æ¥æŠ¥é”™ï¼‰

```ts
// https://github.com/shuding/stable-hash#readme
import hash from "stable-hash"

const foo = []
foo.push(foo)

hash({ a: { b: 2n, c: () => {}, d: [/1/g, Symbol(), foo] } })
// #a:#d:@/1/g,Symbol(),@4~,,,c:5~,b:2,,
```

åº”ç”¨åˆ°ä»£ç ä¸­å°±æ˜¯å­˜ `key` çš„æ—¶å€™è°ƒç”¨ä¸€ä¸‹ `hash` å‡½æ•°ï¼š

```ts
export const fetchAsyncState = (props) => (dispatch) => {
  // ...
  payload: { ASM: { [hash(queryKey)]: { /* */ } } },
  // ...
}
```

##### `key` å˜åŒ–æ—¶è¯·æ±‚æ•°æ®

åˆ©ç”¨ `useEffect` å¯ä»¥è½»æ˜“åšåˆ°ï¼ˆè®°å¾— `hash key`ï¼‰

```ts
export const useQuery = (props) => {
  // ...
  useEffect(() => {
    // ...
  }, [hash(props.queryKey)])
  // ...
}
```

`React Query/useSWR` éƒ½å»ºè®®ä½¿ç”¨è¿™ç§æ–¹å¼ç›‘å¬ `key` å˜åŒ–ä»¥é‡æ–°å‘èµ·è¯·æ±‚ï¼Œè€Œä¸æ˜¯æ‰‹åŠ¨è°ƒç”¨è¯·æ±‚å‡½æ•°

---

æœ‰äººå¸Œæœ› `useQuery` æä¾›ä¸€ä¸ªç±»ä¼¼ `manualFetch` çš„è¿”å›å€¼ï¼Œä»¥åœ¨äº‹ä»¶å‘ç”Ÿçš„æ—¶å€™æ‰‹åŠ¨ä¼ å…¥å‚æ•°è¿›è¡Œè¯·æ±‚ï¼š

```ts
// âŒ ç¤ºä¾‹ï¼šä¸å­˜åœ¨è¿™æ ·çš„ APIï¼Œä¹Ÿä¸å»ºè®®
const { manualFetch } = useQuery({
  key: {
    /**/
  },
})

const onPageChange = (page) => {
  manualFetch({ page })
}
```

å•ä»å°è£…çš„è§’åº¦æ˜¯ä¸èƒ½æä¾›æ‰‹åŠ¨å‡½æ•°çš„

- åé¢ä¼šè®²è‡ªåŠ¨ç¼“å­˜æ›´æ–°ï¼Œå¦‚æœä½¿ç”¨æ‰‹åŠ¨æŸ¥è¯¢æ›´æ”¹ `key`ï¼Œä¼šäº§ç”Ÿæ›´å¤šçš„å¿ƒæ™ºè´Ÿæ‹…

  1. `useQuery` é‡Œå·²ç»ä¼ å…¥äº†ä¸€ä¸ª `key`ï¼ˆå¤–éƒ¨çŠ¶æ€
  2. `manualFetch` ä¹Ÿä¼šä¼ å…¥ `key`ï¼ˆå†…éƒ¨çŠ¶æ€
  3. è¿™æ˜¯ä¸¤ä¸ªæ•°æ®æºï¼Œä¸”æœ‰ä¼˜å…ˆçº§ä¹‹åˆ†ï¼Œä¸”ä¼˜å…ˆçº§æ›´é«˜çš„ `manualFetch` æ•°æ®æºçš„çŠ¶æ€è¢«å°è£…åœ¨äº† `useQuery` å†…éƒ¨

###### å®˜ç½‘å»ºè®®æ‰‹åŠ¨è¯·æ±‚ï¼Ÿ

React å®˜ç½‘ [Sending a POST request - You Might Not Need an Effect](https://react.dev/learn/you-might-not-need-an-effect#sending-a-post-request) ä¸­:

> å½“æ‚¨é€‰æ‹©æ˜¯å¦å°†æŸäº›é€»è¾‘æ”¾å…¥äº‹ä»¶å¤„ç†ç¨‹åºæˆ– useEffect ä¸­æ—¶ï¼Œæ‚¨éœ€è¦å›ç­”çš„ä¸»è¦é—®é¢˜æ˜¯ä»ç”¨æˆ·çš„è§’åº¦æ¥çœ‹å®ƒæ˜¯ä»€ä¹ˆæ ·çš„é€»è¾‘
>
> - å¦‚æœæ­¤é€»è¾‘æ˜¯ç”±ç‰¹å®šäº¤äº’å¼•èµ·çš„ï¼Œè¯·å°†å…¶ä¿ç•™åœ¨äº‹ä»¶å¤„ç†ç¨‹åºä¸­
> - å¦‚æœæ˜¯ç”±äºç”¨æˆ·çœ‹åˆ°å±å¹•ä¸Šçš„ç»„ä»¶å¼•èµ·çš„ï¼Œè¯·å°†å…¶ä¿ç•™åœ¨ useEffect ä¸­

è®ºç‚¹ï¼šå°½å¯èƒ½è®©äº‹æƒ…å‘ç”Ÿåœ¨å®ƒäº§ç”Ÿçš„åœ°æ–¹

> å†…å­˜é‡æŒ‡é’ˆéš¾ä»¥æ’æŸ¥ï¼Œå› ä¸ºå®ƒä»¬å¾€å¾€æ˜¯ç”±ä¸€ç³»åˆ—å¤æ‚çš„äº¤äº’å’Œæ“ä½œå¼•èµ·çš„ï¼Œè€Œä¸”å‡ºç°é—®é¢˜çš„ç—‡çŠ¶å¯èƒ½ä¸ä¼šç«‹å³æ˜¾ç°ï¼Œæˆ–è€…ä¸åœ¨å¼•èµ·é—®é¢˜çš„å®é™…ä»£ç ä½ç½®å‡ºç°

ä½†å®é™…ä¸Šè¿™åªæ˜¯é’ˆå¯¹ `å˜æ›´` æ“ä½œï¼Œå¯¹äº `æŸ¥è¯¢` æ“ä½œå®˜æ–¹ç´§è·Ÿç€å°±ç»™å‡ºäº†è¯´æ³•ï¼š

[Fetching data - You Might Not Need an Effect](https://react.dev/learn/you-might-not-need-an-effect#fetching-data)

> æ‚¨ä¸éœ€è¦å°†æ­¤ è·å– ç§»è‡³äº‹ä»¶å¤„ç†ç¨‹åº
>
> è¿™å¯èƒ½çœ‹èµ·æ¥ä¸å‰é¢çš„ç¤ºä¾‹ç›¸çŸ›ç›¾ï¼Œåœ¨å‰é¢çš„ç¤ºä¾‹ä¸­æ‚¨éœ€è¦å°†é€»è¾‘æ”¾å…¥äº‹ä»¶å¤„ç†ç¨‹åºä¸­ï¼
>
> ä½†æ˜¯ï¼Œè¯·è€ƒè™‘åˆ° input äº‹ä»¶å¹¶ä¸æ˜¯è·å–æ•°æ®çš„ä¸»è¦åŸå› ï¼Œæœç´¢è¾“å…¥é€šå¸¸æ˜¯ä» URL é¢„å…ˆå¡«å……çš„ï¼Œç”¨æˆ·å¯ä»¥åœ¨ä¸è¾“å…¥çš„æƒ…å†µä¸‹å¯¼èˆªåé€€å’Œå‰è¿›ã€‚
>
> page å’Œ query æ¥è‡ªå“ªé‡Œå¹¶ä¸é‡è¦ã€‚è™½ç„¶æ­¤ç»„ä»¶å¯è§ï¼Œä½†æ‚¨å¸Œæœ›ä½¿ results ä¸å½“å‰ page å’Œ query çš„ç½‘ç»œæ•°æ®ä¿æŒåŒæ­¥ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆå®ƒæ˜¯ä¸€ä¸ª useEffect

1. `key` å¯èƒ½ä¸æ˜¯å•ä¸€æ¥æºï¼ˆ`url`ï¼‰
2. æŸ¥è¯¢æ“ä½œæ˜¯å¹‚ç­‰çš„ï¼Œå¯ä»¥å¹¶è¡Œã€é‡å¤å’Œå–æ¶ˆçš„ï¼Œåªè¦æœ€ç»ˆçš„æ•°æ®å’Œå‚æ•°ä¸€ä¸€å¯¹åº”å³å¯
3. å˜æ›´æ“ä½œç›¸åï¼Œéœ€è¦é˜»å¡ UI æ“ä½œ

è¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆ `React Query/useSWR` éƒ½ç»™æˆ‘ä»¬æä¾›äº†ç”¨ä»¥å˜æ›´çš„æ–¹æ³• `useMutation/useSWRMutation`ï¼Œä»¥ä½¿å¾—æŸ¥è¯¢å’Œå˜æ›´åˆ†å¼€

#### å®Œå–„ SWR

`key` çš„é—®é¢˜è§£å†³ä¹‹åï¼Œå…¶å®å·²ç»å®ç°äº† SWR çš„åŠŸèƒ½ï¼Œå›é¡¾ä¸‹ç›®å‰çš„ä»£ç 

```ts
export const fetchAsyncState = (props) => (dispatch) => {
  const { queryKey, queryFn } = props

  dispatch({ ASM: { [queryKey]: { status: "loading" } } })

  return queryFn(props)
    .then((data) =>
      dispatch({ ASM: { [queryKey]: { status: "success", data } } })
    )
    .catch((error) =>
      dispatch({ ASM: { [queryKey]: { status: "error", error } } })
    )
}

export const useQuery = (props) => {
  const hashKey = hash(props.queryKey)

  useEffect(() => {
    dispatch(fetchAsyncState({ ...props, queryKey: hashKey }))
  }, [hashKey])

  const state = useSelector((state) => state.ASM[hashKey])
  // ...
}
```

å†çœ‹åˆ†é¡µåœºæ™¯ï¼š`?page=1 -> ?page=2 -> ?page=1`

1. é¦–å…ˆï¼Œæ¯ä¸ª `key` éƒ½è¢«å•ç‹¬ä¿å­˜äº†ä¸€ä»½æ•°æ®
2. æˆ‘ä»¬å¹¶æ²¡æœ‰åšä»»ä½•æ¸…ç† `data` çš„åŠ¨ä½œï¼Œæ‰€ä»¥å¦‚æœ `data` ä¹‹å‰å·²ç»æœ‰å€¼äº†ï¼Œé‚£ä¹ˆ `useSelector` å¾ˆè‡ªç„¶çš„å°±ä¼šè·å–åˆ°å·²æœ‰çš„å€¼
3. åŒæ—¶æ–°çš„è¯·æ±‚ä¾ç„¶ä¼šè¢«å‘é€å‡ºå»ï¼Œç„¶åæ›´æ–° `data`

##### ç¼“å­˜æ—¶é•¿

å›é¡¾ä¸‹ `SWR` çš„å®šä¹‰ï¼š

> `SWR` æ˜¯æŒ‡åœ¨è¯·æ±‚æ•°æ®æ—¶ï¼Œå¦‚æœä¹‹å‰å·²ç»æœ‰ç¼“å­˜äº†
>
> 1. ç¼“å­˜æ²¡æœ‰è¿‡æ—¶ï¼Œç›´æ¥è¿”å›ç¼“å­˜
> 2. ç¼“å­˜å·²ç»è¿‡æ—¶ï¼Œä»ç„¶è¿”å›ç¼“å­˜ï¼ŒåŒæ—¶åœ¨**åå°é‡æ–°è·å–æ•°æ®å¹¶æ›´æ–°ç¼“å­˜**

ä½†ç›®å‰çš„ä»£ç é‡Œæ ¹æœ¬å°±æ²¡æœ‰è¿‡ä¸è¿‡æ—¶çš„æ¦‚å¿µï¼Œä¸ä¼šå‡ºç°ã€Œç¼“å­˜æ²¡æœ‰è¿‡æ—¶ã€çš„æƒ…å†µ

æˆ‘ä»¬å¯ä»¥åŠ å…¥ä¸€ä¸ª `staleTime` çš„é…ç½®ï¼Œæ¥æ§åˆ¶å¼‚æ­¥æ•°æ®çš„è¿‡æœŸæ—¶é—´ï¼Œå¦‚æœæ•°æ®è¿˜æ˜¯æ–°é²œçš„ï¼Œå°±ä¸ä¼šå‘èµ·è¯·æ±‚ï¼Œç›´æ¥è¿”å›ç¼“å­˜

> `staleTime`ï¼šæ•°æ®ä»æ–°é²œï¼ˆ`fresh`ï¼‰è½¬å˜ä¸ºé™ˆæ—§ï¼ˆ`stale`ï¼‰çš„æŒç»­æ—¶é—´
>
> åªè¦æŸ¥è¯¢æ˜¯æ–°é²œçš„ï¼Œæ•°æ®å°†å§‹ç»ˆåªä»ç¼“å­˜ä¸­è¯»å– - ä¸ä¼šå‘ç”Ÿç½‘ç»œè¯·æ±‚ï¼
>
> å¦‚æœæŸ¥è¯¢å·²è¿‡æ—¶ï¼ˆé»˜è®¤æƒ…å†µä¸‹æ˜¯ï¼š`0` ç«‹å³è¿‡æ—¶ï¼‰ï¼Œæ‚¨ä»å°†ä»ç¼“å­˜ä¸­è·å–æ•°æ®ï¼Œä½†åœ¨æŸäº›æ¡ä»¶ä¸‹å¯èƒ½ä¼šå‘ç”Ÿåå°é‡æ–°è·å–ï¼ˆå¦‚æœè¿‡æ—¶çš„æ—¶å€™å¹¶æ²¡æœ‰ä»»ä½•ä½¿ç”¨æ­¤æ•°æ®çš„ç»„ä»¶æŒ‚è½½ï¼Œåˆ™ä¸ä¼šå‘èµ·è¯·æ±‚ï¼‰
>
> -- React Query

ä»£ç ä¸­ï¼Œå½“æ•°æ®è¯·æ±‚æˆåŠŸåï¼Œè®°å½•ä¸€ä¸ªæ—¶é—´

```ts
export const fetchAsyncState = (props) => (dispatch) => {
  // ...
  dispatch({ ASM: { [queryKey]: { status: "success", data, dataUpdatedAt: Date.now() } } }),
  //...
};
```

è§¦å‘è¯·æ±‚æ—¶ï¼Œåˆ¤æ–­æ•°æ®æ˜¯å¦è¿‡æœŸ

```ts
export const useQuery = (props) => {
  // ...
  const staleTime = props.options?.staleTime || 0

  const state = useSelector((state) => state.ASM[hashKey])

  useEffect(() => {
    if (state.dataUpdatedAt + staleTime < Date.now()) return

    dispatch(fetchAsyncState({ ...props, queryKey: hashKey }))
  }, [hashKey])

  // ...
}
```

é»˜è®¤æƒ…å†µä¸‹ `staleTime` ä¸º `0`ï¼Œå³ç«‹å³è¿‡æ—¶

> ä»åº“çš„è®¾è®¡è§’åº¦ï¼Œ0 æ˜¯æœ€å®‰å…¨çš„  
> è®©ä½¿ç”¨è€…æ ¹æ®è‡ªå·±çš„åº”ç”¨åœºæ™¯å»æ€è€ƒå†³å®šæ•°æ®çš„æ–°é²œåº¦ã€‚å³ä½¿ä¸æ€è€ƒï¼Œç¨‹åºä¹Ÿä¸ä¼šå› æ­¤å‡ºé”™

å¦‚æœå¸Œæœ›æ•°æ®åœ¨ç¨‹åºçš„è¿è¡ŒæœŸé—´éƒ½ä¸è¿‡æœŸï¼Œå¯ä»¥è®¾ç½® `staleTime: Infinity`

> æ¯”å¦‚ç™»å½•ç”¨æˆ·çš„ä¿¡æ¯ï¼ˆ`/user`ã€`/me`...

###### `useSWR`

`useSWR` ä¸­å¹¶æ²¡æœ‰ `staleTime` çš„æ¦‚å¿µï¼Œåªæœ‰ `revalidateIfStale` & `dedupingInterval`

`revalidateIfStale = true`: å³ä½¿å­˜åœ¨é™ˆæ—§æ•°æ®ï¼Œä¹Ÿè‡ªåŠ¨é‡æ–°éªŒè¯

- `revalidateIfStale: true === staleTime: 0`
- `revalidateIfStale: false === staleTime: Infinity`

`dedupingInterval = 2000`: åˆ é™¤ä¸€æ®µæ—¶é—´å†…ç›¸åŒ `key` çš„é‡å¤è¯·æ±‚

- ä»è¡Œä¸ºä¸Šçœ‹ä¼¼ä¹ç±»ä¼¼äº `staleTime`

---

å…¶å® `HTTP SWR` ä¸­ä¹Ÿæ˜¯æœ‰ `staleTime` çš„æ¦‚å¿µçš„

```
Cache-Control: max-age=604800, stale-while-revalidate=86400
```

åé¢ä¼šè®²åˆ°è¯·æ±‚å»é‡ã€è‡ªåŠ¨æ›´æ–°å’Œæ‰‹åŠ¨ç¼“å­˜å¤±æ•ˆ

`staleTime` çš„æ¦‚å¿µå¯ä»¥è½»æ¾çš„ä¸è¿™äº›æ¦‚å¿µç»“åˆï¼Œæ²¡æœ‰ä»€ä¹ˆå¿ƒæ™ºè´Ÿæ‹…

- `staleTime = Infinity` çš„æƒ…å†µä¸‹ï¼Œæ‰‹åŠ¨ç¼“å­˜å¤±æ•ˆï¼Œä¼šé‡æ–°å‘èµ·è¯·æ±‚å—ï¼Ÿ

`revalidateIfStale` & `dedupingInterval` å°±ä¸æ˜¯è¿™æ ·äº†

- `dedupingInterval = Infinity` çš„æƒ…å†µä¸‹ï¼Œæ‰‹åŠ¨ç¼“å­˜å¤±æ•ˆï¼Œä¼šé‡æ–°å‘èµ·è¯·æ±‚å—ï¼Ÿ

> `dedupingInterval` é…ç½®çš„ä¸»è¦ä½œç”¨æ˜¯é˜²æ­¢åœ¨æŒ‡å®šæ—¶é—´é—´éš”å†…é‡å¤å‘é€ç›¸åŒçš„è¯·æ±‚ã€‚å®ƒä¸ä¼šå½±å“ä½¿ç”¨ `mutate` å‡½æ•°æ¥æ›´æ–°æ•°æ®æˆ–è€…è§¦å‘é‡æ–°è¯·æ±‚

### æ•°æ®æ›´æ–°

#### è‡ªåŠ¨æ›´æ–°ï¼ˆSmart refetchesï¼‰

æ‰€æœ‰çš„å¼‚æ­¥çŠ¶æ€ç®¡ç†éƒ½ä¼šæä¾›è¿™äº›èƒ½åŠ›ï¼Œä½¿ç”¨å¾—å½“å¯ä»¥è®©ç”¨æˆ·ä½“éªŒä¸Šå‡ä¸€ä¸ªå±‚çº§

> React Query é€‰æ‹©äº†ä¸€äº›è§¦å‘é‡æ–°è·å–çš„ç­–ç•¥ç‚¹
>
> è¿™äº›ç‚¹ä¼¼ä¹æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„æŒ‡æ ‡ï¼Œå¯ä»¥è¡¨è¾¾ï¼šã€Œæ˜¯çš„ï¼Œç°åœ¨æ˜¯è·å–ä¸€äº›æ•°æ®çš„å¥½æ—¶æœºã€

##### `refetchOnMount`

> æ¯å½“å®‰è£…è°ƒç”¨ `useQuery` çš„æ–°ç»„ä»¶æ—¶ï¼ŒReact Query éƒ½ä¼šè¿›è¡Œé‡æ–°éªŒè¯

ç›®å‰çš„å®ç°å°±æ˜¯è¿™æ ·

##### `refetchOnWindowFocus`

> æ¯å½“æ‚¨èšç„¦æµè§ˆå™¨é€‰é¡¹å¡æ—¶ï¼Œå°±ä¼šé‡æ–°è·å–
>
> è¿™æ˜¯æˆ‘æœ€å–œæ¬¢è¿›è¡Œé‡æ–°éªŒè¯çš„æ—¶é—´ç‚¹
>
> ä½†å®ƒç»å¸¸è¢«è¯¯è§£ï¼Œåœ¨å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ç»å¸¸åˆ‡æ¢æµè§ˆå™¨é€‰é¡¹å¡ï¼Œå› æ­¤æˆ‘ä»¬å¯èƒ½ä¼šè®¤ä¸ºè¿™ã€Œå¤ªå¤šã€
>
> ç„¶è€Œåœ¨ç”Ÿäº§ä¸­ï¼Œå®ƒå¾ˆå¯èƒ½è¡¨æ˜åœ¨é€‰é¡¹å¡ä¸­æ‰“å¼€æˆ‘ä»¬çš„åº”ç”¨ç¨‹åºçš„ç”¨æˆ·ç°åœ¨ä»æ£€æŸ¥é‚®ä»¶æˆ–é˜…è¯» Twitter å›æ¥
>
> åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå‘ä»–ä»¬å±•ç¤ºæœ€æ–°çš„æ›´æ–°æ˜¯éå¸¸æœ‰æ„ä¹‰çš„

åŠŸèƒ½çš„ä»£ç å®ç°å°±æ˜¯ç›‘å¬ ~~focus~~ `visibilitychange` é‡æ–°å‘èµ·è¯·æ±‚

> [stop listening for focus events](https://github.com/TanStack/query/pull/4805)

ç›®å‰åªä¼šåœ¨ `queryKey` å˜åŒ–æ—¶ï¼Œæ‰ä¼šé‡æ–°å‘èµ·è¯·æ±‚ï¼Œç°åœ¨æˆ‘ä»¬éœ€è¦åŠ å…¥å¦ä¸€ä¸ªçŠ¶æ€: `isInvalidated`ï¼Œ`true` è¡¨ç¤ºéœ€è¦é‡æ–°è¯·æ±‚

> ä¸ºä»€ä¹ˆè¦é€šè¿‡åŠ ä¸€ä¸ªçŠ¶æ€æ¥å®ç°å‘¢ï¼Ÿæ‰‹åŠ¨æ›´æ–°ä¸­ä¼šçœ‹åˆ°å®ƒçš„å·§å¦™ä¹‹å¤„

```ts
export const useQuery = (props) => {
  // ...
  const state = useSelector((state) => state.ASM[hashKey]);

  useEffect(() => {
    const fn = () => visible && dispatch({ ASM: { [hashKey]: { /**/, isInvalidated: true } } })

    window.addEventListener('visibilitychange', fn)
    return () => window.removeEventListener('visibilitychange', fn)
  }, [hashKey])

  useEffect(() => {
    if (!state.isInvalidated && state.dataUpdatedAt + staleTime < Date.now()) return;
    // dispatch(fetchAsyncState(/**/));
  }, [hashKey, state.isInvalidated]);
};

// è¯·æ±‚æˆåŠŸåè¦é‡ç½®çŠ¶æ€
export const fetchAsyncState = (props) => (dispatch) => {
  // ...
  dispatch({ ASM: { [queryKey]: { status: "success", /**/, isInvalidated: false } } }),
  // ...
};
```

##### `refetchOnReconnect`

> å¦‚æœæ‚¨å¤±å»ç½‘ç»œè¿æ¥å¹¶é‡æ–°è·å¾—å®ƒï¼Œè¿™ä¹Ÿæ˜¯é‡æ–°éªŒè¯æ‚¨åœ¨å±å¹•ä¸Šçœ‹åˆ°çš„å†…å®¹çš„ä¸€ä¸ªå¾ˆå¥½çš„æŒ‡ç¤º

åŒä¸Šï¼Œç›‘å¬ `online/offline`ï¼Œä¸å†èµ˜è¿°

##### `refetchInterval`

å®šæ—¶è½®è¯¢ï¼Œçª—å£ä¸å¯è§æ—¶ä¼šåœæ­¢è½®è¯¢

`refetchIntervalInBackground`ï¼šçª—å£ä¸å¯è§æ—¶ä¾ç„¶è½®è¯¢

`useSWR`ï¼š`refreshInterval` + `refreshWhenHidden`

##### æ€ä¹ˆä½¿ç”¨å¾—å½“ï¼Ÿ

1. ç¼–è¾‘è¡¨å•ä¸è¦ä½¿ç”¨ï¼ˆ[æˆ–è€…è°¨æ…ä½¿ç”¨](https://tkdodo.eu/blog/react-query-and-forms)
2. æ•°æ®æ¶ˆå¤± `!==` æ•°æ®åˆ é™¤/æ— æ•ˆ çš„åœºæ™¯ä¸è¦ä½¿ç”¨ï¼ˆeg. æ¨èæµ
3. ä½¿ç”¨å¼º/å¼± `loading`ï¼ˆåé¢è¯´

#### æ‰‹åŠ¨æ›´æ–°

è¿›è¡Œ `å˜æ›´` æ“ä½œä¹‹åï¼Œæ˜ç¡®çŸ¥é“æ•°æ®æºå‘ç”Ÿå˜åŒ–äº†ï¼Œæ•°æ®å·²ç»è¿‡æ—¶äº†

Q: éœ€è¦é‡æ–°å‘èµ·è¯·æ±‚ï¼ˆå—ï¼Ÿï¼‰

A: å–å†³äºå½“å‰é¡µé¢ä¸­æœ‰æ²¡æœ‰ç»„ä»¶åœ¨ä½¿ç”¨è¿™ä¸ªæ•°æ®æº

---

å¤§å®¶ç°åœ¨æ˜¯æ€ä¹ˆåšçš„ï¼Œåœ¨å“ªåšçš„ï¼ˆè§†å›¾å±‚ or æ•°æ®å±‚ï¼‰ï¼Ÿæˆ–è€…è¯´æ˜¯åœ¨ç»„ä»¶é‡Œï¼Œè¿˜æ˜¯åœ¨ `redux` é‡Œ

åº”è¯¥éƒ½æ˜¯åœ¨ç»„ä»¶é‡Œï¼š

```ts
const onClick = () => {
  dispatch({ type: "task/delete" }).then(() => {
    dispatch({ type: "task/getList", payload: searchParams })
  })
}
```

å¦‚æœæ”¾åœ¨ `redux` é‡Œä¼šæœ‰ä»¥ä¸‹é—®é¢˜

1. æŠ½è±¡ `key` çš„é—®é¢˜ï¼Œé‡æ–°è¯·æ±‚å‚æ•°åº”è¯¥ä¼ ä»€ä¹ˆï¼Ÿï¼ˆè¦æŠŠå‚æ•°ä¹Ÿè®°åˆ° `redux` ä¸­ï¼‰
2. `dispatch({type: 'task/getList'})` ä¼šç›´æ¥è§¦å‘ç½‘ç»œè¯·æ±‚ï¼Œæ— æ³•åˆ¤æ–­æ˜¯å¦æœ‰ç»„ä»¶æ­£åœ¨ä½¿ç”¨æ•°æ®

```ts
switch (type) {
  case "task/delete":
    fetch("/api/delete").then(() => dispatch({ type: "task/getList" }))
}
```

å°±æ˜¯è¯´å› ä¸ºä»£ç åŸå› ï¼Œæ— æ³•ï¼ˆä¸èƒ½ç®€å•çš„ï¼‰æŠŠå®ƒæŠ½è±¡åˆ°æ•°æ®å±‚ä¸­ï¼Œæ‰€ä»¥ä¸å¾—ä¸åœ¨è§†å›¾å±‚åš

> æœŸæœ›æ•°æ®å±‚çš„äº‹å°½å¯èƒ½æ”¾åœ¨ uuâ€†juâ€†câ€†g æ•°æ®å±‚åšï¼Œè€Œä¸æ˜¯æ•£è½åœ¨è§†å›¾é‡Œ

---

åœ¨æˆ‘ä»¬ç›®å‰çš„å®ç°ä¸­ï¼Œå¯ä»¥è½»æ¾çš„è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒæŠŠé€»è¾‘éƒ½æ”¾åœ¨æ•°æ®å±‚ä¸­

åªéœ€è¦æä¾›å¦‚ä¸‹ä»£ç ï¼š

```ts
export const invalidateQueries = (key) => {
  const ASM = useSelector((state) => state.ASM);

  Object.keys(ASM).forEach((hashKey) => {
    const { queryKey } = ASM[hashKey]
    // éƒ¨åˆ†åŒ¹é…
    if (partialMatchKey(queryKey, key)) {
      dispatch({ ASM: { [key]: { /**/, isInvalidated: true } } }),
    }
  })
}

function partialMatchKey(a: any, b: any): boolean {
  if (a === b) return true

  if (typeof a !== typeof b) return false

  if (a && b && typeof a === 'object' && typeof b === 'object') {
    return !Object.keys(b).some((key) => !partialMatchKey(a[key], b[key]))
  }

  return false
}
```

1. åŸå§‹çš„ `queryKey` æ˜¯ä¼šè¢«å­˜ä¸‹æ¥çš„ï¼ˆä¸ºäº†é¿å…å¹²æ‰°å‰é¢æ²¡å†™
2. è¿™é‡Œåªå®ç°äº†éƒ¨åˆ†åŒ¹é…ï¼Œå› ä¸ºæ˜¯æœ€å¸¸ç”¨çš„ã€‚çœŸæ­£çš„ [invalidateQueries](https://tanstack.com/query/latest/docs/reference/QueryClient/#queryclientinvalidatequeries) å¯ä»¥ä¼ å…¥ `filters` ç²¾ç¡®æ§åˆ¶å…·ä½“çš„å¤±æ•ˆé€»è¾‘

ä¸šåŠ¡ä»£ç ä¸­å¦‚ä¸‹ä½¿ç”¨ï¼š

```ts
export const useDeleteTask = () => {
  return useMutation({
    mutationFn: () => fetch("/api/delete"),
    onSuccess() {
      invalidateQueries(["/api/list"])
    },
  })
}
```

##### ä¸ºä»€ä¹ˆå®ƒæœ‰æ•ˆï¼Ÿ

> è¿™å°±æ˜¯å¢åŠ ä¸€ä¸ª `isInvalidated` çš„å·§å¦™ä¹‹å¤„

ä½¿ç”¨äº† `useEffect` å¤©ç„¶çš„è®¢é˜…æœºåˆ¶ï¼šé€šè¿‡ `useEffect` ç›‘å¬äº†çŠ¶æ€çš„å˜åŒ–å‘é€è¯·æ±‚

å¦‚æœæ²¡æœ‰ä»»ä½•ç›¸å…³çš„ `useEffect` å­˜åœ¨ï¼Œå•çº¯çš„ä¿®æ”¹çŠ¶æ€æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿ

> TanStack Query è¢«è®¾è®¡çš„ä¸å±€é™äºæ¡†æ¶ï¼Œæ‰€ä»¥æŠ½è±¡äº†è¿™ä¸€éƒ¨åˆ†ï¼ˆ`observer`ï¼‰

![](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-14_11.29.56.png)

##### ä¸ºä»€ä¹ˆéƒ¨åˆ†åŒ¹é…å°±å¯ä»¥äº†ï¼Ÿ

å®é™…çš„ä¸šåŠ¡åœºæ™¯ä¸­ï¼Œå¾ˆå°‘åœ¨é¡µé¢ä¸ŠåŒæ—¶å­˜åœ¨æ¥å£è·¯å¾„ç›¸åŒï¼Œå‚æ•°ä¸åŒçš„è§†å›¾ï¼ˆeg. `/api/list?type=1`ã€`/api/list?type=2`ï¼‰

åŸºäºè¿™æ ·çš„æå‰ï¼š

- `invalidateQueries(['/api/list'])` æ•ˆæœç­‰åŒäº `invalidateQueries(['/api/list', {page: 1}])`
- `invalidateQueries(['/api/detail'])` æ•ˆæœç­‰åŒäº `invalidateQueries(['/api/detail', {id: 1}])`

è€Œä¸”å¦‚æœçœŸé‡åˆ°è¿™ç§åœºæ™¯ï¼Œä½ å°±æŠŠå‚æ•°ä¼ è¿›å»å‘—

##### æ‰‹åŠ¨è®¾ç½®ç¼“å­˜æ•°æ®

æœ‰äº›åç«¯æ¥å£å®ç°ä¸­ï¼Œä¼šåœ¨ `post/patch` çš„æ¥å£å“åº”é‡Œå°±æŠŠæœ€æ–°çš„æ•°æ®è¿”å›è¿‡æ¥ï¼Œè€Œä¸ç”¨å†å»å‘èµ· `get` è¯·æ±‚

é’ˆå¯¹è¿™ç§åœºæ™¯å¯ä»¥æä¾› `setQueryData` æ‰‹åŠ¨æ›´æ–°ç¼“å­˜æ•°æ®

```ts
export const setQueryData = (key, data) => {
    dispatch({ ASM: { [key]: { data } } }),
}
```

ä¸šåŠ¡ä½¿ç”¨å¦‚ä¸‹ï¼š

```ts
export const useEditTask = () => {
  return useMutation({
    mutationFn: (params) =>
      fetch(`/api/task${params.id}`, { method: "PATCH" }).then((data) => {
        setQueryData(["/api/task", { id: params.id }], data)
      }),
  })
}
```

---

`useSWR` ä¸­

- `mutate(key)` ç­‰åŒäº `invalidateQueries`ï¼ˆé»˜è®¤ç²¾ç¡®åŒ¹é…ï¼Œå¯ä»¥ä¼ å…¥å‡½æ•°æ¥å®ç°éƒ¨åˆ†åŒ¹é…
- `mutate(key, data, options)` ç­‰åŒäº `setQueryData`

### å†…å­˜å’Œåƒåœ¾å›æ”¶

äº‹æƒ…éƒ½æ˜¯ä¸¤é¢çš„ï¼ŒæŠ½è±¡å’Œå…·è±¡å„æœ‰ä¼˜åŠ£

æŠŠæ¯ä¸€ä¸ª `key` çš„æ•°æ®éƒ½å­˜ä¸‹æ¥ï¼Œä½“éªŒå¥½äº†ï¼Œå†…å­˜ä¹Ÿä¸Šå»äº†

> æŠ½è±¡ `key` æ˜¯ä¸éœ€è¦è€ƒè™‘ `GC` çš„ï¼Œå› ä¸ºæ¯æ¬¡è¯·æ±‚å®Œï¼Œå°±å·²ç»æŠŠæ—§æ•°æ®é‡Šæ”¾äº†ï¼Œå†…å­˜ä¸­æ¯ä¸ªæŠ½è±¡ `key` åªæœ‰ä¸€ä»½æ•°æ®
>
> å°±ç®—ç”¨æˆ·æŠŠæ‰€æœ‰çš„é¡µé¢éƒ½ç‚¹ä¸€éï¼Œä¹Ÿåªä¼šæœ‰ä»£ç ä¸­ `modal` æ•°é‡çš„æ•°æ®å­˜åœ¨å†…å­˜ä¸­è€Œå·²

ç›´æ¥çœ‹ `React Query` æ˜¯å¦‚ä½•è§£å†³çš„

> `gcTime`ï¼šä»ç¼“å­˜ä¸­åˆ é™¤éæ´»åŠ¨æŸ¥è¯¢ä¹‹å‰çš„æŒç»­æ—¶é—´ï¼Œé»˜è®¤ä¸º 5 åˆ†é’Ÿ
>
> ä¸€æ—¦æ²¡æœ‰æ³¨å†Œè§‚å¯Ÿè€…ï¼Œå³å½“ä½¿ç”¨è¯¥æŸ¥è¯¢çš„æ‰€æœ‰ç»„ä»¶éƒ½å·²å¸è½½æ—¶ï¼ŒæŸ¥è¯¢å°±ä¼šè½¬æ¢ä¸ºéæ´»åŠ¨çŠ¶æ€ï¼ˆ`inactive`ï¼‰

å¦‚æœä¸€ä»½æ•°æ®å·²ç»æ²¡æœ‰ä»»ä½•ç»„ä»¶åœ¨ä½¿ç”¨äº†ï¼Œ`gcTime` åå›æ”¶å®ƒ

> é¢‘ç¹è§¦å‘è¯·æ±‚çš„åœºæ™¯å¯ä»¥è®¾ç½®çš„çŸ­ä¸€ç‚¹ï¼Œæ¯”å¦‚æœç´¢åœºæ™¯

ä»£ç å®ç°ä¸Šï¼Œå°±æ˜¯è®¢é˜…æ¨¡å¼é…åˆå®šæ—¶å™¨

ä¾ç„¶æ˜¯åˆ©ç”¨ `useEffect` çš„ç‰¹æ€§ï¼Œé…åˆå…¨å±€çŠ¶æ€ç®¡ç†å®ç°ï¼šã€Œæ˜¯å¦è¿˜åœ¨ç»„ä»¶åœ¨ä½¿ç”¨æ•°æ®ã€

```ts
export const useQuery = (props) => {
  // ...
  useEffect(() => {
    dispatch({ type: "gc/add", payload: hashKey })

    return () => dispatch({ type: "gc/remove", payload: hashKey })
  }, [hashKey])
  // ...
}
```

`redux` ä¸­ï¼š

```ts
case 'gc/add':
  const {count = 0, timer} = state.GC[hashKey] || {}
  clearTimeout(timer)
  return { GC: { [hashKey]: { count: count + 1 } } }
case 'gc/remove': {
  const count = state.GC[hashKey] - 1
  let timer
  if (count === 0 && state.ASM[hashKey]) {
    timer = setTimeout(() => {
      state.ASM[hashKey] = null
    }, crime)
  }

  return { GC: { [hashKey]: { count, timer } } }
}
```

`useSWR` ä¸­å¹¶æ²¡æœ‰æä¾›æ¸…ç†ç¼“å­˜çš„ç›¸å…³é…ç½®ï¼Œä½†æ˜¯å®ƒå…è®¸ä½ å®Œå…¨ [è‡ªå®šä¹‰ç¼“å­˜è¡Œä¸º](https://swr.vercel.app/zh-CN/docs/advanced/cache)ï¼Œæ‰€ä»¥å¯ä»¥è‡ªè¡Œå®ç°ç›¸å…³åŠŸèƒ½

### è¯·æ±‚åˆå¹¶ï¼ˆå»é‡ï¼‰

ç›®å‰çš„åŒæ­¥å…¨å±€çŠ¶æ€ç®¡ç†ä¸­ï¼Œå¦‚æœå¤§å®¶è¦å–ä¸€ä¸ªå…¨å±€çš„æ•°æ®ï¼ˆæ¯”å¦‚ `userInfo`ï¼‰ï¼Œæ˜¯ç”¨å“ªç§æ–¹å¼å–çš„ï¼Ÿ

1. æ‰¾ä¸€ä¸ªè¶³å¤Ÿé«˜çš„çˆ¶ç»„ä»¶ï¼Œä½¿ç”¨ `useSelector` å–åˆ°åï¼Œåˆ©ç”¨ `props` å‘ä¸‹ä¸åŒçš„é€ä¼ ï¼ˆ`props drilling`ï¼‰
2. ç›´æ¥åœ¨ä½¿ç”¨çš„åœ°æ–¹ `useSelector` å–

æˆ‘è§‰å¾—åœ¨é—®åºŸè¯ï¼Œå½“æ—¶æ˜¯ 2 å•Šï¼ˆä¸ä¼šçœŸçš„æœ‰äººç”¨ 1 å§ ğŸ˜±

---

æˆ‘ä»¬çŸ¥é“ `useQuery` çš„å®ç°å…¶å®ä¹Ÿåªæ˜¯ä¸€ä¸ªæœ‰å‰¯ä½œç”¨çš„ `useSelector` è€Œå·²

```ts
export const useQuery = (props) => {
  // ...
  const state = useSelector(/**/)

  useEffect(/**/)
  // ...
}
```

æˆ‘ä»¬å¸Œæœ›å¯¹äºä½¿ç”¨è€…ï¼ˆè§†å›¾å±‚ï¼‰æ¥è¯´ï¼Œå°±æŠŠå®ƒå½“æˆ `useSelector`ï¼Œåªç®¡å–æ•°æ®ã€ç”¨æ•°æ®å°±å¥½äº†

- ä¸è¦å»ç®¡æ•°æ®ä»å“ªæ¥çš„
- ä¸è¦å»ç®¡æ•°æ®æœ‰æ²¡æœ‰è¿‡æ—¶
- ä¸è¦å»ç®¡æ•°æ®ä¸ºä»€ä¹ˆä¼šæ›´æ–°
- ä¸è¦å»ç®¡ä¼šä¸ä¼šé‡å¤è¯·æ±‚
- ...

è¿™äº›éƒ½æ˜¯æ•°æ®å±‚çš„äº‹æƒ…ï¼Œè§†å›¾å±‚ç®¡å¥½æ¸²æŸ“å°±å¯ä»¥äº†

> å½“ç„¶è¿™æ˜¯ç†æƒ³çŠ¶æ€ï¼Œåªèƒ½å°½å¯èƒ½å»åš

![mutil-comp-request](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-09_23.56.55.png)

---

ç›®å‰çš„å®ç°å¦‚æœå¤šä¸ªç»„ä»¶åŒæ—¶æŒ‚è½½ï¼Œæ˜¯ä¼šåŒæ—¶å‘å‡ºå¤šä¸ªè¯·æ±‚çš„

åªéœ€è¦åŠ å…¥ `loading` æ€çš„åˆ¤æ–­å³å¯å®Œæˆå»é‡

```ts
export const fetchAsyncState = (props) => (dispatch, getState) => {
  const { status } = getState().ASM[queryKey] || {}

  if (status === "loading") return

  dispatch({ ASM: { [queryKey]: { status: "loading" } } })
  // ...
}
```

> [!TIP]  
> æŠ½è±¡ `key` è¿™æ ·å†™å°±ä¼šæœ‰é—®é¢˜ï¼Œå› ä¸ºå¯èƒ½ä¼šæœ‰ä¸åŒå‚æ•°çš„è¯·æ±‚è¿›æ¥

ä¸Šé¢çš„ä»£ç æ§åˆ¶äº†æ¥å£ `loading` è¿‡ç¨‹ä¸­çš„é‡å¤è¯·æ±‚ï¼ˆå–å†³äºæ¥å£çš„é€Ÿåº¦ï¼Œä¹Ÿè®¸æ˜¯å‡ ç™¾æ¯«ç§’ï¼‰

å¯¹äºåŒæ­¥çš„ç»„ä»¶æ ‘æŒ‚è½½ï¼Œè¿™å·²ç»è¶³å¤Ÿäº†ï¼ˆé¢è¯•é¢˜ï¼šuseEffect çš„è°ƒç”¨æ—¶æœºå’Œé¡ºåº

ä½†å¦‚æœé‡åˆ°å¼‚æ­¥ç»„ä»¶ï¼ˆlazy loadï¼‰ï¼Œå°±è¿˜æœ‰å¯èƒ½å‘ç”Ÿé‡å¤è¯·æ±‚ï¼Œé‚£åº”è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿ

**`staleTime` æ˜¯ä½ çš„å¥½æœ‹å‹**

> `staleTime` ä¹Ÿæ²¡æœ‰ã€Œæ­£ç¡®ã€å€¼ã€‚åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œé»˜è®¤è®¾ç½®ï¼ˆ0ï¼‰æ•ˆæœéå¸¸å¥½
>
> å°±ä¸ªäººè€Œè¨€ï¼Œæˆ‘å–œæ¬¢å°†å…¶è®¾ç½®ä¸ºè‡³å°‘ 20 ç§’ï¼Œä»¥ä¾¿åœ¨è¯¥æ—¶é—´èŒƒå›´å†…åˆ é™¤é‡å¤è¯·æ±‚ï¼Œä½†è¿™å®Œå…¨å–å†³äºæ‚¨
>
> -- React Query

### ä¸¢å¼ƒ/å–æ¶ˆè¯·æ±‚

æœ‰äº›åœºæ™¯è¯·æ±‚çš„æ•°æ®å·²ç»ä¸å¯èƒ½å†è¢«ä½¿ç”¨äº†ï¼Œæ­¤æ—¶éœ€è¦å¿½ç•¥/ä¸¢å¼ƒ/å–æ¶ˆè¯·æ±‚çš„ç»“æœ

1. å¿«é€Ÿçš„ç¿»é¡µï¼ˆåªæœ‰æœ€ååœç•™çš„é¡µé¢æ•°æ®æ‰æ˜¯æœ‰ç”¨çš„
2. æ²¡æœ‰æœç´¢æŒ‰é’®ï¼Œåªé èŠ‚æµä¸”æ²¡æœ‰å…¼å®¹ä¸­æ–‡è¾“å…¥æ³•çš„æœç´¢æ¡†ï¼ˆæœ€åä¸Šå±çš„ä¸­æ–‡æ‰æ˜¯è¦æœçš„
3. å¯¼èˆªæ è·¯ç”±å¿«é€Ÿåˆ‡æ¢ï¼ˆç»„ä»¶éƒ½å·²ç»å¸è½½äº†ï¼Œè¿˜è¯·æ±‚æ•°æ®å¹²å˜›

ç›¸ä¿¡è¿™äº›é—®é¢˜å¤§å®¶å¤šå°‘ä¹Ÿé‡åˆ°è¿‡

- æŠ½è±¡ `key`ï¼šå‰ä¸¤ç§æƒ…å†µå¿…é¡»è¦å»è§£å†³ï¼Œä¸ç„¶å°±ä¼šæœ‰ BUGï¼ˆå¼±ç½‘å¿…ç°
- å…·è±¡ `key`ï¼šå¯ä»¥ä¸è§£å†³ï¼Œæ˜¯ä¸ä¼šæœ‰ BUG çš„ã€‚ä½†è€ƒè™‘åˆ°ç¼“å­˜ã€GC çš„åŸå› ï¼Œæœ€å¥½è¿˜æ˜¯è§£å†³ä¸€ä¸‹

å¯ä»¥ç”¨ `AbortController` ä¼˜é›…çš„å®ç°ç›¸å…³é€»è¾‘

- å¯ä»¥ç›´æ¥ä¼ é€’ç»™ `fetch`ï¼Œä»¥å®ç°è¯·æ±‚å–æ¶ˆï¼ˆ promise reject
- ä¹Ÿå¯ä»¥åœ¨è‡ªå®šä¹‰é€»è¾‘ä¸­è®¿é—® `aborted` å±æ€§å®ç°ä¸¢å¼ƒé€»è¾‘

```ts
const ac = new AbortController()

console.log(ac.signal.aborted) // false
ac.abort()
console.log(ac.signal.aborted) // true
```

å…·ä½“åˆ°ä»£ç ä¸­ï¼Œåœ¨æ¯æ¬¡è¯·æ±‚æ—¶åˆ›å»ºä¸€ä¸ª `AbortController` å®ä¾‹ï¼Œå¹¶å°†å…¶ `signal` ä¼ é€’ç»™å®é™…çš„æ‰§è¡Œè€…ï¼š`queryFn`

```ts
export const fetchAsyncState = (props) => (dispatch) => {
  // ...  
  const ac = new AbortController()
  dispatch({ ASM: { [queryKey]: { status: "loading", ac } } })
  
  return queryFn({...props, signal: ac.signal })
    .then((data) =>
      dispatch({ ASM: { [queryKey]: { status: "success", data } } })
    )
}

// GC
case 'gc/remove': {
  if (count === 0 && state.ASM[hashKey]) {
    state.ASM[hashKey]?.ac?.abort()

    // timer = setTimeout(() => {
  }
}
```

è€Œä½¿ç”¨è€…åªéœ€è¦åœ¨ `queryFn` ä¸­ä½¿ç”¨ `signal` å°±å¯ä»¥äº†ï¼ˆç»å¤§å¤šæ•°æƒ…å†µä¹Ÿæ˜¯ç›´æ¥é€ä¼ ç»™ `fetch`

```ts
export const useTaskList = () =>
  useQuery({
    queryKey: "taskList",
    queryFn: ({ signal }) =>
      fetch("/api/list", { signal }).then((res) => res.json()),
  })
```

### ç”¨æˆ·ä½“éªŒ

#### `loading`

> å¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬ï¼ˆå’Œæˆ‘ä»¬çš„ç”¨æˆ·ï¼‰ä¸å–œæ¬¢è®¨åŒçš„åŠ è½½æ—‹è½¬å™¨ã€‚
>
> æœ‰æ—¶å®ƒä»¬æ˜¯å¿…éœ€çš„ï¼Œä½†æˆ‘ä»¬ä»ç„¶å¸Œæœ›å°½å¯èƒ½é¿å…å®ƒä»¬

è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ `React Query/SWR` ä¼šä¸ºæˆ‘ä»¬æä¾›ä¸¤ä¸ª `loading` å˜é‡ï¼š

- `isLoading`: è¯·æ±‚ä¸­ä¸”æ²¡æœ‰æ•°æ®å¯ç”¨
- `isFetching/isValidating`: è¯·æ±‚ä¸­å·²æœ‰æ•°æ®å¯ç”¨

ä¸ºäº†è‰¯å¥½çš„ç”¨æˆ·ä½“éªŒï¼Œè¦å‡†å¤‡ä¸¤ä¸ª `loading` æ•ˆæœ

- å¼º `loading`ï¼šé¦–æ¬¡è¯·æ±‚æ—¶ï¼Œæ²¡æœ‰æ•°æ®å¯ç”¨äºæ¸²æŸ“
  - ![](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-15_11.27.06.png)
- å¼± `loading`ï¼šæ•°æ®æ›´æ–°ï¼ˆæ‰‹åŠ¨/è‡ªåŠ¨ï¼‰æ—¶ï¼Œé¡µé¢ä¸­å·²æœ‰æ•°æ®æ¸²æŸ“
  - ![](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/%E7%BB%88%E7%AB%AF%E7%9A%84%E5%BC%82%E6%AD%A5%E7%8A%B6%E6%80%81%E7%AE%A1%E7%90%86--2024-04-15_11.27.19.png)

![](https://swr.vercel.app/_next/image?url=%2F_next%2Fstatic%2Fmedia%2Fisloading.12715e06.gif&w=3840&q=75)

> é…åˆç»„ä»¶åŒ–

#### é”™è¯¯å¤„ç†

> å¤„ç†é”™è¯¯æ˜¯å¤„ç†å¼‚æ­¥æ•°æ®ï¼ˆå°¤å…¶æ˜¯æ•°æ®è·å–ï¼‰ä¸å¯æˆ–ç¼ºçš„ä¸€éƒ¨åˆ†
>
> æˆ‘ä»¬å¿…é¡»é¢å¯¹ç°å®ï¼šå¹¶ä¸æ˜¯æ‰€æœ‰çš„è¯·æ±‚éƒ½ä¼šæˆåŠŸï¼Œä¹Ÿä¸æ˜¯æ‰€æœ‰çš„ Promise éƒ½ä¼šå¾—åˆ°å±¥è¡Œ

å¯¹äºåˆå§‹è¯·æ±‚ï¼ˆæ²¡æœ‰æ•°æ®ï¼‰ï¼Œæ²¡æœ‰ä»€ä¹ˆå¯ä»¥å€¼å¾—è®¨è®ºçš„ï¼Œæˆ‘ä»¬éœ€è¦å±•ç¤ºé™çº§çš„è§†å›¾æˆ–æç¤º

> ä¸€èˆ¬ä½¿ç”¨å…¨å±€å¤„ç† or ç»„ä»¶å°è£…çš„æ–¹å¼æ¥è§£å†³

å¯¹äºæ•°æ®æ›´æ–°çš„åœºæ™¯ï¼Œå¦‚æœä½ ç”¨çš„æ˜¯ `toast` é”™è¯¯æç¤ºï¼Œä¹Ÿè¿˜å¥½

ä½†å¦‚æœç”¨çš„æ˜¯æ¸²æŸ“é”™è¯¯è§†å›¾çš„æ–¹å¼ï¼Œå°±è¦å¤šè€ƒè™‘ä¸€ä¸‹äº†ï¼Œå°¤å…¶æ˜¯è‡ªåŠ¨æ›´æ–°çš„åœºæ™¯ï¼šÂ Â `refetchOnWindowFocus/refetchOnReconnect`Â ï¼Œå¦‚æœæ­¤ç±»è‡ªåŠ¨æ›´æ–°è·å–å¤±è´¥ï¼Œå¯èƒ½ä¼šå¯¼è‡´ç”¨æˆ·ä½“éªŒæ··ä¹±

> æ¯”å¦‚ç”¨æˆ·åœ¨æµè§ˆåˆ—è¡¨çš„æ—¶å€™æ¥äº†ä¸ªå¾®ä¿¡æ¶ˆæ¯ï¼Œç­‰å›å®Œæ¶ˆæ¯ä»å¾®ä¿¡åˆ‡å›æµè§ˆå™¨åï¼Œå‘ç°åˆ—è¡¨å˜æˆäº†ä¸€ä¸ªé”™è¯¯æç¤ºè§†å›¾

ä¼˜å…ˆå±•ç¤ºé”™è¯¯è¿˜æ˜¯é™ˆæ—§çš„æ•°æ®ï¼Ÿè¿™ä¸ªé—®é¢˜æ²¡æœ‰æ˜ç¡®çš„ç­”æ¡ˆï¼Œå–å†³äºå…·ä½“åœºæ™¯

å¯¹äºä¸€ä¸ªåº“æ¥è¯´ï¼Œè¦åšçš„å°±æ˜¯ã€Œ**åŒæ—¶å°†æ”¶åˆ°çš„é”™è¯¯å’Œè¿‡æ—¶çš„æ•°æ®è¿”å›ç»™ç”¨æˆ·**ã€ï¼ˆç›®å‰çš„ä»£ç å®ç°å°±æ˜¯è¿™æ ·ï¼‰

ç°åœ¨ï¼Œç”±ä½ æ¥å†³å®šæ˜¾ç¤ºä»€ä¹ˆï¼š

- æ˜¾ç¤ºé”™è¯¯å¾ˆé‡è¦å—ï¼Ÿ
- ä»…æ˜¾ç¤ºé™ˆæ—§æ•°æ®æ˜¯å¦è¶³å¤Ÿï¼Ÿ
- æˆ–è€…åŒæ—¶æ˜¾ç¤ºä¸¤è€…ï¼Ÿ

```ts
const { data, error } = useTodos()

// é”™è¯¯ä¼˜å…ˆ
if (error) return "An error has occurred: " + todos.error.message
if (data) return todos.data.map(renderTodo)

// æ•°æ®ä¼˜å…ˆ
if (data) return todos.data.map(renderTodo)
if (error) return "An error has occurred: " + todos.error.message

// åŒæ—¶å±•ç¤º
return (
  <>
    {error && "An error has occurred: " + todos.error.message}
    {data && todos.data.map(renderTodo)}
  </>
)
```

#### ä¹è§‚æ›´æ–°

åœ¨åˆé€‚çš„åœºæ™¯é‡Œåˆæ˜¯ä¸€ä¸ªæå‡ä½“éªŒçš„å¤§æ€å™¨

> è¿™ç§ç­–ç•¥çš„æ ¸å¿ƒæ€æƒ³æ˜¯åœ¨æ•°æ®å®é™…å†™å…¥æœåŠ¡å™¨ä¹‹å‰ï¼Œå°±å‡è®¾å†™å…¥æ“ä½œä¼šæˆåŠŸï¼Œå¹¶ä¸”ç«‹å³åœ¨å‰ç«¯åº”ç”¨ä¸­æ›´æ–°æ•°æ®  
> è¿™æ ·åšçš„ç›®çš„æ˜¯ä¸ºäº†æå‡ç”¨æˆ·ä½“éªŒï¼Œå‡å°‘ç­‰å¾…æ—¶é—´ï¼Œå¹¶ç»™äºˆç”¨æˆ·ä¸€ç§å¿«é€Ÿå“åº”çš„æ„Ÿè§‰

ç›®å‰æˆ‘ä»¬å¯¹ `å˜æ›´` æ“ä½œçš„å¤„ç†åº”è¯¥éƒ½æ˜¯é˜»å¡ UIï¼šç»™ç”¨æˆ·ä¸€ä¸ª `loading/disable`ï¼Œåœ¨æ­¤æœŸé—´æ— æ³•è¿›è¡Œå…¶ä»–æ“ä½œï¼Œç›´åˆ°æ¥å£å“åº”ï¼ˆæˆåŠŸ/å¤±è´¥

![Pasted image 202404151322341](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/Pasted%20image%20202404151322341.png)

åœ¨æœ‰ä¸šåŠ¡æ ¡éªŒçš„åœºæ™¯ï¼ˆeg è´­ç‰©ï¼‰ï¼Œè¿™æ˜¯åˆç†çš„ï¼Œå› ä¸ºä¼šæœ‰å¾ˆå¤šå› ç´ å¯¼è‡´å¤±è´¥ï¼ˆä½™é¢ã€å•†å“æ•°é‡ã€åœ°å€â€¦ï¼‰ï¼Œæœ‰äº›æ¥è‡ªäºç”¨æˆ·è¾“å…¥ï¼Œè¿™æ˜¯æ— æ³•æ§åˆ¶çš„

ä½†æœ‰äº›åœºæ™¯ï¼ˆeg èŠå¤©ã€è¯„è®ºï¼‰ï¼Œæ¥å£çš„æˆåŠŸ/å¤±è´¥åªå–å†³äºæœåŠ¡å¯ç”¨æ€§ï¼Œæˆ‘ä»¬çŸ¥é“æ‰€æœ‰å…¬å¸éƒ½å¯¹æœåŠ¡å¯ç”¨æ€§æœ‰è¦æ±‚

> é«˜å¯ç”¨æ€§æŒ‡æ ‡é€šå¸¸ç”¨â€œå‡ ä¸ª 9â€æ¥è¡¨ç¤ºï¼Œå³ç³»ç»Ÿåœ¨ä¸€å¹´ä¸­çš„æ­£å¸¸è¿è¡Œæ—¶é—´æ‰€å çš„ç™¾åˆ†æ¯”ã€‚ä¾‹å¦‚ï¼š
>
> - 99.9%ï¼ˆä¸‰ä¸ª 9ï¼‰ï¼šåœ¨ä¸€å¹´ä¸­æœ€å¤šå…è®¸ 8.76 å°æ—¶çš„åœæœºæ—¶é—´ã€‚
> - 99.99%ï¼ˆå››ä¸ª 9ï¼‰ï¼šåœ¨ä¸€å¹´ä¸­æœ€å¤šå…è®¸ 52.56 åˆ†é’Ÿçš„åœæœºæ—¶é—´ã€‚
> - 99.999%ï¼ˆäº”ä¸ª 9ï¼‰ï¼šåœ¨ä¸€å¹´ä¸­æœ€å¤šå…è®¸ 5.26 åˆ†é’Ÿçš„åœæœºæ—¶é—´ã€‚

> æ—¢ç„¶å¾ˆå¤šæ—¶å€™ï¼ˆ> 99.9%ï¼‰ï¼Œæˆ‘ä»¬éå¸¸ç¡®å®šæ›´æ–°å°†ä¼šå®Œæˆï¼Œä¸ºä»€ä¹ˆè¿˜è¦ç”¨æˆ·å¤šç­‰å¾…å‡ ç§’é’Ÿï¼Œç›´åˆ°ä»åç«¯è·å¾—è®¸å¯æ‰èƒ½åœ¨ UI ä¸­æ˜¾ç¤ºç»“æœï¼Ÿ
>
> ä¹è§‚æ›´æ–°çš„æƒ³æ³•æ˜¯åœ¨æˆ‘ä»¬å°† `mutate` å‘é€åˆ°æœåŠ¡å™¨ä¹‹å‰å°± **ä¼ªé€ ** æˆåŠŸï¼Œä¸€æ—¦æˆ‘ä»¬æ”¶åˆ°æˆåŠŸçš„å“åº”ï¼Œæ‰€è¦åšçš„å°±æ˜¯ä½¿ç¼“å­˜å¤±æ•ˆä»¥è·å–çœŸå®çš„æœåŠ¡ç«¯æ•°æ®
>
> å¦‚æœè¯·æ±‚å¤±è´¥ï¼Œæˆ‘ä»¬å°†æŠŠ UI å›æ»šåˆ° `mutate` ä¹‹å‰çš„çŠ¶æ€ï¼ˆå¹¶åœ¨æ¥ä¸‹æ¥å›é€€åˆ°é˜»å¡æ¨¡å¼ï¼‰

äº¤äº’æµç¨‹å¤§æ¦‚å¦‚ä¸‹ï¼Œä»¥åˆ—è¡¨æ–°å¢ä¸ºä¾‹ï¼š

![modal-add](https://raw.githubusercontent.com/lei4519/picture-bed/main/images/Pasted%20image%2020240415132137.png)

1. ç”¨æˆ·ç‚¹å‡»æ–°å¢æŒ‰é’®åï¼ŒåŒæ—¶è¿›è¡Œä»¥ä¸‹æ“ä½œ
   1. å‘èµ·è¯·æ±‚
   2. æ‰‹åŠ¨ä¿®æ”¹åˆ—è¡¨æ•°æ®ï¼Œ`unshift` æ–°æ•°æ®
   3. å…³é—­æ–°å¢å¼¹çª—
2. è¯·æ±‚è¿‡ç¨‹ä¸­ï¼Œåˆ—è¡¨å·²ç»å±•ç¤ºäº†æœ¬åœ°æ•°æ®è¡Œï¼Œä½†æœ€å¥½åœ¨è§†è§‰ä¸Šæé†’ç”¨æˆ·è¿™ä¸æ˜¯ç»ˆæ€ï¼Œæ¯”å¦‚å¯ä»¥ï¼š
   - å¯¹æœ¬åœ°æ•°æ®è¡ŒåŠ å…¥å¼± `loading`
   - å¯¹æœ¬åœ°æ•°æ®è¡ŒåŠ å…¥åŠé€æ˜æ•ˆæœ `opacity: 0.5`
     - é…åˆä¸€äº›æ’å…¥çš„è¿‡æ¸¡åŠ¨ç”»ï¼Œå¯ä»¥å®ç°æ— æ„Ÿæ›´æ–°
3. è¯·æ±‚æˆåŠŸï¼Œä»€ä¹ˆéƒ½ä¸éœ€è¦åš
4. è¯·æ±‚å¤±è´¥ï¼Œå¯ä»¥åšå¦‚ä¸‹æ“ä½œ

   - å›æ»šåˆ—è¡¨æ•°æ®ï¼Œç»™å‡º `toast` é”™è¯¯æç¤º
   - ä¸å›æ»šåˆ—è¡¨æ•°æ®ï¼Œç›´æ¥ç»™æœ¬åœ°æ•°æ®è¡ŒåŠ å…¥é”™è¯¯ UIï¼ˆæ¯”å¦‚çº¢è‰²èƒŒæ™¯å’Œé”™è¯¯åŸå› ï¼‰

ä¸€æ—¦å‘ç”Ÿä¹è§‚æ›´æ–°å¤±è´¥çš„åœºæ™¯ï¼Œå°±å…³é—­ä¹è§‚æ›´æ–°æ¨¡å¼ï¼Œå›é€€åˆ°é˜»å¡æ¨¡å¼

> é…åˆç»„ä»¶åŒ–

##### Via the Cache

`React Query` æä¾›äº†ä¸¤ç§ä¹è§‚æ›´æ–°çš„æ–¹å¼ï¼Œå…ˆæ¥çœ‹æ ‡å‡†çš„ï¼šé€šè¿‡ä¿®æ”¹ç¼“å­˜æ•°æ®å®ç°

```ts
const queryClient = useQueryClient()

useMutation({
  mutationFn: updateTodo,
  // æ¯æ¬¡ mutate è¢«è°ƒç”¨æ—¶è§¦å‘ï¼š
  onMutate: async (newTodo) => {
    // 1. å–æ¶ˆæ‰€æœ‰æ­£åœ¨è¿›è¡Œçš„åˆ—è¡¨è·å–è¯·æ±‚
    // å› ä¸ºå®ƒä»¬ä¼šè¦†ç›–æˆ‘ä»¬çš„ä¹è§‚æ›´æ–°
    await queryClient.cancelQueries({ queryKey: ["todos"] })

    // 2. è·å–ç›®å‰çš„æ•°æ®å¿«ç…§ï¼Œä»¥ä¾¿æˆ‘ä»¬å¯ä»¥å›æ»š
    const previousTodos = queryClient.getQueryData(["todos"])

    // 3. ä¹è§‚æ›´æ–°ï¼Œç›´æ¥ä¿®æ”¹æ•°æ®
    // åŠ å…¥äº† isOptimistic å­—æ®µï¼Œæ–¹ä¾¿è§†å›¾ä¸­çš„å±•ç¤ºåˆ¤æ–­
    queryClient.setQueryData(["todos"], (old) => [
      { isOptimistic: true, ...newTodo },
      ...old,
    ])

    // 4. å°†å¿«ç…§å­˜å…¥ contextï¼Œä»¥ä¾¿åœ¨å¤±è´¥æ—¶å›æ»š
    return { previousTodos }
  },
  // å¦‚æœå¤±è´¥ï¼Œä½¿ç”¨ onMutate è¿”å›çš„ context å›æ»š
  onError: (err, newTodo, context) => {
    queryClient.setQueryData(["todos"], context.previousTodos)
  },
  // æ— è®ºæˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œè¿™ä¸ªå‡½æ•°éƒ½ä¼šè¢«è°ƒç”¨ï¼Œåœ¨æ­¤é‡æ–°è·å–åˆ—è¡¨æ•°æ®
  // æˆåŠŸæ—¶è·å–æœ€æ–°çš„æœåŠ¡ç«¯æ•°æ®ä»¥åŒæ­¥ä¹è§‚æ›´æ–°çš„çŠ¶æ€
  // å¤±è´¥æ—¶è·å–æ˜¯å› ä¸ºæˆ‘ä»¬ä¸ºäº†é˜²æ­¢ä¹è§‚æ›´æ–°è¢«è¦†ç›–ï¼Œåœ¨ç¬¬ä¸€æ­¥å–æ¶ˆäº†æ­£åœ¨è¿›è¡Œä¸­çš„è¯·æ±‚ï¼Œæ­¤æ—¶è¦è®©å®ƒä»¬ç»§ç»­
  onSettled: () => {
    queryClient.invalidateQueries({ queryKey: ["todos"] })
  },
})
```

##### Via the UI

å¾ˆå–å·§ä½†æ˜¯æ›´ç®€å•çš„æ–¹å¼ï¼Œä¸ä¼šå»ä¿®æ”¹ç¼“å­˜æ•°æ®ï¼Œåˆ©ç”¨ `mutate + query` é…åˆ `loading` ç›´æ¥åœ¨ UI å±‚åšä¹è§‚æ›´æ–°

é¦–å…ˆæ•°æ®å±‚ä»£ç æ˜¯è¿™æ ·çš„ï¼š

```ts
useMutation({
  mutationFn: updateTodo,
  // make sure to _return_ the Promise from the query invalidation
  // so that the mutation stays in `pending` state until the refetch is finished
  onSettled: async () => {
    return queryClient.invalidateQueries({ queryKey: ["todos"] })
  },
})
```

çœ‹èµ·æ¥å¥½åƒä»€ä¹ˆéƒ½æ²¡æœ‰åšï¼šæˆ‘ä»¬å‘èµ·è¯·æ±‚ï¼Œå¹¶åœ¨å®Œæˆåè§¦å‘ç¼“å­˜å¤±æ•ˆæ›´æ–°æ•°æ®ï¼Œè¿™æ˜¯æœ€å¸¸è§„çš„å†™æ³•

è¯€çªåœ¨ `onSettled` çš„ `return`ï¼Œå®ƒè¿”å›äº† `queryClient.invalidateQueries`

æˆ‘ä»¬çŸ¥é“ `invalidateQueries` çš„ä½œç”¨æ˜¯ä½¿ç¼“å­˜å¤±æ•ˆï¼Œä½†å®é™…ä¸Šå®ƒä¼šè¿”å›ä¸€ä¸ª `promise`ï¼Œç¼“å­˜å¤±æ•ˆæ—¶å¦‚æœè§¦å‘äº†ç½‘ç»œè¯·æ±‚ï¼Œ`promise` ä¼šåœ¨è¯·æ±‚æˆåŠŸä¹‹å `resolve`

ä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„ä»£ç ç­‰åŒäºï¼š

```ts
return fetch("/api/update", { method: "POST" }).then(() => fetch("/api/todos"))
```

å®ƒæŠŠ `mutate` å’Œ `query` é“¾æ¥åœ¨äº†ä¸€èµ·ï¼Œå˜æˆäº†ä¸€ä¸ª `promise` é“¾ï¼Œå½“æ•´ä¸ªé“¾æ¡æ²¡æœ‰ `resolve` æ—¶ï¼Œ`useMutation` ä¹Ÿä¸ä¼šç»“æŸ

æ‰€ä»¥è§†å›¾å±‚æˆ‘ä»¬å¯ä»¥ç›´æ¥è®¿é—® `isPending` æ¥å±•ç¤ºä¹è§‚æ›´æ–°çš„çŠ¶æ€

```ts
const { isPending, variables } = useMutation()

<ul>
  {todoQuery.items.map((todo) => (
    <li key={todo.id}>{todo.text}</li>
  ))}
  {isPending && <li style={{ opacity: 0.5 }}>{variables}</li>}
</ul>
```

éå¸¸çš„å·§å¦™ï¼Œå¦‚æœè¯·æ±‚æˆåŠŸäº†ï¼Œ`isPending` å°±ä¼šå˜æˆ `false`ï¼Œè¿™æ ·å°±ä¸ä¼šå±•ç¤ºä¹è§‚æ›´æ–°çš„æ•°æ®äº†ï¼Œä½†åŒæ—¶æœ€æ–°çš„åˆ—è¡¨æ•°æ®ä¹Ÿå·²ç»è¯·æ±‚å›æ¥å¹¶æ›´æ–°åœ¨äº† UI ä¸Š

å¦‚æœè¯·æ±‚å¤±è´¥äº†ï¼Œ`isPending` åŒæ ·å˜ä¸º `false`ï¼Œç›¸å½“äºè‡ªåŠ¨æ‰§è¡Œäº†å›æ»šæ“ä½œ

---

è¿™æ˜¯ä¸€ä¸ªå–å·§ä¸”ç®€å•çš„æ–¹æ³•ï¼Œæ‰€ä»¥æœ‰ç€ä¸€äº›å±€é™æ€§ï¼š

- åªèƒ½åŒæ—¶å­˜åœ¨ä¸€ä¸ªä¹è§‚æ›´æ–°çš„æ•°æ®ï¼Œå› ä¸º `isPending` åªæœ‰ä¸€ä¸ª
  - ä»¥ç°åœ¨çš„ç½‘ç»œæƒ…å†µå¤šæ•°ä¹Ÿå¤Ÿç”¨äº†ï¼Œå°±ç®—æ”¯æŒå¤šæ•°æ®åŒæ—¶ä¹è§‚æ›´æ–°ï¼Œç”¨æˆ·æ“ä½œçš„é€Ÿåº¦ä¹Ÿå¾ˆéš¾è·Ÿä¸Šç½‘ç»œè¯·æ±‚çš„é€Ÿåº¦
- æ— æ³•æ§åˆ¶æ˜¯å¦å›æ»šæ•°æ®
  - æœ‰äº›æ—¶å€™æˆ‘ä»¬ä¸æƒ³å›æ»šæ•°æ®ï¼Œè€Œæ˜¯åœ¨ UI ä¸Šç»™äºˆæç¤ºå’Œé‡è¯•çš„æ“ä½œï¼Œè¿™ç§æ–¹å¼æ˜¯åšä¸åˆ°çš„

#### æ¸²æŸ“ä¾èµ–ä¼˜åŒ–

è€ƒè™‘å¦‚ä¸‹åœºæ™¯ï¼š

```ts
const result = useTaskList()
const { isLoading, data } = result
```

æˆ‘ä»¬çŸ¥é“ `result` é‡Œçš„æ•°æ®æ˜¯ä¼šé¢‘ç¹å˜åŒ–çš„ï¼Œæ¯”å¦‚å½“ `isFetching/error/isInvalidated...` å˜åŒ–æ—¶

ä½†è¿™ä¸ªç»„ä»¶åªä½¿ç”¨äº† `isLoading & data`ï¼Œå¦‚æœå…¶ä»–æ•°æ®çš„å˜åŒ–å¯¼è‡´äº† `result` å˜åŒ–ï¼Œè¿›è€Œå¯¼è‡´ç»„ä»¶é‡æ–°æ¸²æŸ“ï¼Œè¿™æœ‰å¿…è¦å—ï¼Ÿ

å› ä¸ºæˆ‘ä»¬åªä½¿ç”¨äº† `isLoading & data`ï¼Œæ‰€ä»¥å…¶ä»–æ•°æ®çš„å˜åŒ–å¹¶ä¸ä¼šå¯¼è‡´é‡æ–°æ¸²æŸ“çš„ç»„ä»¶æœ‰ä»€ä¹ˆå˜åŒ–ï¼Œæ‰€ä»¥è¿™æ˜¯æ²¡æœ‰å¿…è¦çš„

React Query é€šè¿‡ç›‘å¬æ•°æ®çš„ `get`ï¼Œå®ç°äº†åªä¼šåœ¨ä½¿ç”¨çš„æ•°æ®å˜åŒ–æ—¶ï¼Œé‡æ–°æ¸²æŸ“ç»„ä»¶

> ç›®å‰ redux çš„ä»£ç ï¼Œæ²¡æ³•ç®€å•çš„å®ç°è¿™ä¸ªåŠŸèƒ½ï¼Œæ‰€ä»¥å°±ç›´æ¥çœ‹ ReactQuery çš„æºç å§

```ts
  trackResult(
    result: QueryObserverResult<TData, TError>,
  ): QueryObserverResult<TData, TError> {
    const trackedResult = {} as QueryObserverResult<TData, TError>
    // åªç›‘å¬äº†ç¬¬ä¸€å±‚
    Object.keys(result).forEach((key) => {
      Object.defineProperty(trackedResult, key, {
        configurable: false,
        enumerable: true,
        get: () => {
          this.#trackedProps.add(key as keyof QueryObserverResult)
          return result[key as keyof QueryObserverResult]
        },
      })
    })

    return trackedResult
  }

const shouldNotifyListeners =() => {
  const includedProps = new Set(this.#trackedProps)

  return Object.keys(this.#currentResult).some((key) => {
    const typedKey = key as keyof QueryObserverResult
    const changed = this.#currentResult[typedKey] !== prevResult[typedKey]
    // å‘ç”Ÿæ›´æ–°å¹¶ä¸”æ•°æ®è¢«è®¿é—®è¿‡
    return changed && includedProps.has(typedKey)
  })
}
```

#### ç»“æ„å…±äº«ä¼˜åŒ–

æ¯æ¬¡ä»åå°è¯·æ±‚å›æ¥çš„æ•°æ®ï¼Œå³ä½¿æ•°æ®å®Œå…¨æ²¡æœ‰å˜åŒ–ï¼Œå¼•ç”¨ä¹Ÿå…¨éƒ¨éƒ½æ˜¯æ–°çš„äº†

è€ƒè™‘å¦‚ä¸‹å“åº”ï¼Œæ–°è·å–çš„æ•°æ®ä¸­åª `id=1` å‘ç”Ÿäº†å˜åŒ–ï¼Œ`id=2` æ•°æ®æ˜¯æ²¡æœ‰å˜çš„

```diff
[
-  { "id": 1, "name": "Learn React", "status": "active" },
+  { "id": 1, "name": "Learn React", "status": "done" },
  { "id": 2, "name": "Learn React Query", "status": "todo" }
]
```

React Query ä¼šæ·±åº¦æ¯”è¾ƒæ•°æ®ï¼Œå¹¶å°½å¯èƒ½å¤šåœ°ä¿ç•™ä»¥å‰çš„çŠ¶æ€ï¼ˆå¼•ç”¨ï¼‰

å¯¹äºä¸Šé¢çš„å“åº”ï¼Œ`id=1` ä¼šæ˜¯ä¸€ä¸ªæ–°çš„å¼•ç”¨ï¼Œè€Œ `id=2` åˆ™ä»ç„¶æ˜¯ä¹‹å‰çš„å¼•ç”¨

> è™šæ‹Ÿ DOM diff -> å‡å°‘ DOM çš„æ“ä½œ  
> æ•°æ® diff -> å‡å°‘ è™šæ‹Ÿ DOM çš„æ“ä½œ

### More

- é¢„æ¸²æŸ“
- æ¡ä»¶æŸ¥è¯¢ï¼ˆä¾èµ–æŸ¥è¯¢ï¼‰
- è¯·æ±‚å¤±è´¥è‡ªåŠ¨é‡è¯•
- æ— é™æ»šåŠ¨æŸ¥è¯¢
- ç¦»çº¿ç¼“å­˜
- æœåŠ¡ç«¯æ¸²æŸ“
- `Suspense`
- ...

è¿˜å¯ä»¥æ¥ç€åˆ—ï¼Œä½†æ˜¯æ²¡æœ‰å¿…è¦äº†ï¼Œè¯¦ç»†çš„å¯ä»¥ç›´æ¥å»çœ‹å¯¹åº”åº“çš„å®˜ç½‘

å°±ç›®å‰è¯´çš„è¿™äº›ï¼Œå·²ç»å®Œå…¨å¯ä»¥è¯´æ˜åŒæ­¥ã€å¼‚æ­¥çŠ¶æ€ç®¡ç†çš„ä¸åŒäº†

å›è¿‡å¤´æ¥å†çœ‹ï¼šã€Œæ•°æ®è·å–å¾ˆç®€å•ï¼Œå¼‚æ­¥çŠ¶æ€ç®¡ç†ä¸æ˜¯ã€ï¼Œä¹Ÿå¯ä»¥è¯´ã€Œä»£ç å¼€å‘å¾ˆç®€å•ï¼Œç”¨æˆ·ä½“éªŒä¸æ˜¯ã€

## Ref

- [TanStack Query](https://tanstack.com/query/latest)
- [ç”¨äºæ•°æ®è¯·æ±‚çš„ React Hooks åº“ â€“ SWR](https://swr.vercel.app/zh-CN)
- [React Query vs SWR vs RTP Query](https://tanstack.com/query/latest/docs/framework/react/comparison)
- [TkDodo's blog](https://tkdodo.eu/blog/practical-react-query)
- [React Query: Itâ€™s Time to Break up with your "Global Stateâ€! â€“Tanner Linsley - YouTube](https://www.youtube.com/watch?v=seU46c6Jz7E)
- [SWR RFC](https://datatracker.ietf.org/doc/html/rfc5861)

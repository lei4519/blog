<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>使用Electron + Vue3 + Ts 实现定时提醒休息软件 | Lay</title>
    <meta name="generator" content="VuePress 1.5.1">
    
    <meta name="description" content="lay的博客">
    <link rel="preload" href="/blog/assets/css/0.styles.d6b61f4e.css" as="style"><link rel="preload" href="/blog/assets/js/app.366a5dbf.js" as="script"><link rel="preload" href="/blog/assets/js/3.7fd611cf.js" as="script"><link rel="preload" href="/blog/assets/js/4.69713668.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.d925cc42.js"><link rel="prefetch" href="/blog/assets/js/11.4f3b8112.js"><link rel="prefetch" href="/blog/assets/js/12.b29bd7a3.js"><link rel="prefetch" href="/blog/assets/js/13.7a937e21.js"><link rel="prefetch" href="/blog/assets/js/14.ac111c27.js"><link rel="prefetch" href="/blog/assets/js/15.60c7b342.js"><link rel="prefetch" href="/blog/assets/js/16.9063f0a7.js"><link rel="prefetch" href="/blog/assets/js/17.66988df6.js"><link rel="prefetch" href="/blog/assets/js/18.b5406d3f.js"><link rel="prefetch" href="/blog/assets/js/19.5bc6f3c2.js"><link rel="prefetch" href="/blog/assets/js/20.a7b8075e.js"><link rel="prefetch" href="/blog/assets/js/21.303051f7.js"><link rel="prefetch" href="/blog/assets/js/22.2806ba77.js"><link rel="prefetch" href="/blog/assets/js/5.84453e49.js"><link rel="prefetch" href="/blog/assets/js/6.5eba1b9e.js"><link rel="prefetch" href="/blog/assets/js/7.168f9a7c.js"><link rel="prefetch" href="/blog/assets/js/8.88168724.js"><link rel="prefetch" href="/blog/assets/js/9.7b49b522.js"><link rel="prefetch" href="/blog/assets/js/vendors~flowchart.b1ec1440.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.d6b61f4e.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">Lay</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/technology/Electron/ipc.html" class="nav-link">
  技术分享
</a></div><div class="nav-item"><a href="/blog/practice/Blog/vuepress.html" class="nav-link">
  实战分享
</a></div><div class="nav-item"><a href="/blog/notes/VsCode/Vuepress/flowchart.html" class="nav-link">
  烂笔头
</a></div> <a href="https://github.com/lei4519/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">
  Home
</a></div><div class="nav-item"><a href="/blog/technology/Electron/ipc.html" class="nav-link">
  技术分享
</a></div><div class="nav-item"><a href="/blog/practice/Blog/vuepress.html" class="nav-link">
  实战分享
</a></div><div class="nav-item"><a href="/blog/notes/VsCode/Vuepress/flowchart.html" class="nav-link">
  烂笔头
</a></div> <a href="https://github.com/lei4519/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Blog</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Vue</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/practice/Vue/vue3-rest.html" aria-current="page" class="active sidebar-link">使用Electron + Vue3 + Ts 实现定时提醒休息软件</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/blog/practice/Vue/vue3-rest.html#前言" class="sidebar-link">前言</a></li><li class="sidebar-sub-header"><a href="/blog/practice/Vue/vue3-rest.html#项目搭建" class="sidebar-link">项目搭建</a></li><li class="sidebar-sub-header"><a href="/blog/practice/Vue/vue3-rest.html#需求梳理" class="sidebar-link">需求梳理</a></li><li class="sidebar-sub-header"><a href="/blog/practice/Vue/vue3-rest.html#代码实现" class="sidebar-link">代码实现</a></li><li class="sidebar-sub-header"><a href="/blog/practice/Vue/vue3-rest.html#项目打包" class="sidebar-link">项目打包</a></li></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="使用electron-vue3-ts-实现定时提醒休息软件"><a href="#使用electron-vue3-ts-实现定时提醒休息软件" class="header-anchor">#</a> 使用Electron + Vue3 + Ts 实现定时提醒休息软件</h1> <h2 id="前言"><a href="#前言" class="header-anchor">#</a> 前言</h2> <p>对于一直面对电脑的程序员，眼睛的休息是很重要的。但是我们程序员又太过于勤勤恳恳、聚精会神、专心致志、任劳任怨！难免会忽略了时间的流逝。</p> <p>所以我们迫切的需要一个定时提醒软件，来帮助我们管理时间！～</p> <p>秉承着钻研技术的理念，这次我们就自己来动手做一个定时提醒软件。</p> <p>本文将会从项目搭建 -&gt; 代码实现 -&gt; 应用打包，手把手一行行代码的带你完成这个项目。</p> <p>看完本文你将学会什么知识呢？</p> <ol><li>electron：基本使用、进程通信、打包</li> <li>vue3: composition API、路由、vite</li> <li>node: 多进程相关知识</li></ol> <p>让我们开始吧～！</p> <h2 id="项目搭建"><a href="#项目搭建" class="header-anchor">#</a> 项目搭建</h2> <h3 id="vue3搭建（渲染进程代码）"><a href="#vue3搭建（渲染进程代码）" class="header-anchor">#</a> Vue3搭建（渲染进程代码）</h3> <p>首先搭建一个vue3的项目，我们将使用随着vue3的到来同样大火的<a href="https://github.com/vitejs/vite" target="_blank" rel="noopener noreferrer">vite<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>来搭建。</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">yarn</span> create vite-app remind-rest
$ <span class="token builtin class-name">cd</span> remind-rest
$ <span class="token function">yarn</span>
$ <span class="token function">yarn</span> dev
</code></pre></div><p>执行完上面的命令，打开<code>http://localhost:3000/</code>就可以看到启动的vue项目了。</p> <h3 id="接入electron（主进程代码）"><a href="#接入electron（主进程代码）" class="header-anchor">#</a> 接入electron（主进程代码）</h3> <p>接下来我们将vue项目放入electron中运行</p> <p>首先安装electron + typescript（注意设置淘宝源或者使用cnpm下载）</p> <div class="language-sh extra-class"><pre class="language-sh"><code>$ <span class="token function">yarn</span> <span class="token function">add</span> dev electron typescript
</code></pre></div><p>使用<code>npx tsc --init</code>初始化我们的<code>tsconfig.json</code>，vue中的ts文件会被vite进行处理，所以这里的tsconfig配置只处理我们的electron文件即可，我们增加include属性<code>include: [&quot;main/&quot;]</code>。</p> <p>我们会把打包后的代码都放到<code>dist</code>目录中，所以配置一下<code>outDir</code>属性，将ts编译后的文件放入<code>dist/main</code>目录中</p> <p>修改如下</p> <div class="language-json {3, 5} extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;compilerOptions&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;outDir&quot;</span><span class="token operator">:</span> <span class="token string">&quot;./dist/main&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;include&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">&quot;main/&quot;</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在根目录创建<code>main</code>文件夹，用来存放electron主进程中的代码</p> <p>在main目录中新建<code>index.ts</code></p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">const</span> <span class="token punctuation">{</span>app<span class="token punctuation">,</span> BrowserWindow<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">require</span><span class="token punctuation">(</span><span class="token string">'electron'</span><span class="token punctuation">)</span>
<span class="token comment">// Electron会在初始化完成并且准备好创建浏览器窗口时调用这个方法</span>
app<span class="token punctuation">.</span><span class="token function">whenReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>createWindow<span class="token punctuation">)</span>

<span class="token comment">// 创建一个窗口</span>
<span class="token keyword">function</span> <span class="token function">createWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> win <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowserWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  win<span class="token punctuation">.</span><span class="token function">loadURL</span><span class="token punctuation">(</span><span class="token string">'http://localhost:3000'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>嗯，so easy！加上注释换行才9行代码，启动一下试试看～</p> <p>我们在package.json中加一个脚本<code>main-dev</code>，然后执行</p> <div class="language-json extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><br><br></div><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token property">&quot;dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token string">&quot;vite build&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main-dev&quot;</span><span class="token operator">:</span> <span class="token string">&quot;electron ./main/index.ts&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>不出意外你应该已经可以看到启动的桌面应用了，而里面显示的正是我们的vue项目。</p> <p>至此，开发环境已经搭建完毕，接下来我们梳理一下需求，看一下我们要做的究竟有哪些功能。然后开始实现代码。</p> <h2 id="需求梳理"><a href="#需求梳理" class="header-anchor">#</a> 需求梳理</h2> <h3 id="我们要实现哪些页面？"><a href="#我们要实现哪些页面？" class="header-anchor">#</a> 我们要实现哪些页面？</h3> <p>设置页面
<img src="/blog/assets/img/setting.3944a247.png" alt=""></p> <p>倒计时提示框
<img src="/blog/assets/img/tips.73f77983.png" alt=""></p> <p>锁屏页面
<img src="/blog/assets/img/rest.41ce0138.png" alt=""></p> <h3 id="我们需要实现什么功能？"><a href="#我们需要实现什么功能？" class="header-anchor">#</a> 我们需要实现什么功能？</h3> <ol><li>用户可以设置工作时间、休息时间、提示时间</li> <li>系统托盘栏中显示工作时间倒计时，托盘栏菜单项：<code>设置</code> <code>暂停</code> <code>继续</code> <code>重置</code> <code>退出</code></li> <li>工作倒计时剩余时间等于提示时间，显示提示框，提醒用户还有几秒进入锁屏界面</li> <li>用户可以点击提示框中的<code>暂停</code>和<code>重置</code>按钮，对倒计时进行操作</li> <li>倒计时结束，进入锁屏界面</li> <li>进入锁屏界面后，屏幕上显示休息倒计时和关闭按钮。</li> <li>用户只能通过点击<code>关闭</code>按钮提前退出锁屏界面，其他所有常规操作都无法退出锁屏界面（如切换屏幕、切换软件、cmd + Q）</li> <li>休息倒计时结束，自动退出锁屏界面，重新开始工作时间倒计时</li></ol> <p>好了，需求梳理完毕，让我们开始快乐的codeing吧👌～</p> <h2 id="代码实现"><a href="#代码实现" class="header-anchor">#</a> 代码实现</h2> <h3 id="完善渲染进程目录"><a href="#完善渲染进程目录" class="header-anchor">#</a> 完善渲染进程目录</h3> <p>在vue项目中创建如下文件</p> <div class="language-tree extra-class"><pre class="language-text"><code>- src
  - main.js // 入口文件
  - route.js // 路由配置
  - App.vue
  - views
    - LockPage.vue // 锁屏界面
    - Tips.vue // 提示气泡界面
    - Setting.vue // 设置界面
</code></pre></div><p>安装<code>vue-router</code></p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">yarn</span> <span class="token function">add</span> vue-router@^4.0.0-alpha.4
</code></pre></div><p>其中 <code>main.js</code> <code>route.js</code>都是vue3的新写法，和老版本没有太大区别，就不详细说明了，直接看代码吧</p> <p>views文件夹中的文件我们后面再具体实现</p> <p>main.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> createApp <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> App <span class="token keyword">from</span> <span class="token string">'./App.vue'</span>
<span class="token keyword">import</span> router <span class="token keyword">from</span> <span class="token string">'./route'</span>
<span class="token keyword">const</span> app <span class="token operator">=</span> <span class="token function">createApp</span><span class="token punctuation">(</span>App<span class="token punctuation">)</span>
app<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>router<span class="token punctuation">)</span>
router<span class="token punctuation">.</span><span class="token function">isReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> app<span class="token punctuation">.</span><span class="token function">mount</span><span class="token punctuation">(</span><span class="token string">'#app'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
</code></pre></div><p>route.js</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span>createRouter<span class="token punctuation">,</span> createWebHashHistory<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
<span class="token keyword">import</span> LockPage <span class="token keyword">from</span> <span class="token string">'./views/LockPage.vue'</span>
<span class="token keyword">import</span> Tips <span class="token keyword">from</span> <span class="token string">'./views/Tips.vue'</span>
<span class="token keyword">import</span> Setting <span class="token keyword">from</span> <span class="token string">'./views/Setting.vue'</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token function">createRouter</span><span class="token punctuation">(</span>
  <span class="token punctuation">{</span>
    history<span class="token operator">:</span> <span class="token function">createWebHashHistory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    routes<span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'/LockPage'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'LockPage'</span><span class="token punctuation">,</span>
        component<span class="token operator">:</span> LockPage
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'/Tips'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'Tips'</span><span class="token punctuation">,</span>
        component<span class="token operator">:</span> Tips
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        path<span class="token operator">:</span> <span class="token string">'/Setting'</span><span class="token punctuation">,</span>
        name<span class="token operator">:</span> <span class="token string">'Setting'</span><span class="token punctuation">,</span>
        component<span class="token operator">:</span> Setting
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span>
</code></pre></div><p>App.vue</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>router-view</span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>router-view</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  name<span class="token operator">:</span> <span class="token string">'App'</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h3 id="完善主进程目录"><a href="#完善主进程目录" class="header-anchor">#</a> 完善主进程目录</h3> <div class="language-js extra-class"><pre class="language-js"><code><span class="token operator">-</span> main
  <span class="token operator">-</span> index<span class="token punctuation">.</span>ts <span class="token comment">// 入口</span>
  <span class="token operator">-</span> tary<span class="token punctuation">.</span>ts <span class="token comment">// 托盘模块</span>
  <span class="token operator">-</span> browserWindow<span class="token punctuation">.</span>ts <span class="token comment">// 创建渲染进程窗口</span>
  <span class="token operator">-</span> countDown<span class="token punctuation">.</span>ts <span class="token comment">// 倒计时模块</span>
  <span class="token operator">-</span> setting<span class="token punctuation">.</span>ts <span class="token comment">// 设置模块</span>
  <span class="token operator">-</span> utils<span class="token punctuation">.</span>ts <span class="token comment">// 工具代码</span>
  <span class="token operator">-</span> store<span class="token punctuation">.</span>json <span class="token comment">// 本地存储</span>
</code></pre></div><h3 id="主进程自动重启"><a href="#主进程自动重启" class="header-anchor">#</a> 主进程自动重启</h3> <p>渲染进程的代码，每次我们修改之后都会进行热更新。而主进程的代码却没有这样的功能（社区中未找到相关实现），这就导致在主进程的开发过程中我们需要频繁的手动重启终端以去查看效果，这显然是一件很不效率的事情。这里我们通过node的api来简单实现一个主进程代码的自动重启的功能。</p> <p>思路其实也很简单，就是监听到文件变更后，自动重启终端</p> <p>首先我们需要使用node来运行终端命令，这样才能去进行控制。node怎么运行终端命令呢？使用child_process中的spawn模块就可以了，不熟悉的同学可以看一下这片文章<a href="/blog/technology/Node/child_process-spawn.html">child_process spawn模块详解</a></p> <p>在根目录新建一个<code>scripts</code>文件夹，用来存放我们的脚本文件</p> <p>然后在<code>scripts</code>目录中创建<code>createShell.js</code> <code>dev.js</code>这两个文件</p> <div class="language-sh extra-class"><pre class="language-sh"><code><span class="token function">mkdir</span> scripts
<span class="token builtin class-name">cd</span> scripts
<span class="token function">touch</span> createShell.js dev.js
</code></pre></div><p>在<code>createShell.js</code>文件中，创建一个工厂函数，传入终端命令，返回执行此命令的终端实例，代码如下:</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token punctuation">{</span> spawn <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span>

module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">createShell</span><span class="token punctuation">(</span><span class="token parameter">command</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token function">spawn</span><span class="token punctuation">(</span>command<span class="token punctuation">,</span> <span class="token punctuation">{</span>
    shell<span class="token operator">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接下来我们实现<code>dev.js</code>的内容，先来捋一下思路，当我们执行<code>dev.js</code>的时候，我们需要执行如下命令:</p> <ol><li>启动vite，运行渲染进程的代码</li> <li>启动tsc，编译主进程的代码</li> <li>等到tsc编译成功，启动electron</li> <li>监听到electron进程发出的重启信号，重启electron</li></ol> <div class="custom-block tip"><p class="custom-block-title">小提示</p> <p><code>&amp;&amp;</code>代表串行命令，前一个执行完才会执行后一个</p> <p><code>&amp;</code>代表并行命令，前后两个命令同时执行</p></div> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 引入我们刚才写的工厂函数</span>
<span class="token keyword">const</span> createShell <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./createShell'</span><span class="token punctuation">)</span>

<span class="token comment">// 运行vite 和 tsc</span>
<span class="token keyword">const</span> <span class="token function-variable function">runViteAndTsc</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">reslove</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 运行终端命令 下面会解释</span>
  <span class="token function">createShell</span><span class="token punctuation">(</span><span class="token string">'npx vite &amp; rm -rf ./dist/main &amp;&amp; mkdir dist/main &amp;&amp; cp -r main/store.json dist/main/store.json &amp;&amp; tsc -w'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>stdout<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'data'</span><span class="token punctuation">,</span> <span class="token parameter">buffer</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 输出子进程信息到控制台</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token comment">// tsc在每次编译生成后，会输出Watching for file changes</span>
    <span class="token comment">// 这里利用Promise状态只会改变一次的特性，来保证后续的代码逻辑只执行一次</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">includes</span><span class="token punctuation">(</span><span class="token string">'Watching for file changes'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">reslove</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token comment">// 运行electron</span>
<span class="token keyword">const</span> <span class="token function-variable function">runElectron</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token comment">// 定义环境变量，启动electron</span>
  <span class="token function">createShell</span><span class="token punctuation">(</span><span class="token string">'cross-env NODE_ENV=development electron ./dist/main/index.js'</span><span class="token punctuation">)</span>
    <span class="token comment">//监听到子进程的退出事件</span>
    <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'exit'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">code</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 约定信号100为重启命令，重新执行终端</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">100</span><span class="token punctuation">)</span> <span class="token function">runElectron</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token comment">// 使用kill而不是exit，不然会导致子进程无法全部退出</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>code <span class="token operator">===</span> <span class="token number">0</span><span class="token punctuation">)</span> process<span class="token punctuation">.</span><span class="token function">kill</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">// 串起流程，执行命令</span>
<span class="token function">runViteAndTsc</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>runElectron<span class="token punctuation">)</span>
</code></pre></div><p>在这里解释一下上面的终端命令，我们格式化一下</p> <div class="language-sh extra-class"><pre class="language-sh"><code>npx vite <span class="token operator">&amp;</span> <span class="token function">rm</span> -rf ./dist/main <span class="token operator">&amp;&amp;</span>
<span class="token function">mkdir</span> dist/main <span class="token operator">&amp;&amp;</span>
<span class="token function">cp</span> -r main/store.json dist/main/store.json <span class="token operator">&amp;&amp;</span>
tsc -w

<span class="token number">1</span>. 运行vite，同时删除掉上一次编译产生的main目录
<span class="token number">2</span>. 删除目录后，重新建一个空的main目录
<span class="token number">3</span>. 重建的目的是为了这行的copy命令，ts不会编译非.ts文件，我们需要手动拷贝store.json文件
<span class="token number">4</span>. 拷贝完成后，开始编译ts
</code></pre></div><p>这里补充一下，自己来写启动命令除了实现自动刷新之外，还有下面的原因：</p> <ol><li>electron 也可以直接运行ts文件，但是并不会编译ts，不编译的话在ts文件中就无法使用import，不使用import就没办法获得代码自动导入和提示功能，所以要先使用tsc编译ts文件成为js，然后再使用electron运行js</li> <li>而直接在终端输入命令是无法实现上述流程的，因为我们需要使用 tsc -w功能来监听文件变化重新编译，这就导致ts编译完成后并不会退出，所以无法使用 &amp;&amp; 串行命令执行electron，而使用 &amp; 并行命令可能会出现electron运行时，ts文件可能还没有编译成功导致electron加载文件不存在而启动失败的问题。所以我们需要自己写命令来进行控制。</li></ol> <p>以上只完成了第一步，接下来我们要监听文件变化并退出electron进程，退出时我们传入code：100，来通知外部这是一次重启</p> <p>先写一个辅助函数, 递归遍历指定目录下的所有文件，并执行传入的回调函数，向回调函数中传入当前文件的路径</p> <p><code>main/utils.ts</code></p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span>

type <span class="token function-variable function">callback</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">name<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">readDeepDir</span><span class="token punctuation">(</span><span class="token parameter">path<span class="token operator">:</span> string<span class="token punctuation">,</span> fn<span class="token operator">:</span> callback</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> <span class="token function-variable function">_reader</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">readdirSync</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">name</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>fs<span class="token punctuation">.</span><span class="token function">statSync</span><span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isDirectory</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token function">fn</span><span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> <span class="token function">_reader</span><span class="token punctuation">(</span>path <span class="token operator">+</span> <span class="token string">'/'</span> <span class="token operator">+</span> name<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> <span class="token function">_reader</span><span class="token punctuation">(</span>path<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在<code>main/index.ts</code>中监听当前的主进程目录，只要有文件变化，我们就执行<code>app.exit(100)</code>退出当前进程</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> readDeepDir <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./utils'</span>

<span class="token keyword">function</span> <span class="token function">watchFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> debounce<span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>Timeout
  <span class="token keyword">const</span> <span class="token function-variable function">reload</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">clearTimeout</span><span class="token punctuation">(</span>debounce<span class="token punctuation">)</span>
    debounce <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token comment">// 当前应用退出，外部进程接收到之后重启应用</span>
      app<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token number">100</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">300</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// fs.watch并不稳定，使用watchFile进行监听</span>
  <span class="token keyword">const</span> <span class="token function-variable function">watcher</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">path<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    fs<span class="token punctuation">.</span><span class="token function">watchFile</span><span class="token punctuation">(</span>path<span class="token punctuation">,</span> reload<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">readDeepDir</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> watcher<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>说明一下</p> <ol><li><p>不使用<code>fs.watch</code>是因为这个api并不稳定，会导致刷新结果不符合预期。watchFile是监听不到新增文件的，这个解决方案其实是借助tsc -w的能力，当有已监听的文件去引用新增文件的时候，就会导致tsc重新编译，然后触发自动刷新，当第二次启动electron的时候，就会把新的文件进行监听了</p></li> <li><p>electron是有<code>app.relaunch()</code>api的，调用这个api就会重启应用，那我们为什么不使用这个而要自己去写呢？是因为<code>app.relaunch</code>其实是另起了一个进程来运行新的electron，当前这个进程我们需要执行<code>app.exit()</code>来退出才可以，这是在官网说明的。但是如果我们这么做的话，<code>app.relaunch</code>启动的这个进程就会脱离了我们<code>node scripts/dev.js</code>这个进程的管控，导致我们中断<code>node scripts/dev.js</code>这个进程的时候，<code>app.relaunch</code>启动的这个进程还在运行的问题。</p></li></ol> <p>到此自动刷新就完成了，让我们真正的来实现代码逻辑吧！</p> <h3 id="主进程实现"><a href="#主进程实现" class="header-anchor">#</a> 主进程实现</h3> <h4 id="main-index-ts"><a href="#main-index-ts" class="header-anchor">#</a> main/index.ts</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> app <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'electron'</span>
<span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>inittary<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'./tary'</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> isDev <span class="token operator">=</span> process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">===</span> <span class="token string">'development'</span>
<span class="token comment">// 自动刷新</span>
isDev <span class="token operator">&amp;&amp;</span> <span class="token function">watchFile</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// 隐藏dock</span>
app<span class="token punctuation">.</span>dock<span class="token punctuation">.</span><span class="token function">hide</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// Electron会在初始化完成并且准备好创建浏览器窗口时调用这个方法</span>
app<span class="token punctuation">.</span><span class="token function">whenReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">inittary</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><ol><li>首先我们获取到当前的环境信息，如果是开发环境，就把刚才实现的自动刷新功能使用上。</li> <li>隐藏dock栏，因为我们的应用功能主要在托盘栏，不需要展示dock栏的图标</li> <li>当我们的app启动完成后，初始化托盘栏</li></ol> <p>index.js 代码很简单，这里的<code>inittary</code>我们还没实现，在实现它之前，让我们先把倒计时模块写好</p> <h4 id="main-countdown-ts"><a href="#main-countdown-ts" class="header-anchor">#</a> main/countDown.ts</h4> <p>首先定义些关于时间的常量</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">BASE_UNIT</span> <span class="token operator">=</span> <span class="token number">60</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">SECONDS</span> <span class="token operator">=</span> <span class="token number">1000</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">MINUTES</span> <span class="token operator">=</span> <span class="token constant">SECONDS</span> <span class="token operator">*</span> <span class="token constant">BASE_UNIT</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">HOURS</span> <span class="token operator">=</span> <span class="token constant">MINUTES</span> <span class="token operator">*</span> <span class="token constant">BASE_UNIT</span>
</code></pre></div><p>将倒计时模块写成一个类，方便管理</p> <p>这个类有三个私有属性</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">CountDown</span> <span class="token punctuation">{</span>
  <span class="token comment">// 用来计算当前的时间</span>
  <span class="token keyword">private</span> time <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token comment">// 保存传入的时间，重置时会用到</span>
  <span class="token keyword">private</span> _time <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token comment">// 清除定时器，暂停时会用到</span>
  <span class="token keyword">private</span> timer<span class="token operator">?</span><span class="token operator">:</span> NodeJS<span class="token punctuation">.</span>Timeout
<span class="token punctuation">}</span>
</code></pre></div><p>接下来实现相关方法，我们需要有设置时间、暂停时间、重置时间，启动倒计时这几个功能</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">setTime</span><span class="token punctuation">(</span><span class="token parameter">ms<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 如果之前有一个定时器在运行，就中断掉</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_time <span class="token operator">=</span> ms
  <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>
<span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">&amp;&amp;</span> <span class="token function">clearInterval</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">resetTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_time
  <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>
<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">-=</span> <span class="token constant">SECONDS</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">SECONDS</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>easy～ 再定义一个静态方法，用于将时间戳转换为我们的需要的时间格式</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">formatTimeByMs</span><span class="token punctuation">(</span><span class="token parameter">ms<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token punctuation">{</span>
    h<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ms <span class="token operator">/</span> <span class="token constant">HOURS</span><span class="token punctuation">)</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    m<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ms <span class="token operator">/</span> <span class="token constant">MINUTES</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token constant">BASE_UNIT</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    s<span class="token operator">:</span> <span class="token function">String</span><span class="token punctuation">(</span><span class="token punctuation">(</span>ms <span class="token operator">/</span> <span class="token constant">SECONDS</span><span class="token punctuation">)</span> <span class="token operator">%</span> <span class="token constant">BASE_UNIT</span> <span class="token operator">|</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">padStart</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> <span class="token string">'0'</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>ok，大体功能写好了，接下来我们需要把时间的变化发送出去</p> <p>为了时间的精确性，再使用时我们将为倒计时模块单独开一个进程，所以这里也使用进程通信的方式来发送消息</p> <p>先定义发送消息的接口</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">interface</span> <span class="token class-name">SendMsg</span> <span class="token punctuation">{</span>
  <span class="token comment">// 格式化后的时间</span>
  time<span class="token operator">:</span> <span class="token punctuation">{</span>
    h<span class="token operator">:</span> string
    m<span class="token operator">:</span> string
    s<span class="token operator">:</span> string
  <span class="token punctuation">}</span>
  <span class="token comment">// 原始时间戳</span>
  ms<span class="token operator">:</span> number
  <span class="token comment">// 时间是否归零</span>
  done<span class="token operator">:</span> boolean
<span class="token punctuation">}</span>
</code></pre></div><p>写一个发送消息的方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">private</span> <span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">msg<span class="token operator">:</span> SendMsg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  process<span class="token punctuation">.</span>send<span class="token operator">!</span><span class="token punctuation">(</span>msg<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后在重置时间和启动时间时给父进程发送消息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">resetTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_time
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    time<span class="token operator">:</span> CountDown<span class="token punctuation">.</span><span class="token function">formatTimeByMs</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    ms<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">,</span>
    done<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">&lt;=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token keyword">this</span>
<span class="token punctuation">}</span>
<span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    time<span class="token operator">:</span> CountDown<span class="token punctuation">.</span><span class="token function">formatTimeByMs</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">)</span><span class="token punctuation">,</span>
    ms<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">,</span>
    done<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">&lt;=</span> <span class="token number">0</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setInterval</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> done<span class="token operator">:</span> boolean
    <span class="token keyword">if</span> <span class="token punctuation">(</span>done <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">stop</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      time<span class="token operator">:</span> CountDown<span class="token punctuation">.</span><span class="token function">formatTimeByMs</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">-=</span> <span class="token constant">SECONDS</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      ms<span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">,</span>
      done
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token constant">SECONDS</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>OK，发送消息的逻辑我们处理完成了，接下来处理一下接收消息的流程</p> <p>首先定义接口，这会比较复杂，因为我们的这些方法中，setTime是需要传入参数的，而其他的方法并不需要，如果想准确进行提示，那我们就需要这么做</p> <p>首先我们将需要接收参数的方法名定义一个type，这里是将类型当成了变量来使用</p> <div class="language-js extra-class"><pre class="language-js"><code>type hasDataType <span class="token operator">=</span> <span class="token string">'setTime'</span>
</code></pre></div><p>然后我们定义不接受参数的接口，这里使用了两个技巧</p> <ol><li>keyof：因为我们的类中向外暴露的其实只有setTime、resetTime、run、stop，其他的都是私有变量或者静态方法，所以这里我们使用keyof就可以把这四个方法名取出来供类型系统使用</li> <li>Exclude：我们取出的名称中，setTime是需要传递参数的，所以使用Exclude将这个名称排除掉</li></ol> <p>这样操作之后，这里的type其实就是 resetTime | run | stop</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">ReceiveMsgNoData</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> Exclude<span class="token operator">&lt;</span>keyof CountDown<span class="token punctuation">,</span> hasDataType<span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>接收参数的接口就很简单了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">ReceiveMsgHasData</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> hasDataType
  data<span class="token operator">:</span> number
<span class="token punctuation">}</span>
</code></pre></div><p>最终定义一个联合类型供外部使用，这里之所以要定义数组类型，是为了方便外部使用，之后的代码中我们可以看到用法了</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> type ReceiveMsg <span class="token operator">=</span> ReceiveMsgNoData <span class="token operator">|</span> ReceiveMsgHasData <span class="token operator">|</span> Array<span class="token operator">&lt;</span>ReceiveMsgNoData <span class="token operator">|</span> ReceiveMsgHasData<span class="token operator">&gt;</span>
</code></pre></div><p>接口定义完了，来实现一下代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> c <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CountDown</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
process<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">message<span class="token operator">:</span> ReceiveMsg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>Array<span class="token punctuation">.</span><span class="token function">isArray</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    message <span class="token operator">=</span> <span class="token punctuation">[</span>message<span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  message<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">msg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>msg<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'setTime'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      c<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">(</span>msg<span class="token punctuation">.</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      c<span class="token punctuation">[</span>msg<span class="token punctuation">.</span>type<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>接收消息的功能也实现了，至此倒计时模块就写完了，快让我们去tary.js中把它使用起来吧！～</p> <h4 id="main-tary-ts"><a href="#main-tary-ts" class="header-anchor">#</a> main/tary.ts</h4> <p>同样的，tary也将使用类来实现</p> <p>在代码实现之前，我们先来捋一下逻辑</p> <ul><li>实例化Tary时：设置菜单项 -&gt; 监听倒计时模块消息 -&gt; 开始倒计时</li> <li>监听倒计时时间变化
<ol><li>如果当前是工作时间的倒计时，设置托盘栏文字为当前时间</li> <li>如果剩余时间等于提示时间，显示提示框，监听提示框进程的消息通信</li> <li>工作倒计时结束：关闭提示框进程。打开锁屏窗口，切换至休息时间倒计时</li> <li>时间变化时传递给锁屏渲染进程，以供渲染进程渲染时间</li> <li>锁屏进程点击关闭或者倒计时归零，通知主进程关闭锁屏界面，切换至工作时间倒计时</li></ol></li></ul> <p>先定义要使用的私有属性</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Tray <span class="token keyword">as</span> ElectronTary <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'electron'</span>

type TimeType <span class="token operator">=</span> <span class="token string">'REST'</span> <span class="token operator">|</span> <span class="token string">'WORK'</span>
<span class="token keyword">class</span> <span class="token class-name">Tary</span> <span class="token punctuation">{</span>
  <span class="token comment">// 初始化托盘栏，并传入托盘图标</span>
  <span class="token keyword">private</span> tray<span class="token operator">:</span> ElectronTary <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ElectronTary</span><span class="token punctuation">(</span>
    path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'../icon/img.png'</span><span class="token punctuation">)</span>
  <span class="token punctuation">)</span>
  <span class="token comment">// 标示当前时间为工作时间或休息时间</span>
  <span class="token keyword">private</span> timeType<span class="token operator">:</span> TimeType <span class="token operator">=</span> <span class="token string">'WORK'</span>
  <span class="token comment">// 菜单实例</span>
  <span class="token keyword">private</span> menu<span class="token operator">:</span> Menu <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">// 锁屏窗口实例</span>
  <span class="token keyword">private</span> restWindows<span class="token operator">:</span> BrowserWindow<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">// 提示框口实例</span>
  <span class="token keyword">private</span> tipsWindow<span class="token operator">:</span> BrowserWindow <span class="token operator">|</span> <span class="token keyword">null</span> <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token comment">// 倒计时模块 使用 child_process.fork 创建一个子进程</span>
  <span class="token keyword">private</span> countDown<span class="token operator">:</span> ChildProcess <span class="token operator">=</span> <span class="token function">fork</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./countDown'</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>定义向子进程发送消息的方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">send</span><span class="token punctuation">(</span><span class="token parameter">message<span class="token operator">:</span> ReceiveMsg <span class="token operator">|</span> ReceiveMsg<span class="token punctuation">[</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>countDown<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>message<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>设置菜单项，这里其实就是调用electron的api，详细的可以看官方文档。</p> <p>当用户点击暂停、继续、重置时，给倒计时模块发送消息。偏好设置的功能我们后面再实现</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">private</span> <span class="token function">setContextMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>menu <span class="token operator">=</span> Menu<span class="token punctuation">.</span><span class="token function">buildFromTemplate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      label<span class="token operator">:</span> <span class="token string">'偏好设置'</span><span class="token punctuation">,</span>
      accelerator<span class="token operator">:</span> <span class="token string">'CmdOrCtrl+,'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'separator'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token string">'play'</span><span class="token punctuation">,</span>
      label<span class="token operator">:</span> <span class="token string">'继续'</span><span class="token punctuation">,</span>
      accelerator<span class="token operator">:</span> <span class="token string">'CmdOrCtrl+p'</span><span class="token punctuation">,</span>
      visible<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">menuItem</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">'run'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 暂停和继续 只显示其中一个</span>
        menuItem<span class="token punctuation">.</span>menu<span class="token punctuation">.</span><span class="token function">getMenuItemById</span><span class="token punctuation">(</span><span class="token string">'pause'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">true</span>
        menuItem<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      id<span class="token operator">:</span> <span class="token string">'pause'</span><span class="token punctuation">,</span>
      label<span class="token operator">:</span> <span class="token string">'暂停'</span><span class="token punctuation">,</span>
      accelerator<span class="token operator">:</span> <span class="token string">'CmdOrCtrl+s'</span><span class="token punctuation">,</span>
      visible<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">menuItem</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          type<span class="token operator">:</span> <span class="token string">'stop'</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token comment">// 暂停和继续 只显示其中一个</span>
        menuItem<span class="token punctuation">.</span>menu<span class="token punctuation">.</span><span class="token function">getMenuItemById</span><span class="token punctuation">(</span><span class="token string">'play'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">true</span>
        menuItem<span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      label<span class="token operator">:</span> <span class="token string">'重置'</span><span class="token punctuation">,</span>
      accelerator<span class="token operator">:</span> <span class="token string">'CmdOrCtrl+r'</span><span class="token punctuation">,</span>
      <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">menuItem</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        menuItem<span class="token punctuation">.</span>menu<span class="token punctuation">.</span><span class="token function">getMenuItemById</span><span class="token punctuation">(</span><span class="token string">'play'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span>
        menuItem<span class="token punctuation">.</span>menu<span class="token punctuation">.</span><span class="token function">getMenuItemById</span><span class="token punctuation">(</span><span class="token string">'pause'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">true</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startWorkTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'separator'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> label<span class="token operator">:</span> <span class="token string">'退出'</span><span class="token punctuation">,</span> role<span class="token operator">:</span> <span class="token string">'quit'</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tray<span class="token punctuation">.</span><span class="token function">setContextMenu</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>menu<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>监听倒计时模块消息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">handleTimeChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>countDown<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'message'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">data<span class="token operator">:</span> SendMsg</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timeType <span class="token operator">===</span> <span class="token string">'WORK'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleWorkTimeChange</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleRestTimeChange</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>开始工作时间倒计时</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">private</span> <span class="token function">startWorkTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'setTime'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> workTime<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'run'</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>实例化时调用上面的方法</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">constructor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">setContextMenu</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleTimeChange</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startWorkTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面代码执行完成后，倒计时就启动了，接下来就要处理时间变化的逻辑了</p> <p>先来处理工作时间的变化</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">handleWorkTimeChange</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> time<span class="token operator">:</span> <span class="token punctuation">{</span>h<span class="token punctuation">,</span> m<span class="token punctuation">,</span> s<span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">,</span> done <span class="token punctuation">}</span><span class="token operator">:</span> SendMsg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>tary<span class="token punctuation">.</span><span class="token function">setTitle</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>h<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>s<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span> <span class="token comment">// 1</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>ms <span class="token operator">&lt;=</span> tipsTime<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">handleTipsTime</span><span class="token punctuation">(</span>s<span class="token punctuation">,</span> done<span class="token punctuation">)</span> <span class="token comment">// 2</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tipsWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeTipsWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 3</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toggleRest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">// 4</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>首先我们使用tary模块的setTitle api，将文字设置到托盘栏中。</li> <li>接着我们判断一下当前的时间是不是到了提示用户的时间，如果到了时间就开始展示提示框</li> <li>else if 的逻辑是一个容错处理，如果当前时间不是提示时间，但是提示框却存在的话，就关闭提示框。这种情况在重置时间的时候会发生。</li> <li>如果工作时间结束了，就切换到处理休息时间的逻辑上。</li></ol> <h5 id="展示提示框"><a href="#展示提示框" class="header-anchor">#</a> 展示提示框</h5> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token constant">TIPS_MESSAGE</span> <span class="token operator">=</span> <span class="token string">'TIPS_MESSAGE'</span>

<span class="token function">handleTipsTime</span><span class="token punctuation">(</span><span class="token parameter">s<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">,</span> done<span class="token operator">:</span> <span class="token builtin">boolean</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>tipsWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 初始化</span>
    ipcMain<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token constant">TIPS_MESSAGE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleTipsMsg<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tipsWindow <span class="token operator">=</span> <span class="token function">createTipsWindow</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tary<span class="token punctuation">.</span><span class="token function">getBounds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> s<span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span> <span class="token comment">// 发送消息</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tipsWindow<span class="token punctuation">.</span>webContents<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token constant">TIPS_MESSAGE</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
      s<span class="token punctuation">,</span>
      done
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>如果是之前没有提示气泡窗口，就做初始化的工作：监听渲染进程的消息，创建提示气泡窗口</li> <li>如果已经有了窗口就向窗口中发送时间变化的消息。</li></ol> <p>监听提示框渲染进程的消息</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">TipsMsgData</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'CLOSE'</span> <span class="token operator">|</span> <span class="token string">'RESET'</span> <span class="token operator">|</span> <span class="token string">'STOP'</span>
<span class="token punctuation">}</span>
<span class="token function-variable function">handleTipsMsg</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> IpcMainEvent<span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token punctuation">}</span><span class="token operator">:</span> TipsMsgData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'CLOSE'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeTipsWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'RESET'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeTipsWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'resetTime'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>type <span class="token operator">===</span> <span class="token string">'STOP'</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeTipsWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'stop'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>menu<span class="token punctuation">.</span><span class="token function">getMenuItemById</span><span class="token punctuation">(</span><span class="token string">'play'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>menu<span class="token punctuation">.</span><span class="token function">getMenuItemById</span><span class="token punctuation">(</span><span class="token string">'pause'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>visible <span class="token operator">=</span> <span class="token boolean">false</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">closeTipsWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>tipsWindow<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    ipcMain<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token constant">TIPS_MESSAGE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleTipsMsg<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tipsWindow<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>tipsWindow <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>如果是关闭的消息，就关闭提示窗口。关闭时先去除事件的监听，然后关闭窗口和引用</li> <li>如果是重置的消息，就关闭提示窗口，然后发消息通知计时器模块重置时间</li> <li>如果是停止的消息，就关闭提示窗口，然后通知计时器模块停止计时，然后将托盘栏的菜单项进行调整：显示继续菜单项，隐藏暂停菜单项</li></ol> <h5 id="创建提示气泡窗口"><a href="#创建提示气泡窗口" class="header-anchor">#</a> 创建提示气泡窗口</h5> <p>在browserWindow.ts中添加如下代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> <span class="token function-variable function">resolveUrl</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">address<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:3000/#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createTipsWindow</span><span class="token punctuation">(</span><span class="token parameter">rect<span class="token operator">:</span> Rectangle<span class="token punctuation">,</span> s<span class="token operator">:</span> string</span><span class="token punctuation">)</span><span class="token operator">:</span> BrowserWindow <span class="token punctuation">{</span>
  <span class="token keyword">const</span> win <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowserWindow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    x<span class="token operator">:</span> rect<span class="token punctuation">.</span>x<span class="token punctuation">,</span> <span class="token comment">// 窗口x坐标</span>
    y<span class="token operator">:</span> rect<span class="token punctuation">.</span>y<span class="token punctuation">,</span> <span class="token comment">// 窗口y坐标</span>
    width<span class="token operator">:</span> <span class="token number">300</span><span class="token punctuation">,</span> <span class="token comment">// 窗口宽度</span>
    height<span class="token operator">:</span> <span class="token number">80</span><span class="token punctuation">,</span> <span class="token comment">// 窗口高度</span>
    alwaysOnTop<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 一直显示在最上面</span>
    frame<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 无边框窗口</span>
    resizable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 不可以resize</span>
    transparent<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 窗口透明</span>
    webPreferences<span class="token operator">:</span> <span class="token punctuation">{</span>
      webSecurity<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 忽略web安全协议</span>
      devTools<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 不开启 DevTools</span>
      nodeIntegration<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 将node注入到渲染进程</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 加载Tips页面，传入消息通信的事件名称和时间</span>
  win<span class="token punctuation">.</span><span class="token function">loadURL</span><span class="token punctuation">(</span><span class="token function">resolveUrl</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/Tips?type=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">TIPS_MESSAGE</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;s=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>s<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> win
<span class="token punctuation">}</span>
</code></pre></div><h5 id="vue-渲染进程代码-src-views-tips-vue"><a href="#vue-渲染进程代码-src-views-tips-vue" class="header-anchor">#</a> vue 渲染进程代码: src/views/Tips.vue</h5> <p>页面结构很简单，提示用户还有几秒开始休息，然后提供暂停和关闭的按钮</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>wrap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>title<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>还剩{{time}}s开始休息～<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>progress<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btns<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>stop<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>暂停<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
      <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>button</span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>reset<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>重置<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>button</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>主要看一下逻辑代码</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">import</span> <span class="token punctuation">{</span>ref<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue'</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span>useRoute<span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">'vue-router'</span>
<span class="token keyword">const</span> <span class="token punctuation">{</span> ipcRenderer <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'electron'</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 取到当前页面的query参数</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>query<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token comment">// 使用传入的s作为时间</span>
    <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>s<span class="token punctuation">)</span>
    <span class="token comment">// 向主进程发送消息</span>
    <span class="token keyword">const</span> <span class="token function-variable function">close</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ipcRenderer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'CLOSE'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">stop</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ipcRenderer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'STOP'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ipcRenderer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'RESET'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// 监听时间变化，修改时间</span>
    ipcRenderer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ipc<span class="token punctuation">,</span> <span class="token punctuation">{</span>s<span class="token punctuation">,</span> done<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      time<span class="token punctuation">.</span>value <span class="token operator">=</span> s
      <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      time<span class="token punctuation">,</span>
      stop<span class="token punctuation">,</span>
      reset
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>为了节省篇幅，样式代码就不贴上来了，各位可以自行发挥，或者看下面的完整代码</p> <p>到此，气泡提示的代码已经被我们完成了。接下来我们继续处理工作时间结束时，切换至休息时间的逻辑</p> <h5 id="切换休息时间"><a href="#切换休息时间" class="header-anchor">#</a> 切换休息时间</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">handleWorkTimeChange</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">{</span> time<span class="token operator">:</span> <span class="token punctuation">{</span>h<span class="token punctuation">,</span> m<span class="token punctuation">,</span> s<span class="token punctuation">}</span><span class="token punctuation">,</span> ms<span class="token punctuation">,</span> done <span class="token punctuation">}</span><span class="token operator">:</span> SendMsg</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toggleRest</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function">toggleRest</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>timeType <span class="token operator">=</span> <span class="token string">'REST'</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">closeTipsWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  ipcMain<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token constant">REST_MESSAGE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleRestMsg<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>restWindows <span class="token operator">=</span> <span class="token function">createRestWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><ol><li>改变当前的timeType</li> <li>关闭提示气泡窗口</li> <li>监听锁屏渲染进程的事件</li> <li>创建休息时间的窗口</li></ol> <h5 id="监听事件"><a href="#监听事件" class="header-anchor">#</a> 监听事件</h5> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">RestMsgData</span> <span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">'CLOSE'</span> <span class="token operator">|</span> <span class="token string">'READY'</span>
  data<span class="token operator">?</span><span class="token operator">:</span> any
<span class="token punctuation">}</span>
<span class="token function-variable function">handleRestMsg</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> IpcMainEvent<span class="token punctuation">,</span> data<span class="token operator">:</span> RestMsgData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'READY'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startRestTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>data<span class="token punctuation">.</span>type <span class="token operator">===</span> <span class="token string">'CLOSE'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">toggleWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token function-variable function">startRestTime</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'setTime'</span><span class="token punctuation">,</span>
      data<span class="token operator">:</span> restTime
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'run'</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">toggleWork</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>timeType <span class="token operator">=</span> <span class="token string">'WORK'</span>
  ipcMain<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token constant">REST_MESSAGE</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>handleRestMsg<span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>restWindows<span class="token operator">?.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token parameter">win</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    win<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span>restWindows <span class="token operator">=</span> <span class="token keyword">null</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">startWorkTime</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>代码很简单，当渲染进程初始化成功后（vue create时机）会向我们发送READY事件，此时我们开始休息事件的倒计时。</p> <p>当渲染进程的倒计时结束或者点击了关闭按钮时，会触发关闭事件，此时我们将切换回工作时间</p> <p>再说一下切换回工作时间的逻辑</p> <ol><li>切换timeType为工作时间</li> <li>移除事件监听</li> <li>关闭休息时间的窗口（注意这里的休息时间窗口是个数组，原因我们下面会说），解除引用</li> <li>开始工作时间倒计时</li></ol> <p>喝口水接着来！创建休息时间的窗口（锁屏界面）</p> <p>main/browserWindow.ts</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createRestWindow</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> BrowserWindow<span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> screen<span class="token punctuation">.</span><span class="token function">getAllDisplays</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">map</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">display<span class="token punctuation">,</span> i</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token comment">// 创建浏览器窗口</span>
    <span class="token keyword">const</span> win <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowserWindow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      x<span class="token operator">:</span> display<span class="token punctuation">.</span>bounds<span class="token punctuation">.</span>x <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">,</span>
      y<span class="token operator">:</span> display<span class="token punctuation">.</span>bounds<span class="token punctuation">.</span>y <span class="token operator">+</span> <span class="token number">50</span><span class="token punctuation">,</span>
      fullscreen<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 全屏</span>
      alwaysOnTop<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 窗口是否应始终位于其他窗口的顶部</span>
      closable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 窗口是否可关闭</span>
      kiosk<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// kiosk模式</span>
      vibrancy<span class="token operator">:</span> <span class="token string">'fullscreen-ui'</span><span class="token punctuation">,</span> <span class="token comment">// 动画效果</span>
      webPreferences<span class="token operator">:</span> <span class="token punctuation">{</span>
        devTools<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        webSecurity<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
        nodeIntegration<span class="token operator">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// 并且为你的应用加载index.html</span>
    win<span class="token punctuation">.</span><span class="token function">loadURL</span><span class="token punctuation">(</span><span class="token function">resolveUrl</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/LockPage?type=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">REST_MESSAGE</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>i <span class="token operator">===</span> <span class="token number">0</span> <span class="token operator">?</span> <span class="token string">'&amp;isMainScreen=1'</span> <span class="token operator">:</span> <span class="token string">''</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;password=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>password<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token keyword">return</span> win
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个有几点需要特殊处理，因为我们希望出现锁屏界面时，用户就不可以进行别的操作了。</p> <p>这里我们需要启用kiosk模式来达到效果</p> <p>windows中的kiosk模式介绍如下（取自百度）：</p> <blockquote><p>什么是Windows自助终端模式？
Windows Kiosk模式只是Windows操作系统（OS）的一项功能，它将系统的可用性或访问权限仅限于某些应用程序。意思是，当我们在Windows上打开Kiosk模式时，它只允许一个应用程序运行，就像机场上的kiosk系统那样设置为仅运行Web浏览器，某些应用程序如PNR状态检查一个。
Kiosk模式的好处是，它允许企业仅在办公室，餐馆等运行特定的销售点（POS）应用程序，以阻止客户使用机器上的任何其他应用程序，除了他们已分配的应用程序。它不仅可以在windows 10上使用，而且还可以在Windows XP，Windows Vista，Windows 7和Windows 8.1中启用。</p></blockquote> <p>简单点说就是让你的电脑只运行当前这个应用程序，阻止你使用别的应用程序。</p> <p>主要的配置如下</p> <div class="language-js extra-class"><pre class="language-js"><code>fullscreen<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 窗口全屏</span>
alwaysOnTop<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 窗口一直显示在最上面</span>
closable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token comment">// 窗口不可关闭</span>
kiosk<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span> <span class="token comment">// 窗口为kiosk模式</span>
</code></pre></div><p>那代码中的<code>screen.getAllDisplays()</code>是干什么用的呢？这是为了防止外接显示器（程序员大多数都会外接的），如果我们只创建一个窗口，那只能让当前屏幕无法操作，而别的显示器还是可以正常工作的。所以我们使用这个api来获取到所有的显示器，然后为每一个显示器都创建一个窗口。</p> <p>同时我们只让第一个窗口中出现提示信息和关闭按钮。所以我们给渲染进程传入一个主屏幕的标志。</p> <p>vue渲染进程代码 views/LockPage.vue</p> <div class="language-vue extra-class"><pre class="language-vue"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">v-if</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>isMainScreen<span class="token punctuation">&quot;</span></span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>wrap<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>time<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>{{time}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>div</span> <span class="token attr-name">class</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>btn<span class="token punctuation">&quot;</span></span> <span class="token attr-name">@click</span><span class="token attr-value"><span class="token punctuation">=</span><span class="token punctuation">&quot;</span>close<span class="token punctuation">&quot;</span></span><span class="token punctuation">&gt;</span></span>X<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>div</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>

<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script"><span class="token language-javascript">
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>query<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token string">''</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">close</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ipcRenderer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'CLOSE'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> isMainScreen <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token operator">!</span><span class="token operator">!</span>query<span class="token punctuation">.</span>isMainScreen<span class="token punctuation">)</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>isMainScreen<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      ipcRenderer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token punctuation">{</span>type<span class="token operator">:</span> <span class="token string">'READY'</span><span class="token punctuation">}</span><span class="token punctuation">)</span>
      ipcRenderer<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">ipc<span class="token punctuation">,</span> <span class="token punctuation">{</span>time<span class="token operator">:</span> <span class="token punctuation">{</span>h<span class="token punctuation">,</span> m<span class="token punctuation">,</span> s<span class="token punctuation">}</span><span class="token punctuation">,</span> done<span class="token punctuation">}</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        time<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>h<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>m<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>s<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>done<span class="token punctuation">)</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      isMainScreen<span class="token punctuation">,</span>
      time<span class="token punctuation">,</span>
      close
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</span></span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><p>逻辑很简单，如果是主屏幕，那初始化的时候我们就发送一个ready事件，然后监听时间变化。如果时间结束就发送关闭的事件。</p> <p>至此，就只剩设置相关的逻辑没有写</p> <h4 id="main-setting-ts"><a href="#main-setting-ts" class="header-anchor">#</a> main/setting.ts</h4> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> fs <span class="token keyword">from</span> <span class="token string">'fs'</span>
<span class="token keyword">import</span> path <span class="token keyword">from</span> <span class="token string">'path'</span>

<span class="token keyword">const</span> storePath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'./store.json'</span><span class="token punctuation">)</span>

<span class="token keyword">function</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> store <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readFileSync</span><span class="token punctuation">(</span>storePath<span class="token punctuation">,</span> <span class="token string">'utf-8'</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>store<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token keyword">export</span> <span class="token keyword">let</span> <span class="token punctuation">{</span>restTime<span class="token punctuation">,</span> tipsTime<span class="token punctuation">,</span> workTime<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">setTime</span><span class="token punctuation">(</span><span class="token parameter">rest<span class="token operator">:</span> number<span class="token punctuation">,</span> work<span class="token operator">:</span> number<span class="token punctuation">,</span> tips<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  restTime <span class="token operator">=</span> rest
  tipsTime <span class="token operator">=</span> tips
  workTime <span class="token operator">=</span> work
  fs<span class="token punctuation">.</span><span class="token function">writeFileSync</span><span class="token punctuation">(</span>storePath<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span><span class="token punctuation">{</span>restTime<span class="token punctuation">,</span> tipsTime<span class="token punctuation">,</span> workTime<span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>逻辑：从本地文件中获取工作、休息、提示时间，当设置新的时间时再改写本地文件</p> <h4 id="设置窗口"><a href="#设置窗口" class="header-anchor">#</a> 设置窗口</h4> <p>完善托盘栏菜单项的代码</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">interface</span> <span class="token class-name">SettingMsgData</span> <span class="token punctuation">{</span>
  rest<span class="token operator">:</span> number
  work<span class="token operator">:</span> number
  tips<span class="token operator">:</span> number
<span class="token punctuation">}</span>
Menu<span class="token punctuation">.</span><span class="token function">buildFromTemplate</span><span class="token punctuation">(</span><span class="token punctuation">[</span>
  <span class="token punctuation">{</span>
    label<span class="token operator">:</span> <span class="token string">'偏好设置'</span><span class="token punctuation">,</span>
    accelerator<span class="token operator">:</span> <span class="token string">'CmdOrCtrl+,'</span><span class="token punctuation">,</span>
    <span class="token function-variable function">click</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> win <span class="token operator">=</span> <span class="token function">createSettingWindows</span><span class="token punctuation">(</span>restTime<span class="token punctuation">,</span> tipsTime<span class="token punctuation">,</span> workTime<span class="token punctuation">)</span>
      <span class="token keyword">const</span> <span class="token function-variable function">handleSettingMsg</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">event<span class="token operator">:</span> IpcMainEvent<span class="token punctuation">,</span> <span class="token punctuation">{</span>rest<span class="token punctuation">,</span> work<span class="token punctuation">,</span> tips<span class="token punctuation">}</span><span class="token operator">:</span> SettingMsgData</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">setTime</span><span class="token punctuation">(</span>rest<span class="token punctuation">,</span> work<span class="token punctuation">,</span> tips<span class="token punctuation">)</span>
        win<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      win<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'close'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        ipcMain<span class="token punctuation">.</span><span class="token function">removeListener</span><span class="token punctuation">(</span><span class="token constant">SETTING_MESSAGE</span><span class="token punctuation">,</span> handleSettingMsg<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      ipcMain<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token constant">SETTING_MESSAGE</span><span class="token punctuation">,</span> handleSettingMsg<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">]</span><span class="token punctuation">)</span>
</code></pre></div><p>当我们点击设置菜单项时</p> <ol><li>创建一个设置窗口</li> <li>监听设置窗口发送来的消息</li> <li>当设置窗口关闭时移除消息监听</li></ol> <p>而设置窗口发消息的时机就是当用户点击保存的时候，此时会把设置之后的工作时间、休息时间、提示时间传过来。我们设置到本地即可</p> <p>下面我们看一下创建窗口和渲染进程的逻辑</p> <p>main/browserWindow.ts</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">function</span> <span class="token function">createSettingWindows</span><span class="token punctuation">(</span><span class="token parameter">restTime<span class="token operator">:</span> number<span class="token punctuation">,</span> tipsTime<span class="token operator">:</span> number<span class="token punctuation">,</span> workTime<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> win <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BrowserWindow</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    maximizable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    minimizable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    resizable<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
    webPreferences<span class="token operator">:</span> <span class="token punctuation">{</span>
      webSecurity<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
      nodeIntegration<span class="token operator">:</span> <span class="token boolean">true</span> <span class="token comment">// 将node注入到渲染进程</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  win<span class="token punctuation">.</span><span class="token function">loadURL</span><span class="token punctuation">(</span><span class="token function">resolveUrl</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">/Setting?type=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span><span class="token constant">SETTING_MESSAGE</span><span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;rest=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>restTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;tips=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>tipsTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&amp;work=</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>workTime<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token keyword">return</span> win
<span class="token punctuation">}</span>
</code></pre></div><p>vue: views/setting.vue</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
  <span class="token function">setup</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span>query<span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">useRoute</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> rest <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token operator">+</span>query<span class="token punctuation">.</span>rest <span class="token operator">/</span> <span class="token constant">MINUTES</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> work <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token operator">+</span>query<span class="token punctuation">.</span>work <span class="token operator">/</span> <span class="token constant">MINUTES</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> tips <span class="token operator">=</span> <span class="token function">ref</span><span class="token punctuation">(</span><span class="token operator">+</span>query<span class="token punctuation">.</span>tips <span class="token operator">/</span> <span class="token constant">SECONDS</span><span class="token punctuation">)</span>
    <span class="token keyword">const</span> <span class="token function-variable function">save</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      ipcRenderer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span>query<span class="token punctuation">.</span>type<span class="token punctuation">,</span> <span class="token punctuation">{</span>
        rest<span class="token operator">:</span> rest<span class="token punctuation">.</span>value <span class="token operator">*</span> <span class="token constant">MINUTES</span><span class="token punctuation">,</span>
        work<span class="token operator">:</span> work<span class="token punctuation">.</span>value <span class="token operator">*</span> <span class="token constant">MINUTES</span><span class="token punctuation">,</span>
        tips<span class="token operator">:</span> tips<span class="token punctuation">.</span>value <span class="token operator">*</span> <span class="token constant">SECONDS</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">const</span> <span class="token function-variable function">reset</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      rest<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token operator">+</span>query<span class="token punctuation">.</span>rest <span class="token operator">/</span> <span class="token constant">MINUTES</span>
      work<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token operator">+</span>query<span class="token punctuation">.</span>work <span class="token operator">/</span> <span class="token constant">MINUTES</span>
      tips<span class="token punctuation">.</span>value <span class="token operator">=</span> <span class="token operator">+</span>query<span class="token punctuation">.</span>tips <span class="token operator">/</span> <span class="token constant">SECONDS</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> <span class="token punctuation">{</span>
      rest<span class="token punctuation">,</span>
      work<span class="token punctuation">,</span>
      tips<span class="token punctuation">,</span>
      save<span class="token punctuation">,</span>
      reset
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>好了，至此我们的代码已经完全实现了。</p> <p>但是现在还有一个点需要解决，那就是电脑休眠时，我们应该让计时功能暂停。</p> <p>我们在<code>main/index.ts</code>中修改如下代码</p> <div class="language-js extra-class"><div class="highlight-lines"><br><br><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><div class="highlighted"> </div><br><br></div><pre class="language-js"><code>app<span class="token punctuation">.</span><span class="token function">whenReady</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> tray <span class="token operator">=</span> <span class="token function">initTray</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
  <span class="token comment">// 系统挂起</span>
  powerMonitor<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'suspend'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    tray<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'stop'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token comment">// 系统恢复</span>
  powerMonitor<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'resume'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    tray<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">'run'</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>好了，就是监听两个事件的事～ 都是些api，就不多说了。</p> <p>接下来我们打包一下electorn，让我们的代码可以在电脑上安装。</p> <h2 id="项目打包"><a href="#项目打包" class="header-anchor">#</a> 项目打包</h2> <p>项目打包主流的方式有两种：<code>electron-builder</code>和<code>electron-packager</code></p> <p><code>electron-builder</code>会把项目打成安装包，就是我们平时安装软件的那种形式。</p> <p><code>electron-packager</code>会把项目打包成可执行文件，你可以理解为上面👆的安装包安装之后的软件目录。</p> <p>下面我们分别介绍一下这两种的打包步骤（这里只打包了mac版本，win版本可自行查阅官网，差别不大）</p> <h3 id="electron-builder打包"><a href="#electron-builder打包" class="header-anchor">#</a> <code>electron-builder</code>打包</h3> <p>安装</p> <div class="language-sh extra-class"><pre class="language-sh"><code>cnpm i electron-builder --save-dev
</code></pre></div><p><code>package.json</code>新增<code>build</code>项</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;build&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// 软件的唯一id</span>
  <span class="token property">&quot;appId&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rest.time.lay4519&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 软件的名称</span>
  <span class="token property">&quot;productName&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Lay&quot;</span><span class="token punctuation">,</span>
  <span class="token comment">// 要打包的文件</span>
  <span class="token property">&quot;files&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token string">&quot;node_modules/&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;dist/&quot;</span><span class="token punctuation">,</span>
    <span class="token string">&quot;package.json&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token comment">// 打包成mac 安装包</span>
  <span class="token property">&quot;dmg&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;contents&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">130</span><span class="token punctuation">,</span>
        <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">220</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        <span class="token property">&quot;x&quot;</span><span class="token operator">:</span> <span class="token number">410</span><span class="token punctuation">,</span>
        <span class="token property">&quot;y&quot;</span><span class="token operator">:</span> <span class="token number">220</span><span class="token punctuation">,</span>
        <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;link&quot;</span><span class="token punctuation">,</span>
        <span class="token property">&quot;path&quot;</span><span class="token operator">:</span> <span class="token string">&quot;/Applications&quot;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">]</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token comment">// 设置打包目录</span>
  <span class="token property">&quot;directories&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;output&quot;</span><span class="token operator">:</span> <span class="token string">&quot;release&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>增加脚本</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;buildMac&quot;</span><span class="token operator">:</span> <span class="token string">&quot;cp -r icon dist/icon &amp;&amp; npx electron-builder --mac --arm64&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="electron-packager打包"><a href="#electron-packager打包" class="header-anchor">#</a> <code>electron-packager</code>打包</h3> <p>增加脚本</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
  <span class="token comment">// ...</span>
  <span class="token property">&quot;packageMac&quot;</span><span class="token operator">:</span> <span class="token string">&quot;rm -rf ./dist &amp;&amp; npx vite build &amp;&amp; tsc &amp;&amp; cp -r icon dist/icon &amp; cp main/store.json dist/main/store.json &amp;&amp; electron-packager . --overwrite&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个大概解释一下</p> <ol><li>清空dist目录</li> <li>使用vite build渲染进程代码</li> <li>tsc编译主进程代码</li> <li>拷贝icon文件夹、main/store.json</li> <li>electron-packager 打包当前文件夹</li></ol> <p>好了，打包已经完成了。但是你以为到此就结束了吗？</p> <p>点开vite打包后的index.html，你会发现script标签上有一个<code>type=&quot;module&quot;</code>，这意味着vite默认打包后，还是使用了es6的模块机制，这个机制依赖了http，所以我们无法使用<code>file</code>协议来加载文件。</p> <p>也就是说，这个html我们双击打开是无法运行的，所以你在electron里直接loadFile也是无法运行的。</p> <p>怎么解决呢？也许vite可以配置CMD、AMD的模块机制，但是我也懒得再去翻阅文档了。反正是用的electron，我们直接在本地起一个http服务就是</p> <p>main/browserWindow.ts</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">const</span> productPort <span class="token operator">=</span> <span class="token number">0</span>
<span class="token keyword">const</span> <span class="token function-variable function">resolveUrl</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">address<span class="token operator">:</span> string</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">http://localhost:</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>isDev <span class="token operator">?</span> <span class="token number">3000</span> <span class="token operator">:</span> productPort<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/#</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>address<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>

<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isDev<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">// 检测端口是否被占用</span>
  <span class="token keyword">const</span> portIsOccupied <span class="token operator">=</span> <span class="token punctuation">(</span>port<span class="token operator">:</span> number<span class="token punctuation">)</span><span class="token operator">:</span> Promise<span class="token operator">&lt;</span>number<span class="token operator">&gt;</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token parameter">r</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token function-variable function">validate</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">p<span class="token operator">:</span> number</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">const</span> server<span class="token operator">:</span> http<span class="token punctuation">.</span>Server <span class="token operator">=</span> http
          <span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'listening'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token function">r</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
          <span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'error'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token operator">:</span> any</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'EADDRINUSE'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              server<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
              <span class="token function">validate</span><span class="token punctuation">(</span>p <span class="token operator">+=</span> <span class="token number">1</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token function">validate</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 执行</span>
  <span class="token function">portIsOccupied</span><span class="token punctuation">(</span><span class="token number">8981</span><span class="token punctuation">)</span>
    <span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">p</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      productPort <span class="token operator">=</span> p
      http<span class="token punctuation">.</span><span class="token function">createServer</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter">req<span class="token punctuation">,</span> res</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url <span class="token operator">===</span> <span class="token string">'/'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">// content-type: application/javascript</span>
          <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'renderer/index.html'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span>
            res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/html; charset=utf-8'</span><span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span> fs<span class="token punctuation">.</span><span class="token function">readFile</span><span class="token punctuation">(</span>path<span class="token punctuation">.</span><span class="token function">resolve</span><span class="token punctuation">(</span>__dirname<span class="token punctuation">,</span> <span class="token string">'..'</span><span class="token punctuation">,</span> <span class="token string">'renderer'</span> <span class="token operator">+</span> req<span class="token punctuation">.</span>url<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">err<span class="token punctuation">,</span> data</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token keyword">return</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.js'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'application/javascript'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span>req<span class="token punctuation">.</span>url<span class="token operator">!</span><span class="token punctuation">.</span><span class="token function">endsWith</span><span class="token punctuation">(</span><span class="token string">'.css'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'content-type'</span><span class="token punctuation">,</span> <span class="token string">'text/css'</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 缓存7天</span>
            res<span class="token punctuation">.</span><span class="token function">setHeader</span><span class="token punctuation">(</span><span class="token string">'cache-control'</span><span class="token punctuation">,</span> <span class="token string">'max-age=604800'</span><span class="token punctuation">)</span>
            res<span class="token punctuation">.</span><span class="token function">end</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>好啦，这下我们就真正的把代码完成了～</p> <p><a href="https://github.com/lei4519/remind-rest" target="_blank" rel="noopener noreferrer">完整代码点此<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，觉得文章还可以的欢迎star、following。</p> <p>如果有什么问题欢迎在评论区提出讨论。感谢观看🙏</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lei4519/blog/edit/master/src/practice/Vue/vue3-rest.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">最后更新时间:</span> <span class="time">几秒前</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/practice/Blog/vuepress.html" class="prev">
        Vuepress博客搭建
      </a></span> <!----></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.366a5dbf.js" defer></script><script src="/blog/assets/js/3.7fd611cf.js" defer></script><script src="/blog/assets/js/4.69713668.js" defer></script>
  </body>
</html>

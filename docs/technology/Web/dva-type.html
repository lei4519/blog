<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.27">
    <title>玩转 TS - 实现 dva 的完整类型推导 | Lay</title><meta name="description" content="Lay 的博客">
    <link rel="preload" href="/blog/assets/js/runtime~app.2e4dfdc6.js" as="script"><link rel="preload" href="/blog/assets/css/styles.f43781c5.css" as="style"><link rel="preload" href="/blog/assets/js/812.1515477b.js" as="script"><link rel="preload" href="/blog/assets/js/app.b3de0ea5.js" as="script">
    <link rel="stylesheet" href="/blog/assets/css/styles.f43781c5.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/blog/" class=""><!----><span class="site-name">Lay</span></a></span><div class="navbar-links-wrapper" style=""><!--[--><!--]--><nav class="navbar-links can-hide"><!--[--><div class="navbar-links-item"><a href="/blog/" class="nav-link" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/technology/BE/Java 笔记.md" class="nav-link router-link-active" aria-label="技术分享"><!--[--><!--]--> 技术分享 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/practice/Blog/vuepress.md" class="nav-link" aria-label="实战分享"><!--[--><!--]--> 实战分享 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/notes/Mac/tmux-key.md" class="nav-link" aria-label="烂笔头"><!--[--><!--]--> 烂笔头 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/lei4519/blog" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><!----></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-links"><!--[--><div class="navbar-links-item"><a href="/blog/" class="nav-link" aria-label="Home"><!--[--><!--]--> Home <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/technology/BE/Java 笔记.md" class="nav-link router-link-active" aria-label="技术分享"><!--[--><!--]--> 技术分享 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/practice/Blog/vuepress.md" class="nav-link" aria-label="实战分享"><!--[--><!--]--> 实战分享 <!--[--><!--]--></a></div><div class="navbar-links-item"><a href="/blog/notes/Mac/tmux-key.md" class="nav-link" aria-label="烂笔头"><!--[--><!--]--> 烂笔头 <!--[--><!--]--></a></div><div class="navbar-links-item"><a class="nav-link external" href="https://github.com/lei4519/blog" rel="noopener noreferrer" target="_blank" aria-label="GitHub"><!--[--><!--]--> GitHub <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-links"><!--[--><!--[--><p class="sidebar-heading sidebar-item">BE</p><ul class=""><li><!--[--><a href="/blog/technology/BE/Java%20%E7%AC%94%E8%AE%B0.html" class="nav-link sidebar-item" aria-label="Java"><!--[--><!--]--> Java <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/technology/BE/MySQL%20%E7%AC%94%E8%AE%B0.html" class="nav-link sidebar-item" aria-label="MySQL"><!--[--><!--]--> MySQL <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Chrome</p><ul class=""><li><!--[--><a href="/blog/technology/Chrome/chrome-ext.html" class="nav-link sidebar-item" aria-label="使用 Umi 开发 Chrome 扩展"><!--[--><!--]--> 使用 Umi 开发 Chrome 扩展 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Electron</p><ul class=""><li><!--[--><a href="/blog/technology/Electron/ipc.html" class="nav-link sidebar-item" aria-label="Electron 进程通信"><!--[--><!--]--> Electron 进程通信 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Git</p><ul class=""><li><!--[--><a href="/blog/technology/Git/Git%20book%20%E7%AC%94%E8%AE%B0.html" class="nav-link sidebar-item" aria-label="Git Book 笔记"><!--[--><!--]--> Git Book 笔记 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">HTTP</p><ul class=""><li><!--[--><a href="/blog/technology/HTTP/http2.html" class="nav-link sidebar-item" aria-label="HTTP 2"><!--[--><!--]--> HTTP 2 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">MiniProgram</p><ul class=""><li><!--[--><a href="/blog/technology/MiniProgram/framework.html" class="nav-link sidebar-item" aria-label="给原生小程序安排上Composition API"><!--[--><!--]--> 给原生小程序安排上Composition API <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/technology/MiniProgram/framework-theory.html" class="nav-link sidebar-item" aria-label="小程序框架原理总结"><!--[--><!--]--> 小程序框架原理总结 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item">Node</p><ul class=""><li><!--[--><a href="/blog/technology/Node/child_process-spawn.html" class="nav-link sidebar-item" aria-label="child_process spawn模块详解"><!--[--><!--]--> child_process spawn模块详解 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--[--><p class="sidebar-heading sidebar-item active">Web</p><ul class=""><li><!--[--><a href="/blog/technology/Web/mf.html" class="nav-link sidebar-item" aria-label="模块联邦微前端思考"><!--[--><!--]--> 模块联邦微前端思考 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/technology/Web/react-render.html" class="nav-link sidebar-item" aria-label="React渲染流程"><!--[--><!--]--> React渲染流程 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/technology/Web/stream-save.html" class="nav-link sidebar-item" aria-label="JS 实现流式打包下载"><!--[--><!--]--> JS 实现流式打包下载 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/technology/Web/dva-type.html" class="router-link-active router-link-exact-active nav-link router-link-active sidebar-item active" aria-label="玩转 TS - 实现 dva 的完整类型推导"><!--[--><!--]--> 玩转 TS - 实现 dva 的完整类型推导 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/blog/technology/Web/dva-type.html#前言" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="前言"><!--[--><!--]--> 前言 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/technology/Web/dva-type.html#dva-基本使用" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="dva 基本使用"><!--[--><!--]--> dva 基本使用 <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/blog/technology/Web/dva-type.html#model-定义" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="Model 定义"><!--[--><!--]--> Model 定义 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/technology/Web/dva-type.html#基本使用" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="基本使用"><!--[--><!--]--> 基本使用 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blog/technology/Web/dva-type.html#dva-type" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="dva-type"><!--[--><!--]--> dva-type <!--[--><!--]--></a><ul class="sidebar-sub-items"><li><!--[--><a aria-current="page" href="/blog/technology/Web/dva-type.html#dva-type-使用" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="dva-type 使用"><!--[--><!--]--> dva-type 使用 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a aria-current="page" href="/blog/technology/Web/dva-type.html#dva-type-源码解析" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="dva-type 源码解析"><!--[--><!--]--> dva-type 源码解析 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a aria-current="page" href="/blog/technology/Web/dva-type.html#end" class="router-link-active router-link-exact-active nav-link sidebar-item" aria-label="End"><!--[--><!--]--> End <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--></li><li><!--[--><a href="/blog/technology/Web/rxjs-operate.html" class="nav-link sidebar-item" aria-label="Rxjs 操作符快速入门"><!--[--><!--]--> Rxjs 操作符快速入门 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/technology/Web/regexp.html" class="nav-link sidebar-item" aria-label="正则"><!--[--><!--]--> 正则 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/technology/Web/event-loop.html" class="nav-link sidebar-item" aria-label="事件循环 - JS是怎么运行的？"><!--[--><!--]--> 事件循环 - JS是怎么运行的？ <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/technology/Web/lazy-img.html" class="nav-link sidebar-item" aria-label="使用IntersectionObserver实现图片懒加载"><!--[--><!--]--> 使用IntersectionObserver实现图片懒加载 <!--[--><!--]--></a><!----><!--]--></li><li><!--[--><a href="/blog/technology/Web/adaptive-fontsize.html" class="nav-link sidebar-item" aria-label="pc端 rem布局 非chrome浏览器字号小于12px的解决方案"><!--[--><!--]--> pc端 rem布局 非chrome浏览器字号小于12px的解决方案 <!--[--><!--]--></a><!----><!--]--></li></ul><!--]--><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="玩转-ts-实现-dva-的完整类型推导" tabindex="-1"><a class="header-anchor" href="#玩转-ts-实现-dva-的完整类型推导" aria-hidden="true">#</a> 玩转 TS - 实现 dva 的完整类型推导</h1><h2 id="前言" tabindex="-1"><a class="header-anchor" href="#前言" aria-hidden="true">#</a> 前言</h2><p>在 TypeScript 4.1 来临之前，对于像 <code>dva</code>、 <code>vuex</code> 这种需要在触发时写入命名空间的函数，我们无奈的只能使用 <code>any</code> 对其进行类型定义。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&#39;users/getUser&#39;</span><span class="token punctuation">,</span>
  payload<span class="token operator">:</span> <span class="token string">&#39;...&#39;</span><span class="token punctuation">,</span> <span class="token comment">// any</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>这使得项目中本应良好的 <code>TS</code> 类型推导出现了断层，社区中也有相关的解决方案，但都是通过更加复杂类型、函数封装进而实现的，与官方写法大相径庭。</p><p>好在，TypeScript 4.1 带来了 <a href="https://www.typescriptlang.org/docs/handbook/release-notes/typescript-4-1.html" target="_blank" rel="noopener noreferrer">Template Literal Types<span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span></a> 特性，是我们可以对类型进行字符串拼接操作，从而使得此类函数的类型推导称为现实。</p><p>本文将带你一一讲解具体的推导过程，希望看完之后会有收获。</p><p>同时，本文的最终实现已经发布了 <code>npm</code> 包：<code>dva-type</code>，可以在项目中直接安装使用。</p><h2 id="dva-基本使用" tabindex="-1"><a class="header-anchor" href="#dva-基本使用" aria-hidden="true">#</a> dva 基本使用</h2><p>写代码之前先让我们回顾一下 dva 的基本使用，也好让我们知道自己最终要实现什么。</p><h3 id="model-定义" tabindex="-1"><a class="header-anchor" href="#model-定义" aria-hidden="true">#</a> Model 定义</h3><p><code>dva</code> 中通过定义 <code>model</code> 来声明各模块的状态，其中 <code>reducers</code> 就是 <code>redux</code> 的 <code>reducers</code> ，<code>effects</code> 就是用来执行异步操作的地方，在 <code>effect</code> 中最终也会通过 <code>reducers</code> 将状态更新到 <code>state</code> 中。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code>cosnt model <span class="token operator">=</span> <span class="token punctuation">{</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
  effects<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  reducers<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token function">merge</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><h3 id="基本使用" tabindex="-1"><a class="header-anchor" href="#基本使用" aria-hidden="true">#</a> 基本使用</h3><p>使用方法同 <code>redux</code></p><ul><li>使用 <code>connect</code> 高阶函数或者 <code>useSelector</code> 来获取 <code>state</code></li><li>使用 <code>connect</code> 或者 <code>useDispatch</code> 拿到 <code>dispatch</code> 函数</li></ul><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token function">connect</span><span class="token punctuation">(</span>state <span class="token operator">=&gt;</span> <span class="token punctuation">(</span><span class="token punctuation">{</span>
  userInfo<span class="token operator">:</span> state<span class="token punctuation">.</span>users<span class="token punctuation">.</span>info<span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span>

<span class="token comment">// 类型断层</span>
<span class="token function">dispatch</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token string">&#39;users/getUser&#39;</span><span class="token punctuation">,</span>
  payload<span class="token operator">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p>类型断层主要在于 <code>dispatch</code> 时的 <code>action</code> 类型无法推导，<code>state</code> 的类型提示则没有问题，而 <code>action</code> 之所以会失效主要在于参数 <code>type</code> 需要拼接命名空间。</p><p>所以我们要解决的其实就是拼接命名空间之后的类型提示和推导，而这在 Template Literal Types 特性出现之后，就使得解决方案变得异常简单与自然。</p><h2 id="dva-type" tabindex="-1"><a class="header-anchor" href="#dva-type" aria-hidden="true">#</a> dva-type</h2><p>开始 <code>dva-type</code> 的源码解析之前，先看一下它是如何使用的</p><h3 id="dva-type-使用" tabindex="-1"><a class="header-anchor" href="#dva-type-使用" aria-hidden="true">#</a> dva-type 使用</h3><ol><li><p>定义单个 <code>Model</code> 类型（注意 <code>Model</code>、<code>Effect</code> 不是从 <code>dva</code> 中导入的）</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> Effect<span class="token punctuation">,</span> Model <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;dva-type&#39;</span>

<span class="token keyword">interface</span> <span class="token class-name">ListModel</span> <span class="token keyword">extends</span> <span class="token class-name">Model</span> <span class="token punctuation">{</span>
  state<span class="token operator">:</span> <span class="token punctuation">{</span>
    list<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">[</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
  effects<span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token comment">// 定义effect 传入 payload 类型</span>
    getList<span class="token operator">:</span> Effect<span class="token operator">&lt;</span><span class="token builtin">number</span><span class="token operator">&gt;</span>

    <span class="token comment">// 不需要 payload 的 effect</span>
    getInfo<span class="token operator">:</span> Effect
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div></li><li><p>定义项目中所有 <code>Model</code> 的集合（<strong>使用 <code>type</code> 而不是 <code>interface</code></strong>）</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// 使用 type 定义 models，将项目中的所有 model 进行收集</span>
<span class="token keyword">type</span> <span class="token class-name">Models</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
  list<span class="token operator">:</span> ListModel
  info<span class="token operator">:</span> InfoModel
  <span class="token comment">// ...</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div></li><li><p>将 <code>Models</code> 传入 <code>ResolverModels</code> 获取 <code>state</code> 和 <code>actions</code> 的类型</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">import</span> <span class="token punctuation">{</span> ResolverModels <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&#39;dva-type&#39;</span>

<span class="token keyword">type</span> <span class="token class-name">State</span> <span class="token operator">=</span> ResolverModels<span class="token operator">&lt;</span>Models<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">]</span>
<span class="token keyword">type</span> <span class="token class-name">Actions</span> <span class="token operator">=</span> ResolverModels<span class="token operator">&lt;</span>Models<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">&#39;actions&#39;</span><span class="token punctuation">]</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>使用</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token comment">// hooks</span>
<span class="token generic-function"><span class="token function">useSelector</span><span class="token generic class-name"><span class="token operator">&lt;</span>State<span class="token operator">&gt;</span></span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token keyword">const</span> dispatch <span class="token operator">=</span> useDispatch<span class="token operator">&lt;</span><span class="token punctuation">(</span>action<span class="token operator">:</span> Actions<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token comment">// class</span>
<span class="token class-name"><span class="token keyword">const</span></span> <span class="token function-variable function">mapStateToProps</span> <span class="token operator">=</span> <span class="token punctuation">(</span>state<span class="token operator">:</span> State<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token keyword">interface</span> <span class="token class-name">Props</span> <span class="token punctuation">{</span>
  <span class="token function-variable function">dispatch</span><span class="token operator">:</span> <span class="token punctuation">(</span>action<span class="token operator">:</span> Actions<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token builtin">any</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div></li></ol><h3 id="dva-type-源码解析" tabindex="-1"><a class="header-anchor" href="#dva-type-源码解析" aria-hidden="true">#</a> dva-type 源码解析</h3><p>从上面的使用中可以看到，一切的秘密都在 <code>ResolverModels</code> 这个类型中，下面我们就看看其实现</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">ResolverModels<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Model<span class="token operator">&gt;&gt;</span></span> <span class="token punctuation">{</span>
  state<span class="token operator">:</span> ResolverState<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">&amp;</span> Loading<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
  actions<span class="token operator">:</span> ResolverReducers<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span> <span class="token operator">|</span> ResolverEffects<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h4 id="提取-state" tabindex="-1"><a class="header-anchor" href="#提取-state" aria-hidden="true">#</a> 提取 State</h4><p><code>state</code> 的解析很简单，使用 <code>keyof</code> 遍历 <code>models</code> 的 <code>state</code> 定义即可。</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">type</span> <span class="token class-name">ResolverState<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Model<span class="token operator">&gt;&gt;</span></span> <span class="token operator">=</span> UnionToIntersection<span class="token operator">&lt;</span>
  <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>k <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;state&#39;</span><span class="token punctuation">]</span>
  <span class="token punctuation">}</span>
<span class="token operator">&gt;</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>这是基本操作，让我们大致过一下这个过程发生了什么</p><ol><li><code>T</code> 是我们传入的 <code>Models</code> 类型定义</li><li><code>[k in keyof T]</code> 相当于遍历了 <code>T</code> 的键：<code>list</code>、<code>info</code></li><li><code>T[k][&#39;state&#39;]</code> 相当于：<code>T[&#39;list&#39;][&#39;state’]</code>、<code>T[&#39;info&#39;][&#39;state’]</code></li></ol><p>这样就把 <code>state</code> 的类型给推导出来了，但是推导出来的类型是联合类型，我们还需要将其转换为交叉类型才能正确进行类型提示。</p><h5 id="联合类型转换交叉类型" tabindex="-1"><a class="header-anchor" href="#联合类型转换交叉类型" aria-hidden="true">#</a> 联合类型转换交叉类型</h5><p>而将联合转换为交叉类型则是网上找到的黑魔法：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">type</span> <span class="token class-name">UnionToIntersection<span class="token operator">&lt;</span><span class="token constant">U</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span>
  <span class="token punctuation">(</span><span class="token constant">U</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token builtin">any</span></span> <span class="token operator">?</span> <span class="token punctuation">(</span>k<span class="token operator">:</span> <span class="token constant">U</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span> <span class="token operator">:</span> <span class="token builtin">never</span><span class="token punctuation">)</span>
    <span class="token keyword">extends</span> <span class="token punctuation">(</span>k<span class="token operator">:</span> <span class="token keyword">infer</span> <span class="token constant">I</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
    <span class="token operator">?</span> <span class="token constant">I</span>
    <span class="token operator">:</span> <span class="token builtin">never</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><p>具体的深层原理我也没有搞懂，但是可以看一下具体做了那些事情：</p><ol><li><code>U extends any ? (k: U) =&gt; void : never</code><ul><li><code>extends any</code> 这个条件永远是 <code>true</code> ，所以这里就是把传入的类型 <code>U</code> 变为了 函数类型：<code>(k: U) =&gt; void</code></li></ul></li><li><code>extends (k: infer I) =&gt; void</code><ul><li>第一步我们把类型变为了 <code>(k: U) =&gt; void</code> ，所以这里的 <code>extends</code> 的判断结果肯定也是 <code>true</code> 。</li><li>注意 <code>infer I</code> ，这将类型 <code>U</code> 重新做了推断，就是这一步使联合类型变为了交叉类型。</li></ul></li><li><code>? I : never</code><ul><li>很明显，根据第一个和第二步，这里的三元表达式永远都会返回 <code>I</code> 。</li><li>至此，联合类型被转换为了交叉类型。</li></ul></li></ol><h4 id="提取-actions" tabindex="-1"><a class="header-anchor" href="#提取-actions" aria-hidden="true">#</a> 提取 Actions</h4><p><code>dva</code> 提供的 <code>Effect</code> 类型不能传入 <code>payload</code> 的类型定义，所以这里我们需要封装一个 <code>Effect</code> 出来：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">type</span> <span class="token class-name">Effect<span class="token operator">&lt;</span><span class="token constant">P</span> <span class="token operator">=</span> <span class="token keyword">undefined</span><span class="token operator">&gt;</span></span> <span class="token operator">=</span> <span class="token punctuation">(</span>
  action<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span> payload<span class="token operator">?</span><span class="token operator">:</span> <span class="token constant">P</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
  effect<span class="token operator">:</span> EffectsCommandMap
<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><h5 id="解析-effects-类型" tabindex="-1"><a class="header-anchor" href="#解析-effects-类型" aria-hidden="true">#</a> 解析 <code>effects</code> 类型</h5><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">type</span> <span class="token class-name">ResolverEffects<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Model<span class="token operator">&gt;&gt;</span></span> <span class="token operator">=</span> ValueType<span class="token operator">&lt;</span>
  <span class="token punctuation">{</span>
    <span class="token punctuation">[</span>t <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">:</span> ValueType<span class="token operator">&lt;</span>
      <span class="token punctuation">{</span>
        <span class="token punctuation">[</span>k <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;effects&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token constant">T</span><span class="token punctuation">[</span>t<span class="token punctuation">]</span><span class="token punctuation">[</span><span class="token string">&#39;effects&#39;</span><span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span> <span class="token keyword">extends</span> <span class="token punctuation">(</span>
          action<span class="token operator">:</span> <span class="token punctuation">{</span> type<span class="token operator">:</span> <span class="token builtin">any</span><span class="token punctuation">;</span> payload<span class="token operator">?</span><span class="token operator">:</span> <span class="token keyword">infer</span> <span class="token constant">A</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
          effect<span class="token operator">:</span> EffectsCommandMap
        <span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token keyword">void</span>
          <span class="token operator">?</span> <span class="token constant">A</span> <span class="token keyword">extends</span> <span class="token class-name"><span class="token keyword">undefined</span></span>
            <span class="token operator">?</span> <span class="token punctuation">{</span>
                type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>t<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                <span class="token punctuation">[</span>k<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span>
              <span class="token punctuation">}</span>
            <span class="token operator">:</span> <span class="token punctuation">{</span>
                type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>t<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
                payload<span class="token operator">:</span> <span class="token constant">A</span>
                <span class="token punctuation">[</span>k<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">any</span>
              <span class="token punctuation">}</span>
          <span class="token operator">:</span> <span class="token builtin">never</span>
      <span class="token punctuation">}</span>
    <span class="token operator">&gt;</span>
  <span class="token punctuation">}</span>
<span class="token operator">&gt;</span>

</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>代码一大坨，按流程走一遍：</p><ol><li><p><code>T</code> 依然是传入的 <code>Models</code> 类型</p></li><li><p><code>[t in keyof T]</code> 同 <code>state</code> ，不再赘述。</p></li><li><p><code>[k in keyof T[t][&#39;effects&#39;]]</code>，这一步就是将每个 <code>model</code> 中定义的 <code>effect</code> 进行了遍历，相当于：<code>Models[&#39;list&#39;][&#39;effects&#39;][&#39;getList’]</code>、<code>Models[&#39;info&#39;][&#39;effects&#39;][&#39;getInfo’]</code></p></li><li><p><code>T[t][&#39;effects&#39;][k] extends (action: { type: any; payload?: infer A },effect: EffectsCommandMap) =&gt; void</code></p><ul><li><p><code>extends</code> 后面的函数类型与我们定义的 <code>Effect</code> 类型一致</p></li><li><p>注意 <code>extends ... payload?: infer A …</code>， 这里将 <code>payload</code> 的类型提取了出来</p></li></ul></li><li><p><code>A extends undefined</code> ，这一步是为了判断 <code>effect</code> 是否需要传入 <code>payload</code>，如果不需要则不需要在类型中体现</p></li><li><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token punctuation">{</span>
  type<span class="token operator">:</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>t<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>k<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span>
  payload<span class="token operator">:</span> <span class="token constant">A</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><ol><li><code>payload: A</code> 这个就是将推导出来的类型又赋值回去了</li><li>type: ${t}/${k}，其中 <code>t</code> 表示了命名空间，<code>k</code> 表示了 <code>effect</code> 的名称：<code>type: &#39;list/getList&#39;</code></li></ol></li><li><p>至此，类型已经推导出来了，但是格式却不是我们想要的：</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token punctuation">{</span>
  list<span class="token operator">:</span> <span class="token punctuation">{</span>
    getList<span class="token operator">:</span> <span class="token punctuation">{</span>
      type<span class="token operator">:</span> <span class="token string">&#39;list/getList&#39;</span><span class="token punctuation">,</span>
      payload<span class="token operator">:</span> <span class="token builtin">number</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div></li><li><p>我们只想要最里面的 <code>{type: .. payload ..}</code> 部分，所以这里要做的就是将 <code>value</code> 的类型提取出来，做法也非常简单：<code>T[keyof T]</code>，遍历并访问类型的键就可以将值类型全部取出。</p></li><li><p>将其简单封装，就是最外层的 <code>ValueType</code> 的作用了。</p></li></ol><p><code>effects</code> 的类型提取出来了，<code>reducers</code> 也是同样的做法，就不赘述了。</p><h4 id="dva-loading-类型" tabindex="-1"><a class="header-anchor" href="#dva-loading-类型" aria-hidden="true">#</a> dva-loading 类型</h4><p><code>dva-loading</code> 中可以根据<code>effects</code> 提供 <code>loading</code> 变量，我们解析了 <code>effects</code> 之后，<code>loading</code> 的变量提示也是顺其自然了</p><div class="language-typescript ext-ts line-numbers-mode"><pre class="language-typescript"><code><span class="token keyword">interface</span> <span class="token class-name">Loading<span class="token operator">&lt;</span><span class="token constant">T</span> <span class="token keyword">extends</span> Record<span class="token operator">&lt;</span><span class="token builtin">string</span><span class="token punctuation">,</span> Model<span class="token operator">&gt;&gt;</span></span> <span class="token punctuation">{</span>
  loading<span class="token operator">:</span> <span class="token punctuation">{</span>
    global<span class="token operator">:</span> <span class="token builtin">boolean</span>
    models<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>k <span class="token keyword">in</span> <span class="token keyword">keyof</span> <span class="token constant">T</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
    <span class="token punctuation">}</span>
    effects<span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token punctuation">[</span>k <span class="token keyword">in</span> ResolverEffects<span class="token operator">&lt;</span><span class="token constant">T</span><span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token string">&#39;type&#39;</span><span class="token punctuation">]</span><span class="token punctuation">]</span><span class="token operator">:</span> <span class="token builtin">boolean</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><h2 id="end" tabindex="-1"><a class="header-anchor" href="#end" aria-hidden="true">#</a> End</h2><p>OK，感谢看到这里，希望看完之后对你有所提升，</p><!--]--></div><footer class="page-meta"><div class="meta-item edit-link"><a class="nav-link external meta-item-label" href="https://github.com/lei4519/blog/edit/master/src/technology/Web/dva-type.md" rel="noopener noreferrer" target="_blank" aria-label="在 GitHub 上编辑此页"><!--[--><!--]--> 在 GitHub 上编辑此页 <span><svg class="icon outbound" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><!--[--><span class="sr-only">open in new window</span><!--]--></span><!--[--><!--]--></a></div><div class="meta-item last-updated"><span class="meta-item-label">最近更新时间: </span><span class="meta-item-info">2021/6/8 15:33:19</span></div><!----></footer><nav class="page-nav"><p class="inner"><span class="prev"> ← <a href="/blog/technology/Web/stream-save.html" class="nav-link" aria-label="JS 实现流式打包下载"><!--[--><!--]--> JS 实现流式打包下载 <!--[--><!--]--></a></span><span class="next"><a href="/blog/technology/Web/rxjs-operate.html" class="nav-link" aria-label="Rxjs 操作符快速入门"><!--[--><!--]--> Rxjs 操作符快速入门 <!--[--><!--]--></a> → </span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script src="/blog/assets/js/runtime~app.2e4dfdc6.js" defer></script><script src="/blog/assets/js/812.1515477b.js" defer></script><script src="/blog/assets/js/app.b3de0ea5.js" defer></script>
  </body>
</html>
